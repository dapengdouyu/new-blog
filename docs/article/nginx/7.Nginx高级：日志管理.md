---
title: Nginx高级：日志管理
date: 2026-01-12
description: 学习如何配置和管理Nginx日志，包括访问日志、错误日志的分析和轮转
---

# Nginx高级：日志管理

## 一、Nginx日志类型

### 1.1 访问日志（Access Log）

记录所有客户端请求的详细信息，包括：
- 客户端IP地址
- 请求时间
- 请求方法、URL、协议
- 响应状态码
- 响应大小
- 用户代理
- 引用页面

### 1.2 错误日志（Error Log）

记录Nginx运行过程中的错误和警告信息，包括：
- 配置错误
- 文件未找到
- 连接错误
- SSL错误
- 上游服务器错误

## 二、访问日志配置

### 2.1 基本配置

```nginx
http {
    # 定义日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    # 设置访问日志
    access_log /var/log/nginx/access.log main;
}
```

### 2.2 自定义日志格式

```nginx
http {
    # 详细日志格式
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       '$request_time $upstream_response_time '
                       '$upstream_addr';
    
    # JSON格式日志
    log_format json escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent"'
    '}';
    
    # 使用自定义格式
    access_log /var/log/nginx/access.log detailed;
}
```

### 2.3 常用日志变量

```nginx
# 客户端信息
$remote_addr          # 客户端IP地址
$remote_user          # 认证用户名
$time_local           # 本地时间
$time_iso8601         # ISO8601格式时间

# 请求信息
$request              # 完整请求行
$request_method       # 请求方法（GET、POST等）
$request_uri          # 请求URI
$query_string         # 查询参数
$args                 # 查询参数（同$query_string）

# 响应信息
$status               # 响应状态码
$body_bytes_sent      # 响应体大小
$bytes_sent           # 总发送字节数

# HTTP头
$http_referer         # 引用页面
$http_user_agent      # 用户代理
$http_x_forwarded_for # 代理IP链

# 性能指标
$request_time         # 请求处理时间
$upstream_response_time # 上游响应时间
$upstream_addr        # 上游服务器地址
```

### 2.4 条件日志记录

```nginx
# 记录特定状态码
map $status $loggable {
    ~^[23]  0;  # 2xx和3xx不记录
    default 1;
}

access_log /var/log/nginx/access.log main if=$loggable;

# 排除特定路径
map $request_uri $not_static {
    ~* \.(jpg|jpeg|png|gif|ico|css|js)$ 0;
    default 1;
}

access_log /var/log/nginx/access.log main if=$not_static;
```

### 2.5 禁用访问日志

```nginx
# 全局禁用
access_log off;

# 特定server禁用
server {
    access_log off;
    # ...
}

# 特定location禁用
location /static {
    access_log off;
    # ...
}
```

## 三、错误日志配置

### 3.1 基本配置

```nginx
# 全局错误日志
error_log /var/log/nginx/error.log;

# 指定日志级别
error_log /var/log/nginx/error.log warn;
```

### 3.2 日志级别

```nginx
# 日志级别（从低到高）
error_log /var/log/nginx/error.log debug;    # 调试信息
error_log /var/log/nginx/error.log info;     # 一般信息
error_log /var/log/nginx/error.log notice;    # 通知
error_log /var/log/nginx/error.log warn;     # 警告（推荐）
error_log /var/log/nginx/error.log error;    # 错误
error_log /var/log/nginx/error.log crit;     # 严重错误
error_log /var/log/nginx/error.log alert;    # 警报
error_log /var/log/nginx/error.log emerg;    # 紧急
```

### 3.3 不同级别的错误日志

```nginx
# 主错误日志（警告级别）
error_log /var/log/nginx/error.log warn;

# 特定server的错误日志
server {
    error_log /var/log/nginx/example.com.error.log error;
    # ...
}

# 调试特定location
location /api {
    error_log /var/log/nginx/api.debug.log debug;
    # ...
}
```

### 3.4 错误日志到syslog

```nginx
# 发送错误日志到syslog
error_log syslog:server=127.0.0.1:514 debug;
```

## 四、日志轮转

### 4.1 使用logrotate

创建logrotate配置：

```bash
sudo nano /etc/logrotate.d/nginx
```

```bash
/var/log/nginx/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    prerotate
        if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
            run-parts /etc/logrotate.d/httpd-prerotate; \
        fi
    endscript
    postrotate
        invoke-rc.d nginx rotate >/dev/null 2>&1
    endscript
}
```

### 4.2 logrotate配置说明

- **daily**: 每天轮转
- **missingok**: 日志文件不存在也不报错
- **rotate 52**: 保留52个旧日志文件
- **compress**: 压缩旧日志
- **delaycompress**: 延迟压缩（压缩前一个日志）
- **notifempty**: 空文件不轮转
- **create**: 创建新日志文件的权限
- **sharedscripts**: 共享脚本
- **postrotate**: 轮转后执行的命令

### 4.3 手动执行日志轮转

```bash
# 测试logrotate配置
sudo logrotate -d /etc/logrotate.d/nginx

# 强制执行日志轮转
sudo logrotate -f /etc/logrotate.d/nginx

# 查看logrotate状态
sudo logrotate -v /etc/logrotate.d/nginx
```

### 4.4 使用Nginx内置日志轮转

```nginx
# 使用open_log_file_cache（需要重新编译Nginx）
# 或使用外部脚本
```

## 五、日志分析

### 5.1 使用awk分析日志

```bash
# 统计访问最多的IP
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -10

# 统计状态码
awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -rn

# 统计访问最多的URL
awk '{print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -10

# 统计访问时间分布
awk '{print $4}' /var/log/nginx/access.log | cut -d: -f1 | uniq -c
```

### 5.2 使用grep过滤日志

```bash
# 查找特定IP的访问
grep "192.168.1.100" /var/log/nginx/access.log

# 查找错误状态码
grep " 404 " /var/log/nginx/access.log

# 查找特定时间段的日志
grep "12/Jan/2024:10:" /var/log/nginx/access.log

# 查找特定URL
grep "/api/users" /var/log/nginx/access.log
```

### 5.3 实时监控日志

```bash
# 实时查看访问日志
tail -f /var/log/nginx/access.log

# 实时查看错误日志
tail -f /var/log/nginx/error.log

# 实时查看并过滤
tail -f /var/log/nginx/access.log | grep "404"

# 实时查看并高亮
tail -f /var/log/nginx/access.log | grep --color=always -E "404|500|200"
```

### 5.4 使用goaccess分析

```bash
# 安装goaccess
sudo apt install goaccess  # Ubuntu/Debian
sudo yum install goaccess   # CentOS/RHEL

# 分析访问日志
goaccess /var/log/nginx/access.log

# 生成HTML报告
goaccess /var/log/nginx/access.log -o report.html --log-format=COMBINED

# 实时分析
tail -f /var/log/nginx/access.log | goaccess --log-format=COMBINED -
```

## 六、日志格式最佳实践

### 6.1 生产环境日志格式

```nginx
http {
    # 标准组合格式（适合大多数情况）
    log_format combined '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent"';
    
    # 扩展格式（包含性能指标）
    log_format extended '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       '$request_time $upstream_response_time '
                       '$upstream_addr "$http_x_forwarded_for"';
    
    # JSON格式（便于日志分析工具处理）
    log_format json escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for"'
    '}';
    
    # 使用扩展格式
    access_log /var/log/nginx/access.log extended;
}
```

### 6.2 分离不同站点的日志

```nginx
# 站点1
server {
    server_name example.com;
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log;
    # ...
}

# 站点2
server {
    server_name test.com;
    access_log /var/log/nginx/test.com.access.log;
    error_log /var/log/nginx/test.com.error.log;
    # ...
}
```

### 6.3 分离静态资源和动态请求日志

```nginx
server {
    server_name example.com;
    
    # 动态请求日志
    access_log /var/log/nginx/example.com.access.log;
    
    # 静态资源不记录（或记录到单独文件）
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        access_log off;
        # 或
        # access_log /var/log/nginx/static.access.log;
    }
}
```

## 七、日志分析工具

### 7.1 AWStats

```bash
# 安装AWStats
sudo apt install awstats  # Ubuntu/Debian

# 配置AWStats
sudo nano /etc/awstats/awstats.example.com.conf
```

### 7.2 ELK Stack（Elasticsearch, Logstash, Kibana）

用于大规模日志分析和可视化。

### 7.3 Grafana + Loki

现代化的日志聚合和分析平台。

### 7.4 自定义脚本分析

```bash
#!/bin/bash
# analyze_nginx_logs.sh

LOG_FILE="/var/log/nginx/access.log"

echo "=== Top 10 IPs ==="
awk '{print $1}' $LOG_FILE | sort | uniq -c | sort -rn | head -10

echo -e "\n=== Status Codes ==="
awk '{print $9}' $LOG_FILE | sort | uniq -c | sort -rn

echo -e "\n=== Top 10 URLs ==="
awk '{print $7}' $LOG_FILE | sort | uniq -c | sort -rn | head -10

echo -e "\n=== Requests per Hour ==="
awk '{print $4}' $LOG_FILE | cut -d: -f1,2 | uniq -c
```

## 八、日志安全和隐私

### 8.1 日志文件权限

```bash
# 设置日志文件权限
sudo chmod 640 /var/log/nginx/*.log
sudo chown www-data:adm /var/log/nginx/*.log
```

### 8.2 敏感信息处理

```nginx
# 不记录查询参数中的敏感信息
map $args $log_args {
    ~*password  "";  # 移除包含password的参数
    default     $args;
}

log_format safe '$remote_addr - $remote_user [$time_local] '
                '"$request_method $request_uri" $status '
                '$body_bytes_sent "$http_referer" '
                '"$http_user_agent"';
```

### 8.3 日志保留策略

```bash
# logrotate配置中设置保留天数
/var/log/nginx/*.log {
    daily
    rotate 30  # 保留30天
    compress
    # ...
}
```

## 九、性能考虑

### 9.1 异步日志写入

```nginx
# 使用缓冲写入（Nginx Plus功能）
# 或使用syslog
access_log syslog:server=127.0.0.1:514,facility=local7,tag=nginx,severity=info;
```

### 9.2 减少日志I/O

```nginx
# 排除静态资源
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    access_log off;
}

# 排除健康检查
location /health {
    access_log off;
}
```

## 十、下一步学习

完成本课后，你应该能够：

- ✅ 配置访问日志和错误日志
- ✅ 自定义日志格式
- ✅ 配置日志轮转
- ✅ 分析日志数据
- ✅ 使用日志分析工具

接下来可以学习：

1. **第8课：性能优化** - 学习如何优化Nginx性能
2. **第9课：安全配置** - 学习如何配置Nginx安全策略

## 十一、总结

- 访问日志记录所有客户端请求
- 错误日志记录Nginx运行错误
- 使用logrotate进行日志轮转
- 自定义日志格式便于分析
- 合理配置日志级别和保留策略
- 注意日志安全和隐私保护

掌握日志管理后，你就可以更好地监控和调试Nginx了！
