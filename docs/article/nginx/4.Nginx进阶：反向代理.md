---
title: Nginx进阶：反向代理
date: 2026-01-12
description: 学习Nginx反向代理配置，实现负载均衡和请求转发
---

# Nginx进阶：反向代理

## 一、什么是反向代理

### 1.1 正向代理 vs 反向代理

**正向代理（Forward Proxy）**：
- 代理客户端
- 客户端知道代理服务器的存在
- 用于访问被限制的资源（如科学上网）

**反向代理（Reverse Proxy）**：
- 代理服务器端
- 客户端不知道后端服务器的存在
- 用于负载均衡、隐藏服务器、SSL终端等

### 1.2 反向代理的优势

1. **负载均衡**：将请求分发到多个后端服务器
2. **隐藏后端**：客户端不知道真实的后端服务器
3. **SSL终端**：在Nginx处理HTTPS，减轻后端压力
4. **缓存**：可以缓存后端响应
5. **安全**：作为防火墙，保护后端服务器

### 1.3 反向代理的应用场景

- 前后端分离项目
- 微服务架构
- 负载均衡
- API网关
- 静态资源CDN

## 二、基本反向代理配置

### 2.1 proxy_pass指令

```nginx
server {
    listen 80;
    server_name example.com;
    
    location / {
        # 反向代理到后端服务器
        proxy_pass http://127.0.0.1:3000;
    }
}
```

### 2.2 完整的反向代理配置

```nginx
server {
    listen 80;
    server_name example.com;
    
    location / {
        # 后端服务器地址
        proxy_pass http://127.0.0.1:3000;
        
        # 请求头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
}
```

## 三、代理请求头配置

### 3.1 常用请求头

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 传递原始Host头
    proxy_set_header Host $host;
    
    # 传递客户端真实IP
    proxy_set_header X-Real-IP $remote_addr;
    
    # 传递代理链中的IP
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # 传递原始协议（http/https）
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 传递原始请求URI
    proxy_set_header X-Original-URI $request_uri;
}
```

### 3.2 请求头说明

- **Host**: 原始请求的Host头
- **X-Real-IP**: 客户端真实IP地址
- **X-Forwarded-For**: 代理链中的所有IP地址
- **X-Forwarded-Proto**: 原始请求的协议（http/https）
- **X-Forwarded-Host**: 原始请求的Host

### 3.3 清除请求头

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 清除某个请求头
    proxy_set_header X-Custom-Header "";
}
```

## 四、负载均衡

### 4.1 upstream配置

```nginx
# 定义上游服务器组
upstream backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://backend;
    }
}
```

### 4.2 负载均衡算法

#### 轮询（Round Robin，默认）

```nginx
upstream backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}
```

#### 加权轮询（Weighted Round Robin）

```nginx
upstream backend {
    server 127.0.0.1:3000 weight=3;  # 权重3
    server 127.0.0.1:3001 weight=2;  # 权重2
    server 127.0.0.1:3002 weight=1;  # 权重1
}
```

#### IP哈希（IP Hash）

```nginx
upstream backend {
    ip_hash;  # 基于客户端IP的哈希
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}
```

#### 最少连接（Least Connections）

```nginx
upstream backend {
    least_conn;  # 选择连接数最少的服务器
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}
```

### 4.3 服务器状态

```nginx
upstream backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001 backup;      # 备份服务器
    server 127.0.0.1:3002 down;       # 暂时不可用
    server 127.0.0.1:3003 max_fails=3 fail_timeout=30s;  # 失败3次后暂停30秒
}
```

### 4.4 健康检查（需要第三方模块）

```nginx
upstream backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    
    # 需要nginx_upstream_check_module模块
    check interval=3000 rise=2 fall=3 timeout=1000;
}
```

## 五、代理缓冲和超时

### 5.1 缓冲配置

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 启用缓冲
    proxy_buffering on;
    
    # 缓冲区大小
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    # 临时文件
    proxy_temp_file_write_size 16k;
    proxy_max_temp_file_size 0;  # 0表示禁用临时文件
}
```

### 5.2 超时配置

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 连接超时
    proxy_connect_timeout 60s;
    
    # 发送超时
    proxy_send_timeout 60s;
    
    # 读取超时
    proxy_read_timeout 60s;
}
```

### 5.3 禁用缓冲

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 禁用缓冲（适用于实时流、SSE等）
    proxy_buffering off;
    proxy_cache off;
}
```

## 六、WebSocket代理

### 6.1 WebSocket配置

```nginx
location /ws {
    proxy_pass http://127.0.0.1:3000;
    
    # WebSocket必需的头
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # 其他请求头
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # WebSocket超时设置
    proxy_read_timeout 86400;  # 24小时
}
```

### 6.2 WebSocket负载均衡

```nginx
upstream websocket_backend {
    ip_hash;  # WebSocket需要保持连接，使用ip_hash
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
}

server {
    location /ws {
        proxy_pass http://websocket_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## 七、实际应用场景

### 7.1 前后端分离项目

```nginx
server {
    listen 80;
    server_name example.com;
    root /var/www/frontend;
    
    # 前端静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # WebSocket代理
    location /ws {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 7.2 Node.js应用代理

```nginx
upstream nodejs_backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
}

server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://nodejs_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 7.3 Python应用代理（uWSGI/FastCGI）

```nginx
upstream python_backend {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001;
}

server {
    listen 80;
    server_name app.example.com;
    
    location / {
        proxy_pass http://python_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 7.4 微服务API网关

```nginx
# 用户服务
upstream user_service {
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

# 订单服务
upstream order_service {
    server 127.0.0.1:4001;
    server 127.0.0.1:4002;
}

server {
    listen 80;
    server_name api.example.com;
    
    # 用户服务
    location /api/users {
        proxy_pass http://user_service;
        proxy_set_header Host $host;
    }
    
    # 订单服务
    location /api/orders {
        proxy_pass http://order_service;
        proxy_set_header Host $host;
    }
}
```

## 八、代理重定向处理

### 8.1 处理后端重定向

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 处理重定向
    proxy_redirect off;
    # 或
    proxy_redirect http://127.0.0.1:3000/ http://example.com/;
}
```

### 8.2 重写Location头

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 重写Location头中的域名
    proxy_redirect http://127.0.0.1:3000/ http://example.com/;
    proxy_redirect http://backend.internal/ http://example.com/;
}
```

## 九、错误处理

### 9.1 代理错误页面

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 错误处理
    proxy_intercept_errors on;
    error_page 502 503 504 /50x.html;
}

location = /50x.html {
    root /var/www/html;
}
```

### 9.2 后端服务器故障处理

```nginx
upstream backend {
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:3001 backup;  # 备份服务器
}

server {
    location / {
        proxy_pass http://backend;
        proxy_next_upstream error timeout http_502 http_503;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 10s;
    }
}
```

## 十、性能优化

### 10.1 连接复用

```nginx
upstream backend {
    server 127.0.0.1:3000;
    keepalive 32;  # 保持32个连接
}

server {
    location / {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
```

### 10.2 压缩响应

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    
    # 启用压缩
    gzip on;
    gzip_proxied any;
    gzip_types text/plain text/css application/json;
}
```

## 十一、下一步学习

完成本课后，你应该能够：

- ✅ 理解反向代理的概念和优势
- ✅ 配置基本的反向代理
- ✅ 配置负载均衡（轮询、加权、IP哈希等）
- ✅ 配置WebSocket代理
- ✅ 处理代理请求头和响应
- ✅ 优化代理性能

接下来可以学习：

1. **第5课：静态资源服务** - 学习如何优化静态文件服务
2. **第6课：SSL/TLS配置** - 学习如何配置HTTPS

## 十二、总结

- 反向代理用于代理服务器端，隐藏后端服务器
- 使用proxy_pass指令配置反向代理
- upstream块用于定义后端服务器组和负载均衡
- 负载均衡算法包括：轮询、加权轮询、IP哈希、最少连接
- WebSocket代理需要特殊的请求头配置
- 合理配置缓冲和超时可以提高性能

掌握反向代理配置后，你就可以构建高可用的Web应用架构了！
