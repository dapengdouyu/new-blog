---
title: WebAssembly进阶：DOM操作
date: 2026-01-15
description: 学习使用Go操作DOM元素，处理用户事件，构建交互式Web界面
---

# WebAssembly进阶：DOM操作

使用Go WebAssembly操作DOM元素，可以构建完全由Go代码驱动的交互式Web应用。本课将深入学习DOM操作和事件处理。

## 一、DOM基础操作

### 1.1 获取DOM元素

```go
package main

import (
    "syscall/js"
)

func main() {
    doc := js.Global().Get("document")
    
    // 通过ID获取元素
    elementById := doc.Call("getElementById", "myId")
    
    // 通过类名获取元素（返回NodeList）
    elementsByClass := doc.Call("getElementsByClassName", "myClass")
    
    // 通过标签名获取元素
    elementsByTag := doc.Call("getElementsByTagName", "div")
    
    // 使用querySelector
    element := doc.Call("querySelector", "#myId")
    
    // 使用querySelectorAll
    allElements := doc.Call("querySelectorAll", ".myClass")
    
    select {}
}
```

### 1.2 创建和添加元素

```go
func createAndAppend() {
    doc := js.Global().Get("document")
    body := doc.Call("getElementsByTagName", "body").Index(0)
    
    // 创建div元素
    div := doc.Call("createElement", "div")
    div.Set("id", "myDiv")
    div.Set("innerHTML", "这是Go创建的元素")
    
    // 设置样式
    div.Set("style", "padding: 20px; background: #f0f0f0;")
    
    // 添加到body
    body.Call("appendChild", div)
}
```

### 1.3 修改元素内容

```go
func modifyContent() {
    doc := js.Global().Get("document")
    
    // 修改innerHTML
    element := doc.Call("getElementById", "content")
    element.Set("innerHTML", "<h1>新内容</h1>")
    
    // 修改textContent
    element.Set("textContent", "纯文本内容")
    
    // 修改属性
    element.Set("className", "new-class")
    element.Set("id", "new-id")
}
```

### 1.4 删除元素

```go
func removeElement() {
    doc := js.Global().Get("document")
    element := doc.Call("getElementById", "toRemove")
    
    // 获取父元素
    parent := element.Get("parentNode")
    
    // 删除元素
    parent.Call("removeChild", element)
}
```

## 二、样式操作

### 2.1 设置样式

```go
func setStyles() {
    doc := js.Global().Get("document")
    element := doc.Call("getElementById", "myElement")
    
    // 方式一：直接设置style属性
    element.Set("style", "color: red; font-size: 20px;")
    
    // 方式二：通过style对象设置
    style := element.Get("style")
    style.Set("backgroundColor", "blue")
    style.Set("padding", "10px")
    style.Set("margin", "20px")
    style.Set("border", "1px solid black")
}
```

### 2.2 切换类名

```go
func toggleClass() {
    doc := js.Global().Get("document")
    element := doc.Call("getElementById", "myElement")
    classList := element.Get("classList")
    
    // 添加类
    classList.Call("add", "active")
    classList.Call("add", "highlight")
    
    // 删除类
    classList.Call("remove", "inactive")
    
    // 切换类
    classList.Call("toggle", "active")
    
    // 检查是否包含类
    hasClass := classList.Call("contains", "active").Bool()
    js.Global().Get("console").Call("log", "包含active类:", hasClass)
}
```

### 2.3 动态样式

```go
func dynamicStyles() {
    doc := js.Global().Get("document")
    element := doc.Call("getElementById", "myElement")
    style := element.Get("style")
    
    // 根据条件设置样式
    isActive := true
    if isActive {
        style.Set("backgroundColor", "green")
        style.Set("color", "white")
    } else {
        style.Set("backgroundColor", "gray")
        style.Set("color", "black")
    }
    
    // 动画效果
    style.Set("transition", "all 0.3s ease")
    style.Set("transform", "scale(1.1)")
}
```

## 三、事件处理

### 3.1 添加事件监听器

```go
func addEventListener() {
    doc := js.Global().Get("document")
    button := doc.Call("getElementById", "myButton")
    
    // 创建事件处理函数
    clickHandler := js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        js.Global().Get("alert").Invoke("按钮被点击了！")
        return nil
    })
    
    // 添加点击事件
    button.Call("addEventListener", "click", clickHandler)
    
    // 注意：需要保存handler的引用，否则会被GC回收
    // 在实际应用中，应该将handler保存到全局变量或结构体中
}
```

### 3.2 处理多种事件

```go
func handleMultipleEvents() {
    doc := js.Global().Get("document")
    element := doc.Call("getElementById", "myElement")
    
    // 鼠标事件
    element.Call("addEventListener", "mouseenter", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        this.Get("style").Set("backgroundColor", "yellow")
        return nil
    }))
    
    element.Call("addEventListener", "mouseleave", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        this.Get("style").Set("backgroundColor", "white")
        return nil
    }))
    
    // 键盘事件
    doc.Call("addEventListener", "keydown", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        event := args[0]
        key := event.Get("key").String()
        js.Global().Get("console").Call("log", "按下键:", key)
        return nil
    }))
}
```

### 3.3 事件对象

```go
func handleEventObject() {
    doc := js.Global().Get("document")
    button := doc.Call("getElementById", "myButton")
    
    button.Call("addEventListener", "click", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        event := args[0]
        
        // 获取事件属性
        eventType := event.Get("type").String()
        target := event.Get("target")
        clientX := event.Get("clientX").Int()
        clientY := event.Get("clientY").Int()
        
        // 阻止默认行为
        event.Call("preventDefault")
        
        // 停止事件传播
        event.Call("stopPropagation")
        
        js.Global().Get("console").Call("log", "事件类型:", eventType)
        js.Global().Get("console").Call("log", "鼠标位置:", clientX, clientY)
        
        return nil
    }))
}
```

### 3.4 移除事件监听器

```go
var clickHandler js.Func

func setupAndRemove() {
    doc := js.Global().Get("document")
    button := doc.Call("getElementById", "myButton")
    
    // 创建并保存handler
    clickHandler = js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        js.Global().Get("console").Call("log", "点击")
        return nil
    })
    
    // 添加事件
    button.Call("addEventListener", "click", clickHandler)
    
    // 稍后移除事件
    // button.Call("removeEventListener", "click", clickHandler)
}
```

## 四、表单处理

### 4.1 获取表单值

```go
func getFormValues() {
    doc := js.Global().Get("document")
    
    // 获取input值
    input := doc.Call("getElementById", "username")
    username := input.Get("value").String()
    
    // 获取select值
    selectEl := doc.Call("getElementById", "country")
    country := selectEl.Get("value").String()
    
    // 获取checkbox状态
    checkbox := doc.Call("getElementById", "agree")
    isChecked := checkbox.Get("checked").Bool()
    
    // 获取radio值
    radios := doc.Call("querySelectorAll", "input[type='radio']:checked")
    if radios.Length() > 0 {
        radioValue := radios.Index(0).Get("value").String()
        js.Global().Get("console").Call("log", "选择的radio:", radioValue)
    }
    
    js.Global().Get("console").Call("log", "用户名:", username)
    js.Global().Get("console").Call("log", "国家:", country)
    js.Global().Get("console").Call("log", "同意:", isChecked)
}
```

### 4.2 设置表单值

```go
func setFormValues() {
    doc := js.Global().Get("document")
    
    // 设置input值
    input := doc.Call("getElementById", "username")
    input.Set("value", "新用户名")
    
    // 设置select值
    selectEl := doc.Call("getElementById", "country")
    selectEl.Set("value", "CN")
    
    // 设置checkbox
    checkbox := doc.Call("getElementById", "agree")
    checkbox.Set("checked", true)
    
    // 设置radio
    radio := doc.Call("querySelector", "input[type='radio'][value='option1']")
    radio.Set("checked", true)
}
```

### 4.3 表单验证

```go
func validateForm(this js.Value, args []js.Value) interface{} {
    doc := js.Global().Get("document")
    
    // 获取表单元素
    username := doc.Call("getElementById", "username").Get("value").String()
    email := doc.Call("getElementById", "email").Get("value").String()
    password := doc.Call("getElementById", "password").Get("value").String()
    
    // 验证用户名
    if len(username) < 3 {
        showError("用户名至少需要3个字符")
        return js.ValueOf(false)
    }
    
    // 验证邮箱（简单验证）
    if !contains(email, "@") {
        showError("邮箱格式不正确")
        return js.ValueOf(false)
    }
    
    // 验证密码
    if len(password) < 6 {
        showError("密码至少需要6个字符")
        return js.ValueOf(false)
    }
    
    // 清除错误信息
    clearError()
    return js.ValueOf(true)
}

func showError(message string) {
    doc := js.Global().Get("document")
    errorDiv := doc.Call("getElementById", "error")
    if errorDiv.Truthy() {
        errorDiv.Set("innerHTML", message)
        errorDiv.Get("style").Set("color", "red")
        errorDiv.Get("style").Set("display", "block")
    }
}

func clearError() {
    doc := js.Global().Get("document")
    errorDiv := doc.Call("getElementById", "error")
    if errorDiv.Truthy() {
        errorDiv.Set("innerHTML", "")
        errorDiv.Get("style").Set("display", "none")
    }
}

func contains(s, substr string) bool {
    return len(s) >= len(substr) && (s == substr || len(s) > len(substr) && 
        (s[:len(substr)] == substr || contains(s[1:], substr)))
}
```

### 4.4 表单提交

```go
func setupFormSubmit() {
    doc := js.Global().Get("document")
    form := doc.Call("getElementById", "myForm")
    
    form.Call("addEventListener", "submit", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        event := args[0]
        
        // 验证表单
        if !validateForm(js.Value{}, []js.Value{}) {
            event.Call("preventDefault")
            return nil
        }
        
        // 获取表单数据
        formData := js.Global().Get("FormData").New(form)
        
        // 可以发送到服务器或处理数据
        js.Global().Get("console").Call("log", "表单提交")
        
        return nil
    }))
}
```

## 五、动态内容更新

### 5.1 列表渲染

```go
type Item struct {
    ID    int
    Name  string
    Price float64
}

func renderList(items []Item) {
    doc := js.Global().Get("document")
    container := doc.Call("getElementById", "listContainer")
    
    // 清空容器
    container.Set("innerHTML", "")
    
    // 创建列表
    ul := doc.Call("createElement", "ul")
    
    for _, item := range items {
        // 创建列表项
        li := doc.Call("createElement", "li")
        li.Set("innerHTML", fmt.Sprintf("%s - $%.2f", item.Name, item.Price))
        li.Set("style", "padding: 10px; border-bottom: 1px solid #ccc;")
        
        ul.Call("appendChild", li)
    }
    
    container.Call("appendChild", ul)
}
```

### 5.2 计数器示例

```go
var count int = 0

func setupCounter() {
    doc := js.Global().Get("document")
    
    // 创建计数器显示
    counterDiv := doc.Call("createElement", "div")
    counterDiv.Set("id", "counter")
    counterDiv.Set("innerHTML", fmt.Sprintf("计数: %d", count))
    counterDiv.Set("style", "font-size: 24px; margin: 20px;")
    
    // 创建增加按钮
    incBtn := doc.Call("createElement", "button")
    incBtn.Set("innerHTML", "增加")
    incBtn.Call("addEventListener", "click", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        count++
        updateCounter()
        return nil
    }))
    
    // 创建减少按钮
    decBtn := doc.Call("createElement", "button")
    decBtn.Set("innerHTML", "减少")
    decBtn.Call("addEventListener", "click", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        count--
        updateCounter()
        return nil
    }))
    
    // 创建重置按钮
    resetBtn := doc.Call("createElement", "button")
    resetBtn.Set("innerHTML", "重置")
    resetBtn.Call("addEventListener", "click", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        count = 0
        updateCounter()
        return nil
    }))
    
    // 添加到页面
    body := doc.Call("getElementsByTagName", "body").Index(0)
    body.Call("appendChild", counterDiv)
    body.Call("appendChild", incBtn)
    body.Call("appendChild", decBtn)
    body.Call("appendChild", resetBtn)
}

func updateCounter() {
    doc := js.Global().Get("document")
    counterDiv := doc.Call("getElementById", "counter")
    counterDiv.Set("innerHTML", fmt.Sprintf("计数: %d", count))
}
```

## 六、动画效果

### 6.1 CSS动画

```go
func addAnimation() {
    doc := js.Global().Get("document")
    element := doc.Call("getElementById", "animated")
    style := element.Get("style")
    
    // 设置动画属性
    style.Set("transition", "all 0.3s ease")
    style.Set("transform", "translateX(100px)")
    
    // 延迟后恢复
    go func() {
        time.Sleep(300 * time.Millisecond)
        style.Set("transform", "translateX(0)")
    }()
}
```

### 6.2 淡入淡出

```go
func fadeIn(element js.Value) {
    style := element.Get("style")
    style.Set("opacity", "0")
    style.Set("transition", "opacity 0.5s")
    
    // 使用requestAnimationFrame实现淡入
    var fade func(float64)
    fade = func(opacity float64) {
        if opacity < 1.0 {
            style.Set("opacity", fmt.Sprintf("%.2f", opacity))
            js.Global().Call("requestAnimationFrame", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
                fade(opacity + 0.05)
                return nil
            }))
        }
    }
    fade(0)
}
```

## 七、完整示例：待办事项应用

### 7.1 Go代码

```go
package main

import (
    "fmt"
    "syscall/js"
)

type Todo struct {
    ID    int
    Text  string
    Done  bool
}

var todos []Todo
var nextID int = 1

func addTodo(this js.Value, args []js.Value) interface{} {
    if len(args) < 1 {
        return nil
    }
    
    text := args[0].String()
    if len(text) == 0 {
        return nil
    }
    
    todo := Todo{
        ID:   nextID,
        Text: text,
        Done: false,
    }
    nextID++
    
    todos = append(todos, todo)
    renderTodos()
    
    return nil
}

func toggleTodo(this js.Value, args []js.Value) interface{} {
    if len(args) < 1 {
        return nil
    }
    
    id := args[0].Int()
    for i := range todos {
        if todos[i].ID == id {
            todos[i].Done = !todos[i].Done
            break
        }
    }
    
    renderTodos()
    return nil
}

func deleteTodo(this js.Value, args []js.Value) interface{} {
    if len(args) < 1 {
        return nil
    }
    
    id := args[0].Int()
    for i, todo := range todos {
        if todo.ID == id {
            todos = append(todos[:i], todos[i+1:]...)
            break
        }
    }
    
    renderTodos()
    return nil
}

func renderTodos() {
    doc := js.Global().Get("document")
    container := doc.Call("getElementById", "todoList")
    
    // 清空容器
    container.Set("innerHTML", "")
    
    // 创建列表
    ul := doc.Call("createElement", "ul")
    ul.Set("style", "list-style: none; padding: 0;")
    
    for _, todo := range todos {
        li := doc.Call("createElement", "li")
        li.Set("style", "padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; display: flex; align-items: center;")
        
        // 复选框
        checkbox := doc.Call("createElement", "input")
        checkbox.Set("type", "checkbox")
        checkbox.Set("checked", todo.Done)
        checkbox.Call("addEventListener", "change", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
            toggleTodo(js.Value{}, []js.Value{js.ValueOf(todo.ID)})
            return nil
        }))
        
        // 文本
        text := doc.Call("createElement", "span")
        text.Set("innerHTML", todo.Text)
        if todo.Done {
            text.Get("style").Set("textDecoration", "line-through")
            text.Get("style").Set("opacity", "0.5")
        }
        text.Get("style").Set("flex", "1")
        text.Get("style").Set("marginLeft", "10px")
        
        // 删除按钮
        deleteBtn := doc.Call("createElement", "button")
        deleteBtn.Set("innerHTML", "删除")
        deleteBtn.Get("style").Set("background", "#ff4444")
        deleteBtn.Get("style").Set("color", "white")
        deleteBtn.Get("style").Set("border", "none")
        deleteBtn.Get("style").Set("padding", "5px 10px")
        deleteBtn.Get("style").Set("borderRadius", "3px")
        deleteBtn.Get("style").Set("cursor", "pointer")
        deleteBtn.Call("addEventListener", "click", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
            deleteTodo(js.Value{}, []js.Value{js.ValueOf(todo.ID)})
            return nil
        }))
        
        li.Call("appendChild", checkbox)
        li.Call("appendChild", text)
        li.Call("appendChild", deleteBtn)
        ul.Call("appendChild", li)
    }
    
    container.Call("appendChild", ul)
}

func setupTodoApp() {
    doc := js.Global().Get("document")
    body := doc.Call("getElementsByTagName", "body").Index(0)
    
    // 创建容器
    container := doc.Call("createElement", "div")
    container.Set("style", "max-width: 500px; margin: 50px auto; padding: 20px;")
    
    // 标题
    title := doc.Call("createElement", "h1")
    title.Set("innerHTML", "Go WebAssembly 待办事项")
    title.Set("style", "text-align: center;")
    
    // 输入框和按钮
    inputDiv := doc.Call("createElement", "div")
    inputDiv.Set("style", "display: flex; margin-bottom: 20px;")
    
    input := doc.Call("createElement", "input")
    input.Set("type", "text")
    input.Set("id", "todoInput")
    input.Set("placeholder", "输入待办事项...")
    input.Get("style").Set("flex", "1")
    input.Get("style").Set("padding", "10px")
    input.Get("style").Set("fontSize", "16px")
    
    addBtn := doc.Call("createElement", "button")
    addBtn.Set("innerHTML", "添加")
    addBtn.Get("style").Set("padding", "10px 20px")
    addBtn.Get("style").Set("marginLeft", "10px")
    addBtn.Get("style").Set("background", "#42b983")
    addBtn.Get("style").Set("color", "white")
    addBtn.Get("style").Set("border", "none")
    addBtn.Get("style").Set("borderRadius", "3px")
    addBtn.Get("style").Set("cursor", "pointer")
    
    addBtn.Call("addEventListener", "click", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        input := doc.Call("getElementById", "todoInput")
        text := input.Get("value").String()
        if len(text) > 0 {
            addTodo(js.Value{}, []js.Value{js.ValueOf(text)})
            input.Set("value", "")
        }
        return nil
    }))
    
    // Enter键添加
    input.Call("addEventListener", "keypress", js.FuncOf(func(this js.Value, args []js.Value) interface{} {
        event := args[0]
        if event.Get("key").String() == "Enter" {
            addBtn.Call("click")
        }
        return nil
    }))
    
    inputDiv.Call("appendChild", input)
    inputDiv.Call("appendChild", addBtn)
    
    // 待办列表容器
    listContainer := doc.Call("createElement", "div")
    listContainer.Set("id", "todoList")
    
    container.Call("appendChild", title)
    container.Call("appendChild", inputDiv)
    container.Call("appendChild", listContainer)
    body.Call("appendChild", container)
}

func main() {
    fmt.Println("待办事项应用启动")
    
    // 导出函数
    js.Global().Set("goAddTodo", js.FuncOf(addTodo))
    js.Global().Set("goToggleTodo", js.FuncOf(toggleTodo))
    js.Global().Set("goDeleteTodo", js.FuncOf(deleteTodo))
    
    // 设置应用
    setupTodoApp()
    
    select {}
}
```

### 7.2 HTML代码

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go WebAssembly 待办事项</title>
</head>
<body>
    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
            .then((result) => {
                go.run(result.instance);
            });
    </script>
</body>
</html>
```

## 八、下一步学习

完成本课后，你应该能够：

- ✅ 使用Go操作DOM元素
- ✅ 处理各种用户事件
- ✅ 创建和修改表单
- ✅ 实现动态内容更新
- ✅ 构建交互式Web界面

接下来可以学习：

1. **第4课：构建Web应用** - 构建完整的Web应用，包括状态管理和路由
2. **第5课：性能优化和最佳实践** - 优化WebAssembly应用性能

## 九、总结

- DOM操作是WebAssembly应用的核心
- 使用`syscall/js`可以完全控制DOM
- 事件处理需要保存handler引用
- 表单处理需要注意类型转换
- 动态内容更新需要合理组织代码结构
- 可以构建完全由Go驱动的Web应用

掌握DOM操作，你就可以构建功能完整的Web应用了！
