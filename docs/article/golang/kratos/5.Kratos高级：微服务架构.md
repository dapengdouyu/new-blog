---
title: 5ã€Kratosé«˜çº§ï¼šå¾®æœåŠ¡æ¶æ„
date: 2026-01-06
description: æ·±å…¥ç†è§£Kratosæ¡†æ¶çš„å¾®æœåŠ¡æ¶æ„å’Œæ²»ç†èƒ½åŠ›
---

# 5ã€Kratosé«˜çº§ï¼šå¾®æœåŠ¡æ¶æ„

æœ¬æ–‡æ¡£æ·±å…¥è®²è§£Kratosæ¡†æ¶çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡å’ŒæœåŠ¡æ²»ç†èƒ½åŠ›ã€‚

## ğŸ¯ æœ¬è¯¾å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬è¯¾åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ç†è§£å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒæ¦‚å¿µ
- âœ… æŒæ¡Kratosçš„æœåŠ¡æ³¨å†Œå’Œå‘ç°
- âœ… å­¦ä¼šæœåŠ¡é—´gRPCé€šä¿¡
- âœ… ç†è§£é…ç½®ä¸­å¿ƒå’Œæ³¨å†Œä¸­å¿ƒ
- âœ… æŒæ¡æœåŠ¡æ²»ç†å’Œç›‘æ§
- âœ… å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

---

## ä¸€ã€å¾®æœåŠ¡æ¶æ„æ¦‚è¿°

### 1.1 å¾®æœåŠ¡ vs å•ä½“æ¶æ„

| ç‰¹æ€§ | å•ä½“æ¶æ„ | å¾®æœåŠ¡æ¶æ„ |
|------|---------|-----------|
| **éƒ¨ç½²** | æ•´ä¸ªåº”ç”¨ä¸€èµ·éƒ¨ç½² | ç‹¬ç«‹éƒ¨ç½²æ¯ä¸ªæœåŠ¡ |
| **æŠ€æœ¯æ ˆ** | ç»Ÿä¸€æŠ€æœ¯æ ˆ | æ¯ä¸ªæœåŠ¡å¯é€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯ |
| **æ‰©å±•æ€§** | å‚ç›´æ‰©å±• | æ°´å¹³æ‰©å±•ï¼Œé’ˆå¯¹æ€§æ‰©å±• |
| **å®¹é”™æ€§** | ä¸€ä¸ªæœåŠ¡æ•…éšœå½±å“æ•´ä¸ªåº”ç”¨ | æœåŠ¡é—´éš”ç¦»ï¼Œæ•…éšœå½±å“èŒƒå›´å° |
| **å¼€å‘æ•ˆç‡** | å›¢é˜Ÿåä½œå¤æ‚ | å›¢é˜Ÿç‹¬ç«‹å¼€å‘ï¼ŒèŒè´£æ¸…æ™° |
| **è¿ç»´å¤æ‚åº¦** | ç›¸å¯¹ç®€å• | éœ€è¦æœåŠ¡æ²»ç†ã€ç›‘æ§ç­‰åŸºç¡€è®¾æ–½ |

### 1.2 Kratoså¾®æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                API Gateway                      â”‚
â”‚  â”œâ”€ è·¯ç”±è½¬å‘                                    â”‚
â”‚  â”œâ”€ è´Ÿè½½å‡è¡¡                                    â”‚
â”‚  â”œâ”€ è®¤è¯æˆæƒ                                    â”‚
â”‚  â””â”€ é™æµç†”æ–­                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Service  â”‚ â”‚  Order Service  â”‚ â”‚ Product Service â”‚
â”‚  â”œâ”€ ç”¨æˆ·ç®¡ç†     â”‚ â”‚  â”œâ”€ è®¢å•ç®¡ç†     â”‚ â”‚  â”œâ”€ å•†å“ç®¡ç†     â”‚
â”‚  â”œâ”€ è®¤è¯æˆæƒ     â”‚ â”‚  â”œâ”€ æ”¯ä»˜å¤„ç†     â”‚ â”‚  â”œâ”€ åº“å­˜ç®¡ç†     â”‚
â”‚  â””â”€ ç”¨æˆ·èµ„æ–™     â”‚ â”‚  â””â”€ è®¢å•çŠ¶æ€     â”‚ â”‚  â””â”€ å•†å“æœç´¢     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚               â”‚               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Config Center  â”‚ â”‚ Registry Center â”‚ â”‚   Monitoring    â”‚
â”‚  â”œâ”€ é…ç½®ç®¡ç†     â”‚ â”‚  â”œâ”€ æœåŠ¡æ³¨å†Œ     â”‚ â”‚  â”œâ”€ æŒ‡æ ‡ç›‘æ§     â”‚
â”‚  â”œâ”€ é…ç½®æ¨é€     â”‚ â”‚  â”œâ”€ æœåŠ¡å‘ç°     â”‚ â”‚  â”œâ”€ æ—¥å¿—æ”¶é›†     â”‚
â”‚  â””â”€ é…ç½®çƒ­æ›´æ–°   â”‚ â”‚  â””â”€ å¥åº·æ£€æŸ¥     â”‚ â”‚  â””â”€ é“¾è·¯è¿½è¸ª     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æœåŠ¡æ³¨å†Œå’Œå‘ç°

### 2.1 æœåŠ¡æ³¨å†Œ

```go
// internal/server/server.go
package server

import (
    "github.com/go-kratos/kratos/v2"
    "github.com/go-kratos/kratos/v2/registry"
    "github.com/go-kratos/kratos/v2/registry/etcd"
    "github.com/go-kratos/kratos/v2/registry/consul"
)

func NewServer(c *conf.Server, userSvc v1.UserServiceServer) *kratos.Server {
    // åˆ›å»ºæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯
    var r registry.Registrar

    switch c.Registry.Type {
    case "etcd":
        r = etcd.New(c.Registry.Etcd)
    case "consul":
        r = consul.New(c.Registry.Consul)
    default:
        // é»˜è®¤ä½¿ç”¨å†…å­˜æ³¨å†Œä¸­å¿ƒï¼ˆå¼€å‘ç¯å¢ƒï¼‰
        r = registry.NewInMemory()
    }

    srv := kratos.New(
        kratos.Name(c.Name),
        kratos.Version(c.Version),
        kratos.Metadata(c.Metadata),
        kratos.Registrar(r), // æ³¨å†ŒæœåŠ¡
        kratos.Server(
            NewGRPCServer(c.GRPC, userSvc),
            NewHTTPServer(c.HTTP),
        ),
    )

    return srv
}
```

### 2.2 é…ç½®å®šä¹‰

**internal/conf/registry.go**:

```go
package conf

type Registry struct {
    Type  string    `yaml:"type"`
    Etcd  *EtcdConf `yaml:"etcd,omitempty"`
    Consul *ConsulConf `yaml:"consul,omitempty"`
}

type EtcdConf struct {
    Endpoints []string `yaml:"endpoints"`
    Username  string   `yaml:"username"`
    Password  string   `yaml:"password"`
}

type ConsulConf struct {
    Address string `yaml:"address"`
    Scheme  string `yaml:"scheme"`
    Token   string `yaml:"token"`
}
```

**configs/config.yaml**:

```yaml
server:
  name: user.service
  version: 1.0.0
  metadata:
    region: shanghai
    zone: zone-a

registry:
  type: etcd
  etcd:
    endpoints:
      - "etcd-1:2379"
      - "etcd-2:2379"
      - "etcd-3:2379"
    username: ""
    password: ""

grpc:
  addr: 0.0.0.0:9001

http:
  addr: 0.0.0.0:8001
```

### 2.3 æœåŠ¡å‘ç°å®¢æˆ·ç«¯

```go
// internal/client/client.go
package client

import (
    "github.com/go-kratos/kratos/v2/registry"
    "github.com/go-kratos/kratos/v2/selector"
    "github.com/go-kratos/kratos/v2/selector/wrr"
    "github.com/go-kratos/kratos/v2/transport/grpc"
    v1 "github.com/go-kratos/kratos-layout/api/user/v1"
)

func NewUserClient(r registry.Discovery) v1.UserServiceClient {
    // åˆ›å»ºæœåŠ¡å‘ç°å™¨
    disco := r

    // åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨
    sl := selector.NewSelector(
        selector.Registry(disco),
        selector.Balancer(wrr.Name), // åŠ æƒè½®è¯¢
    )

    conn, err := grpc.DialInsecure(
        context.Background(),
        grpc.WithEndpoint("discovery:///user.service"), // æœåŠ¡å‘ç°ç«¯ç‚¹
        grpc.WithDiscovery(disco),
        grpc.WithSelector(sl),
    )
    if err != nil {
        panic(err)
    }

    return v1.NewUserServiceClient(conn)
}
```

---

## ä¸‰ã€æœåŠ¡é—´gRPCé€šä¿¡

### 3.1 gRPCæœåŠ¡å®šä¹‰

**api/order/v1/order.proto**:

```protobuf
syntax = "proto3";

package api.order.v1;

import "google/api/annotations.proto";
import "api/user/v1/user.proto";

option go_package = "github.com/go-kratos/kratos-layout/api/order/v1;v1";

service OrderService {
  rpc CreateOrder (CreateOrderRequest) returns (CreateOrderReply) {
    option (google.api.http) = {
      post: "/api/v1/orders",
      body: "*"
    };
  }

  rpc GetOrder (GetOrderRequest) returns (GetOrderReply) {
    option (google.api.http) = {
      get: "/api/v1/orders/{id}",
    };
  }

  rpc ListOrders (ListOrdersRequest) returns (ListOrdersReply) {
    option (google.api.http) = {
      get: "/api/v1/orders",
    };
  }
}

message Order {
  string id = 1;
  string user_id = 2;
  api.user.v1.User user = 3;
  repeated OrderItem items = 4;
  string status = 5;
  string total_amount = 6;
  string created_at = 7;
  string updated_at = 8;
}

message OrderItem {
  string product_id = 3;
  string product_name = 4;
  int32 quantity = 5;
  string price = 6;
  string total = 7;
}

message CreateOrderRequest {
  string user_id = 1;
  repeated CreateOrderItem items = 2;
}

message CreateOrderItem {
  string product_id = 1;
  int32 quantity = 2;
}

message CreateOrderReply {
  Order order = 1;
}

message GetOrderRequest {
  string id = 1;
}

message GetOrderReply {
  Order order = 1;
}

message ListOrdersRequest {
  string user_id = 1;
  int32 page = 2;
  int32 page_size = 3;
}

message ListOrdersReply {
  repeated Order orders = 1;
  int32 total = 2;
}
```

### 3.2 gRPCå®¢æˆ·ç«¯è°ƒç”¨

```go
// internal/biz/order_usecase.go
package biz

import (
    "context"
    "github.com/go-kratos/kratos/v2/log"
    v1 "github.com/go-kratos/kratos-layout/api/order/v1"
    userV1 "github.com/go-kratos/kratos-layout/api/user/v1"
)

type OrderUsecase struct {
    orderRepo    OrderRepo
    userClient   userV1.UserServiceClient
    productClient v1.ProductServiceClient
    log          *log.Helper
}

func NewOrderUsecase(
    orderRepo OrderRepo,
    userClient userV1.UserServiceClient,
    productClient v1.ProductServiceClient,
    logger log.Logger,
) *OrderUsecase {
    return &OrderUsecase{
        orderRepo:     orderRepo,
        userClient:    userClient,
        productClient: productClient,
        log:           log.NewHelper(logger),
    }
}

func (uc *OrderUsecase) CreateOrder(ctx context.Context, req *v1.CreateOrderRequest) (*v1.CreateOrderReply, error) {
    // 1. éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    userResp, err := uc.userClient.GetUser(ctx, &userV1.GetUserRequest{
        Id: req.UserId,
    })
    if err != nil {
        uc.log.Errorf("get user failed: %v", err)
        return nil, err
    }

    // 2. éªŒè¯å•†å“å¹¶è®¡ç®—ä»·æ ¼
    var orderItems []*v1.OrderItem
    var totalAmount float64

    for _, item := range req.Items {
        // è°ƒç”¨å•†å“æœåŠ¡è·å–å•†å“ä¿¡æ¯
        productResp, err := uc.productClient.GetProduct(ctx, &v1.GetProductRequest{
            Id: item.ProductId,
        })
        if err != nil {
            return nil, err
        }

        // æ£€æŸ¥åº“å­˜
        if productResp.Product.Stock < item.Quantity {
            return nil, errors.New("insufficient stock")
        }

        price := parseFloat(productResp.Product.Price)
        itemTotal := price * float64(item.Quantity)

        orderItems = append(orderItems, &v1.OrderItem{
            ProductId:   item.ProductId,
            ProductName: productResp.Product.Name,
            Quantity:    item.Quantity,
            Price:       productResp.Product.Price,
            Total:       formatFloat(itemTotal),
        })

        totalAmount += itemTotal
    }

    // 3. åˆ›å»ºè®¢å•
    order := &model.Order{
        UserID:      req.UserId,
        Items:       orderItems,
        Status:      "pending",
        TotalAmount: formatFloat(totalAmount),
    }

    createdOrder, err := uc.orderRepo.Create(ctx, order)
    if err != nil {
        uc.log.Errorf("create order failed: %v", err)
        return nil, err
    }

    // 4. æ›´æ–°å•†å“åº“å­˜
    for _, item := range req.Items {
        _, err := uc.productClient.UpdateStock(ctx, &v1.UpdateStockRequest{
            ProductId: item.ProductId,
            Quantity:  -item.Quantity, // å‡å°‘åº“å­˜
        })
        if err != nil {
            // è¿™é‡Œåº”è¯¥æœ‰è¡¥å¿é€»è¾‘
            uc.log.Errorf("update stock failed: %v", err)
        }
    }

    return &v1.CreateOrderReply{
        Order: &v1.Order{
            Id:          createdOrder.ID,
            UserId:      createdOrder.UserID,
            User:        userResp.User,
            Items:       createdOrder.Items,
            Status:      createdOrder.Status,
            TotalAmount: createdOrder.TotalAmount,
            CreatedAt:   createdOrder.CreatedAt.Format("2006-01-02 15:04:05"),
        },
    }, nil
}
```

### 3.3 æµå¼gRPC

**api/chat/v1/chat.proto**:

```protobuf
syntax = "proto3";

package api.chat.v1;

option go_package = "github.com/go-kratos/kratos-layout/api/chat/v1;v1";

service ChatService {
  rpc SendMessage (stream MessageRequest) returns (stream MessageReply) {}
}

message MessageRequest {
  string content = 1;
  string user_id = 2;
  string room_id = 3;
}

message MessageReply {
  string message_id = 1;
  string content = 2;
  string user_id = 3;
  string room_id = 4;
  string timestamp = 5;
}
```

**internal/service/chat.go**:

```go
package service

import (
    "context"
    "time"
    v1 "github.com/go-kratos/kratos-layout/api/chat/v1"
    "github.com/go-kratos/kratos/v2/log"
)

type ChatService struct {
    v1.UnimplementedChatServiceServer
    log *log.Helper
}

func NewChatService(logger log.Logger) *ChatService {
    return &ChatService{
        log: log.NewHelper(logger),
    }
}

func (s *ChatService) SendMessage(stream v1.ChatService_SendMessageServer) error {
    for {
        req, err := stream.Recv()
        if err != nil {
            return err
        }

        // å¤„ç†æ¶ˆæ¯
        reply := &v1.MessageReply{
            MessageId: generateMessageID(),
            Content:   req.Content,
            UserId:    req.UserId,
            RoomId:    req.RoomId,
            Timestamp: time.Now().Format("2006-01-02 15:04:05"),
        }

        // å‘é€å›å¤
        if err := stream.Send(reply); err != nil {
            return err
        }

        s.log.Infof("message sent: %s -> %s", req.UserId, req.RoomId)
    }
}
```

---

## å››ã€é…ç½®ä¸­å¿ƒ

### 4.1 Apolloé…ç½®ä¸­å¿ƒ

```go
// internal/conf/apollo.go
package conf

import (
    "context"
    "github.com/go-kratos/kratos/v2/config"
    "github.com/go-kratos/kratos/v2/config/apollo"
)

func LoadConfigFromApollo() (*Config, func(), error) {
    c := config.New(
        config.WithSource(
            apollo.NewSource(
                apollo.WithAppID("your-app-id"),
                apollo.WithCluster("default"),
                apollo.WithEndpoint("http://apollo-config-service:8080"),
                apollo.WithNamespace("application", "mysql", "redis"),
                apollo.WithSecret("your-secret"),
            ),
        ),
        config.WithDecoder(codec),
    )

    if err := c.Load(); err != nil {
        return nil, nil, err
    }

    var bc Config
    if err := c.Scan(&bc); err != nil {
        return nil, nil, err
    }

    return &bc, func() { c.Close() }, nil
}
```

### 4.2 Nacosé…ç½®ä¸­å¿ƒ

```go
import "github.com/go-kratos/kratos/contrib/config/nacos/v2"

func LoadConfigFromNacos() (*Config, func(), error) {
    source := nacos.NewConfigSource(
        nacos.WithServerConfig([]constant.ServerConfig{
            {IpAddr: "nacos-server", Port: 8848},
        }),
        nacos.WithClientConfig(
            constant.ClientConfig{
                NamespaceId:         "your-namespace",
                TimeoutMs:           5000,
                NotLoadCacheAtStart: true,
            },
        ),
        nacos.WithDataId("app.yaml"),
        nacos.WithGroup("DEFAULT_GROUP"),
    )

    c := config.New(config.WithSource(source))
    // ... å…¶ä½™ä»£ç åŒä¸Š
}
```

### 4.3 é…ç½®çƒ­æ›´æ–°

```go
// internal/conf/watcher.go
package conf

import (
    "context"
    "github.com/go-kratos/kratos/v2/config"
    "github.com/go-kratos/kratos/v2/log"
)

type ConfigWatcher struct {
    config *Config
    logger *log.Helper
}

func NewConfigWatcher(c *Config, logger log.Logger) *ConfigWatcher {
    return &ConfigWatcher{
        config: c,
        logger: log.NewHelper(logger),
    }
}

func (w *ConfigWatcher) Watch(ctx context.Context, c config.Config) error {
    // ç›‘å¬æ•°æ®åº“é…ç½®å˜åŒ–
    err := c.Watch("data.database", func(key string, value config.Value) {
        w.logger.Infof("database config changed: %s", key)

        // é‡æ–°è§£æé…ç½®
        var dbConf Database
        if err := value.Scan(&dbConf); err != nil {
            w.logger.Errorf("parse database config failed: %v", err)
            return
        }

        // æ›´æ–°é…ç½®
        w.config.Data.Database = &dbConf

        // é‡æ–°åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
        // è¿™é‡Œéœ€è¦å®ç°æ•°æ®åº“é‡è¿é€»è¾‘
    })

    if err != nil {
        return err
    }

    // ç›‘å¬æœåŠ¡å™¨é…ç½®å˜åŒ–
    return c.Watch("server", func(key string, value config.Value) {
        w.logger.Infof("server config changed: %s", key)

        var serverConf Server
        if err := value.Scan(&serverConf); err != nil {
            w.logger.Errorf("parse server config failed: %v", err)
            return
        }

        w.config.Server = &serverConf
    })
}
```

---

## äº”ã€æœåŠ¡æ²»ç†

### 5.1 è´Ÿè½½å‡è¡¡

```go
// internal/client/loadbalance.go
package client

import (
    "github.com/go-kratos/kratos/v2/selector"
    "github.com/go-kratos/kratos/v2/selector/random"
    "github.com/go-kratos/kratos/v2/selector/roundrobin"
    "github.com/go-kratos/kratos/v2/selector/wrr"
)

func NewLoadBalancer(strategy string) selector.Balancer {
    switch strategy {
    case "random":
        return random.Name
    case "roundrobin":
        return roundrobin.Name
    case "wrr":
        return wrr.Name
    default:
        return roundrobin.Name
    }
}
```

### 5.2 ç†”æ–­å™¨

```go
// internal/middleware/circuitbreaker.go
package middleware

import (
    "github.com/go-kratos/kratos/v2/middleware/circuitbreaker"
    "github.com/go-kratos/kratos/v2/transport/grpc"
    "github.com/go-kratos/kratos/v2/transport/http"
)

func CircuitBreaker() http.ServerOption {
    return http.Middleware(
        circuitbreaker.Client(
            circuitbreaker.WithCommandName("user.service"),
            circuitbreaker.WithTimeout(5*time.Second),
            circuitbreaker.WithMaxRequests(10),
            circuitbreaker.WithInterval(60*time.Second),
            circuitbreaker.WithFailureRatio(0.6),
        ),
    )
}
```

### 5.3 é‡è¯•æœºåˆ¶

```go
// internal/middleware/retry.go
package middleware

import (
    "github.com/go-kratos/kratos/v2/middleware/retry"
    "github.com/go-kratos/kratos/v2/transport/grpc"
)

func RetryMiddleware() grpc.ClientOption {
    return grpc.WithMiddleware(
        retry.Client(
            retry.WithAttempts(3),
            retry.WithDelay(100*time.Millisecond),
            retry.WithBackoff(retry.BackoffExponential),
        ),
    )
}
```

### 5.4 é™æµ

```go
// internal/middleware/ratelimit.go
package middleware

import (
    "github.com/go-kratos/kratos/v2/middleware/ratelimit"
    "github.com/go-kratos/kratos/v2/transport/http"
)

func RateLimit() http.ServerOption {
    return http.Middleware(
        ratelimit.Server(
            ratelimit.WithLimiter(
                // ä½¿ç”¨å†…å­˜é™æµå™¨
                ratelimit.NewMemoryLimiter(
                    ratelimit.WithInterval(time.Second),
                    ratelimit.WithBurst(100),
                ),
            ),
        ),
    )
}
```

---

## å…­ã€ç›‘æ§å’Œæ—¥å¿—

### 6.1 æŒ‡æ ‡ç›‘æ§

```go
// internal/server/metrics.go
package server

import (
    "github.com/go-kratos/kratos/v2/metrics"
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

func NewMetricsServer() *http.Server {
    // åˆ›å»ºPrometheusæ³¨å†Œå™¨
    registry := prometheus.NewRegistry()

    // æ³¨å†Œè‡ªå®šä¹‰æŒ‡æ ‡
    requestCounter := prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )
    registry.MustRegister(requestCounter)

    requestDuration := prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request duration in seconds",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "endpoint"},
    )
    registry.MustRegister(requestDuration)

    mux := http.NewServeMux()
    mux.Handle("/metrics", promhttp.HandlerFor(registry, promhttp.HandlerOpts{}))

    return &http.Server{
        Addr:    ":9090",
        Handler: mux,
    }
}
```

### 6.2 åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

```go
// internal/middleware/tracing.go
package middleware

import (
    "github.com/go-kratos/kratos/v2/middleware/tracing"
    "github.com/go-kratos/kratos/v2/transport/http"
)

func Tracing() http.ServerOption {
    return http.Middleware(
        tracing.Server(
            tracing.WithTracerProvider(tp),
            tracing.WithPropagator(propagator),
        ),
    )
}

// cmd/server/main.go
func initTracer() {
    // åˆå§‹åŒ–Jaegerè¿½è¸ªå™¨
    tracer, closer := jaeger.NewTracer(
        "user-service",
        jaeger.NewConstSampler(true),
        jaeger.NewNullReporter(),
    )

    opentracing.SetGlobalTracer(tracer)
    // defer closer.Close()
}
```

### 6.3 ç»“æ„åŒ–æ—¥å¿—

```go
// internal/middleware/logging.go
package middleware

import (
    "github.com/go-kratos/kratos/v2/log"
    "github.com/go-kratos/kratos/v2/middleware/logging"
    "github.com/go-kratos/kratos/v2/transport/http"
)

func Logging(logger log.Logger) http.ServerOption {
    return http.Middleware(
        logging.Server(
            logging.WithLogger(logger),
            logging.WithMessageKey("msg"),
            logging.WithLevelKey("level"),
            logging.WithTimestampKey("time"),
            logging.WithCallerKey("caller"),
        ),
    )
}
```

---

## ä¸ƒã€APIç½‘å…³

### 7.1 Kratos APIç½‘å…³

```go
// cmd/gateway/main.go
package main

import (
    "github.com/go-kratos/kratos/v2"
    "github.com/go-kratos/kratos/v2/registry"
    "github.com/go-kratos/kratos/v2/selector"
    "github.com/go-kratos/kratos/v2/selector/wrr"
    "github.com/go-kratos/kratos/v2/transport/grpc"
    "github.com/go-kratos/kratos/v2/transport/http"
)

func main() {
    // æœåŠ¡å‘ç°
    disco, err := etcd.New(&clientv3.Config{
        Endpoints: []string{"etcd-1:2379", "etcd-2:2379", "etcd-3:2379"},
    })
    if err != nil {
        panic(err)
    }

    // è´Ÿè½½å‡è¡¡å™¨
    sl := selector.NewSelector(
        selector.Registry(disco),
        selector.Balancer(wrr.Name),
    )

    // åˆ›å»ºå®¢æˆ·ç«¯è¿æ¥
    userConn, err := grpc.DialInsecure(
        context.Background(),
        grpc.WithEndpoint("discovery:///user.service"),
        grpc.WithDiscovery(disco),
        grpc.WithSelector(sl),
    )
    if err != nil {
        panic(err)
    }

    orderConn, err := grpc.DialInsecure(
        context.Background(),
        grpc.WithEndpoint("discovery:///order.service"),
        grpc.WithDiscovery(disco),
        grpc.WithSelector(sl),
    )
    if err != nil {
        panic(err)
    }

    // HTTPæœåŠ¡å™¨
    httpSrv := http.NewServer(
        http.Address(":8000"),
        http.Middleware(
            cors.CORS(),
            auth.JWTAuth(),
            ratelimit.Server(),
        ),
    )

    // æ³¨å†Œè·¯ç”±
    registerRoutes(httpSrv, userConn, orderConn)

    app := kratos.New(
        kratos.Name("api-gateway"),
        kratos.Server(httpSrv),
    )

    if err := app.Run(); err != nil {
        panic(err)
    }
}

func registerRoutes(srv *http.Server, userConn, orderConn *grpc.ClientConn) {
    userClient := v1.NewUserServiceClient(userConn)
    orderClient := v1.NewOrderServiceClient(orderConn)

    // ç”¨æˆ·ç›¸å…³è·¯ç”±
    srv.HandleFunc("/api/v1/users", func(w http.ResponseWriter, r *http.Request) {
        switch r.Method {
        case "GET":
            // è°ƒç”¨ç”¨æˆ·æœåŠ¡
            resp, err := userClient.ListUsers(r.Context(), &v1.ListUsersRequest{})
            if err != nil {
                http.Error(w, err.Error(), http.StatusInternalServerError)
                return
            }
            json.NewEncoder(w).Encode(resp)
        case "POST":
            var req v1.CreateUserRequest
            if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
                http.Error(w, err.Error(), http.StatusBadRequest)
                return
            }
            resp, err := userClient.CreateUser(r.Context(), &req)
            if err != nil {
                http.Error(w, err.Error(), http.StatusInternalServerError)
                return
            }
            json.NewEncoder(w).Encode(resp)
        }
    })

    // è®¢å•ç›¸å…³è·¯ç”±
    srv.HandleFunc("/api/v1/orders", func(w http.ResponseWriter, r *http.Request) {
        switch r.Method {
        case "GET":
            resp, err := orderClient.ListOrders(r.Context(), &v1.ListOrdersRequest{})
            if err != nil {
                http.Error(w, err.Error(), http.StatusInternalServerError)
                return
            }
            json.NewEncoder(w).Encode(resp)
        case "POST":
            var req v1.CreateOrderRequest
            if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
                http.Error(w, err.Error(), http.StatusBadRequest)
                return
            }
            resp, err := orderClient.CreateOrder(r.Context(), &req)
            if err != nil {
                http.Error(w, err.Error(), http.StatusInternalServerError)
                return
            }
            json.NewEncoder(w).Encode(resp)
        }
    })
}
```

---

## å…«ã€Dockerå’ŒKuberneteséƒ¨ç½²

### 8.1 Dockerfile

```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM golang:1.21-alpine AS builder

WORKDIR /app

# å®‰è£…ä¾èµ–
RUN apk add --no-cache git protobuf-dev

# å¤åˆ¶go modæ–‡ä»¶
COPY go.mod go.sum ./
RUN go mod download

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main ./cmd/server

# è¿è¡Œé˜¶æ®µ
FROM alpine:latest

RUN apk --no-cache add ca-certificates tzdata

WORKDIR /root/

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/main .
COPY --from=builder /app/configs ./configs

EXPOSE 8000 9000

CMD ["./main"]
```

### 8.2 Kuberneteséƒ¨ç½²

**deployment.yaml**:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: user-service
  template:
    metadata:
      labels:
        app: user-service
    spec:
      containers:
      - name: user-service
        image: user-service:latest
        ports:
        - containerPort: 8000
          name: http
        - containerPort: 9000
          name: grpc
        env:
        - name: APP_NAME
          value: "user-service"
        - name: HTTP_PORT
          value: "8000"
        - name: GRPC_PORT
          value: "9000"
        - name: ETCD_ENDPOINTS
          value: "etcd-1:2379,etcd-2:2379,etcd-3:2379"
        - name: DATABASE_DSN
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: dsn
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: user-service
spec:
  selector:
    app: user-service
  ports:
  - name: http
    port: 8000
    targetPort: 8000
  - name: grpc
    port: 9000
    targetPort: 9000
  type: ClusterIP
```

### 8.3 Service Meshé›†æˆ

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: user-service
spec:
  http:
  - match:
    - uri:
        prefix: "/api/v1/users"
    route:
    - destination:
        host: user-service
  - match:
    - uri:
        prefix: "/api/v1/orders"
    route:
    - destination:
        host: order-service
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: user-service
spec:
  host: user-service
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 10
```

---

## æ€»ç»“

1. **å¾®æœåŠ¡æ¶æ„**ï¼šç†è§£å¾®æœåŠ¡è®¾è®¡åŸåˆ™å’ŒæœåŠ¡æ‹†åˆ†
2. **æœåŠ¡æ³¨å†Œå‘ç°**ï¼šä½¿ç”¨Etcdã€Consulç­‰æ³¨å†Œä¸­å¿ƒ
3. **æœåŠ¡é—´é€šä¿¡**ï¼šgRPCåè®®å’Œè´Ÿè½½å‡è¡¡
4. **é…ç½®ä¸­å¿ƒ**ï¼šApolloã€Nacosç­‰é…ç½®ç®¡ç†
5. **æœåŠ¡æ²»ç†**ï¼šç†”æ–­ã€é™æµã€é‡è¯•ç­‰æœºåˆ¶
6. **ç›‘æ§æ—¥å¿—**ï¼šæŒ‡æ ‡ç›‘æ§ã€é“¾è·¯è¿½è¸ªã€ç»“æ„åŒ–æ—¥å¿—
7. **APIç½‘å…³**ï¼šç»Ÿä¸€å…¥å£å’Œè·¯ç”±è½¬å‘
8. **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDockerå’ŒKubernetesæ”¯æŒ

**æ­å–œå®ŒæˆKratoså¾®æœåŠ¡æ•™ç¨‹ï¼** ä½ å·²ç»æŒæ¡äº†ï¼š

- âœ… Kratosæ¡†æ¶çš„æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•
- âœ… GORMæ•°æ®åº“é›†æˆçš„å®Œæ•´æµç¨‹
- âœ… å¾®æœåŠ¡æ¶æ„çš„è®¾è®¡å’Œå®ç°
- âœ… æœåŠ¡æ²»ç†å’Œç›‘æ§çš„æœ€ä½³å®è·µ
- âœ… ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²å’Œè¿ç»´

ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨Kratosæ„å»ºä¼ä¸šçº§çš„å¾®æœåŠ¡åº”ç”¨äº†ï¼ğŸš€

---

## ğŸ“š æ‰©å±•å­¦ä¹ 

- [Kratoså®˜æ–¹æ–‡æ¡£](https://go-kratos.dev/docs/)
- [å¾®æœåŠ¡æ¶æ„æ¨¡å¼](https://microservices.io/patterns/)
- [Service Mesh](https://istio.io/)
- [Kubernetes](https://kubernetes.io/)
- [gRPCæ–‡æ¡£](https://grpc.io/docs/)
