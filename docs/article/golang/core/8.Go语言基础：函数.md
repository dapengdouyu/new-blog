---
title: 8ã€Goè¯­è¨€åŸºç¡€ï¼šå‡½æ•°
date: 2026-01-06
description: æ·±å…¥ç†è§£Goè¯­è¨€çš„å‡½æ•°æœºåˆ¶ï¼ŒåŒ…æ‹¬deferè¯­å¥çš„è¯¦ç»†ä½¿ç”¨
---

# 8ã€Goè¯­è¨€åŸºç¡€ï¼šå‡½æ•°

æœ¬æ–‡æ¡£ç³»ç»Ÿè®²è§£Goè¯­è¨€çš„å‡½æ•°æœºåˆ¶ï¼ŒåŒ…æ‹¬å‡½æ•°å®šä¹‰ã€å‚æ•°ä¼ é€’ã€è¿”å›å€¼ã€åŒ¿åå‡½æ•°ã€é—­åŒ…ï¼Œä»¥åŠdeferè¯­å¥çš„è¯¦ç»†ä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯å¤šå±‚åµŒå¥—å‡½æ•°çš„deferæ‰§è¡Œæœºåˆ¶ã€‚

## ğŸ¯ æœ¬è¯¾å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬è¯¾åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ç†è§£å‡½æ•°çš„å®šä¹‰ã€è°ƒç”¨å’Œå‚æ•°ä¼ é€’
- âœ… æŒæ¡å¤šè¿”å›å€¼å’Œå‘½åè¿”å›å€¼
- âœ… ç†è§£å¯å˜å‚æ•°çš„ä½¿ç”¨
- âœ… æŒæ¡å‡½æ•°ä½œä¸ºå€¼ä¼ é€’
- âœ… ç†è§£åŒ¿åå‡½æ•°å’Œé—­åŒ…
- âœ… **æ·±å…¥æŒæ¡deferè¯­å¥ï¼ŒåŒ…æ‹¬å¤šå±‚åµŒå¥—å‡½æ•°çš„deferæ‰§è¡Œæœºåˆ¶**
- âœ… ç†è§£æ–¹æ³•ï¼ˆMethodï¼‰çš„æ¦‚å¿µ

---

## ä¸€ã€å‡½æ•°çš„åŸºæœ¬å®šä¹‰

### 1.1 åŸºæœ¬å‡½æ•°

```go
package main

import "fmt"

// åŸºæœ¬å‡½æ•°
func greet(name string) {
    fmt.Println("Hello,", name)
}

// å¸¦è¿”å›å€¼çš„å‡½æ•°
func add(a, b int) int {
    return a + b
}

// å¤šä¸ªè¿”å›å€¼
func divide(a, b float64) (float64, error) {
    if b == 0 {
        return 0, fmt.Errorf("é™¤æ•°ä¸èƒ½ä¸º0")
    }
    return a / b, nil
}

func main() {
    greet("Alice")
    result := add(3, 5)
    fmt.Println(result)  // 8
    
    quotient, err := divide(10, 2)
    if err != nil {
        fmt.Println("é”™è¯¯:", err)
    } else {
        fmt.Println("ç»“æœ:", quotient)  // 5
    }
}
```

### 1.2 å‡½æ•°ç­¾å

å‡½æ•°ç­¾ååŒ…æ‹¬ï¼šå‡½æ•°åã€å‚æ•°åˆ—è¡¨ã€è¿”å›å€¼åˆ—è¡¨ã€‚

```go
// ç­¾åï¼šfunc(int, int) int
func add(a, b int) int {
    return a + b
}

// ç­¾åï¼šfunc(string, ...int) (int, error)
func sum(prefix string, numbers ...int) (int, error) {
    // ...
}
```

### 1.3 å‘½åè¿”å›å€¼

Goè¯­è¨€æ”¯æŒå‘½åè¿”å›å€¼ï¼Œå¯ä»¥åœ¨å‡½æ•°ä½“ä¸­ç›´æ¥ä½¿ç”¨ï¼š

```go
// å‘½åè¿”å›å€¼
func calculate(x, y int) (sum int, product int) {
    sum = x + y        // ç›´æ¥èµ‹å€¼ï¼Œæ— éœ€å£°æ˜
    product = x * y
    return             // è‡ªåŠ¨è¿”å›å‘½åè¿”å›å€¼
}

// ç­‰ä»·äº
func calculate2(x, y int) (int, int) {
    sum := x + y
    product := x * y
    return sum, product
}
```

**æ³¨æ„**ï¼šå‘½åè¿”å›å€¼ä¼šè¢«åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼Œå³ä½¿æ²¡æœ‰æ˜¾å¼èµ‹å€¼ã€‚

---

## äºŒã€å¯å˜å‚æ•°ï¼ˆVariadicï¼‰

ä½¿ç”¨`...`å®šä¹‰å¯å˜å‚æ•°ï¼š

```go
package main

import "fmt"

// å¯å˜å‚æ•°å¿…é¡»æ˜¯æœ€åä¸€ä¸ªå‚æ•°
func sum(numbers ...int) int {
    total := 0
    for _, num := range numbers {
        total += num
    }
    return total
}

func main() {
    fmt.Println(sum(1, 2, 3))        // 6
    fmt.Println(sum(1, 2, 3, 4, 5))  // 15
    
    // ä¼ é€’åˆ‡ç‰‡
    nums := []int{1, 2, 3}
    fmt.Println(sum(nums...))        // 6
}
```

---

## ä¸‰ã€å‡½æ•°ä½œä¸ºå€¼

åœ¨Goè¯­è¨€ä¸­ï¼Œå‡½æ•°æ˜¯**ä¸€ç­‰å…¬æ°‘**ï¼Œå¯ä»¥ä½œä¸ºå€¼ä¼ é€’ï¼š

```go
package main

import "fmt"

// å‡½æ•°ç±»å‹
type Operation func(int, int) int

func add(a, b int) int {
    return a + b
}

func multiply(a, b int) int {
    return a * b
}

// å‡½æ•°ä½œä¸ºå‚æ•°
func calculate(a, b int, op Operation) int {
    return op(a, b)
}

func main() {
    result1 := calculate(3, 4, add)       // 7
    result2 := calculate(3, 4, multiply)  // 12
    
    fmt.Println(result1, result2)
}
```

---

## å››ã€åŒ¿åå‡½æ•°å’Œé—­åŒ…

### 4.1 åŒ¿åå‡½æ•°

```go
// ç«‹å³æ‰§è¡Œ
func() {
    fmt.Println("åŒ¿åå‡½æ•°")
}()

// èµ‹å€¼ç»™å˜é‡
add := func(a, b int) int {
    return a + b
}
result := add(3, 5)
```

### 4.2 é—­åŒ…ï¼ˆClosureï¼‰

é—­åŒ…å¯ä»¥æ•è·å¤–éƒ¨å˜é‡ï¼š

```go
package main

import "fmt"

func counter() func() int {
    count := 0
    return func() int {
        count++
        return count
    }
}

func main() {
    c1 := counter()
    fmt.Println(c1())  // 1
    fmt.Println(c1())  // 2
    fmt.Println(c1())  // 3
    
    c2 := counter()
    fmt.Println(c2())  // 1ï¼ˆç‹¬ç«‹çš„é—­åŒ…ï¼‰
}
```

### 4.3 é—­åŒ…çš„å¸¸è§é™·é˜±

```go
// é™·é˜±ï¼šå¾ªç¯å˜é‡é—®é¢˜ï¼ˆGo 1.22å·²ä¿®å¤for-rangeï¼‰
var funcs []func()
for i := 0; i < 3; i++ {
    // é”™è¯¯ï¼šæ‰€æœ‰é—­åŒ…å…±äº«åŒä¸€ä¸ªi
    funcs = append(funcs, func() {
        fmt.Println(i)  // éƒ½è¾“å‡º3
    })
}

// æ­£ç¡®ï¼šåˆ›å»ºå±€éƒ¨å‰¯æœ¬
for i := 0; i < 3; i++ {
    i := i  // åˆ›å»ºå±€éƒ¨å‰¯æœ¬
    funcs = append(funcs, func() {
        fmt.Println(i)  // 0, 1, 2
    })
}
```

---

## äº”ã€deferè¯­å¥è¯¦è§£

`defer`æ˜¯Goè¯­è¨€ä¸­éå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œç”¨äºå»¶è¿Ÿæ‰§è¡Œå‡½æ•°ï¼Œå¸¸ç”¨äºèµ„æºæ¸…ç†ã€‚æœ¬èŠ‚å°†æ·±å…¥è®²è§£deferçš„æ‰§è¡Œæœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯å¤šå±‚åµŒå¥—å‡½æ•°çš„deferæ‰§è¡Œã€‚

### 5.1 deferçš„åŸºæœ¬ä½¿ç”¨

```go
package main

import "fmt"

func main() {
    defer fmt.Println("æœ€åæ‰§è¡Œ")
    fmt.Println("å…ˆæ‰§è¡Œ")
    fmt.Println("ä¸­é—´æ‰§è¡Œ")
    // è¾“å‡ºï¼š
    // å…ˆæ‰§è¡Œ
    // ä¸­é—´æ‰§è¡Œ
    // æœ€åæ‰§è¡Œ
}
```

### 5.2 deferçš„æ‰§è¡Œé¡ºåº

å¤šä¸ªdeferæŒ‰**åè¿›å…ˆå‡º-LIFO**é¡ºåºæ‰§è¡Œï¼š

```go
func main() {
    defer fmt.Println("1")
    defer fmt.Println("2")
    defer fmt.Println("3")
    // è¾“å‡ºï¼š3, 2, 1
}
```

### 5.3 deferçš„å¸¸è§ç”¨é€”

```go
// 1. å…³é—­æ–‡ä»¶
file, err := os.Open("file.txt")
if err != nil {
    return err
}
defer file.Close()  // ç¡®ä¿æ–‡ä»¶è¢«å…³é—­

// 2. è§£é”
mu.Lock()
defer mu.Unlock()

// 3. æ¢å¤panic
defer func() {
    if r := recover(); r != nil {
        fmt.Println("æ¢å¤:", r)
    }
}()
```

### 5.4 deferçš„å‚æ•°æ±‚å€¼

**é‡è¦**ï¼šdeferçš„å‚æ•°åœ¨**å£°æ˜æ—¶**æ±‚å€¼ï¼Œè€Œéæ‰§è¡Œæ—¶ï¼š

```go
func main() {
    x := 1
    defer fmt.Println(x)  // è¾“å‡º1ï¼ˆä¸æ˜¯2ï¼‰
    x = 2
}

// å¦‚æœéœ€è¦ä½¿ç”¨æ‰§è¡Œæ—¶çš„å€¼
func main() {
    x := 1
    defer func() {
        fmt.Println(x)  // è¾“å‡º2
    }()
    x = 2
}
```

### 5.5 deferä¸è¿”å›å€¼

deferå¯ä»¥è®¿é—®å’Œä¿®æ”¹å‘½åè¿”å›å€¼ï¼š

```go
func example() (result int) {
    defer func() {
        result++  // ä¿®æ”¹è¿”å›å€¼
    }()
    return 5  // å®é™…è¿”å›6
}

func main() {
    fmt.Println(example())  // 6
}
```

### 5.6 å¤šå±‚åµŒå¥—å‡½æ•°çš„deferæ‰§è¡Œæœºåˆ¶

è¿™æ˜¯deferæœ€å¤æ‚ä¹Ÿæœ€é‡è¦çš„éƒ¨åˆ†ã€‚è®©æˆ‘ä»¬é€šè¿‡è¯¦ç»†çš„ä¾‹å­æ¥ç†è§£ï¼š

#### ç¤ºä¾‹1ï¼šå•å±‚å‡½æ•°ä¸­çš„å¤šä¸ªdefer

```go
package main

import "fmt"

func level1() {
    fmt.Println("level1: å¼€å§‹")
    defer fmt.Println("level1: defer 1")
    defer fmt.Println("level1: defer 2")
    fmt.Println("level1: ç»“æŸ")
}

func main() {
    level1()
    // è¾“å‡ºï¼š
    // level1: å¼€å§‹
    // level1: ç»“æŸ
    // level1: defer 2
    // level1: defer 1
}
```

#### ç¤ºä¾‹2ï¼šä¸¤å±‚åµŒå¥—å‡½æ•°çš„defer

```go
package main

import "fmt"

func level2() {
    fmt.Println("level2: å¼€å§‹")
    defer fmt.Println("level2: defer")
    fmt.Println("level2: ç»“æŸ")
}

func level1() {
    fmt.Println("level1: å¼€å§‹")
    defer fmt.Println("level1: defer")
    level2()  // è°ƒç”¨level2
    fmt.Println("level1: ç»“æŸ")
}

func main() {
    level1()
    // è¾“å‡ºï¼š
    // level1: å¼€å§‹
    // level2: å¼€å§‹
    // level2: ç»“æŸ
    // level2: defer      <- level2çš„deferå…ˆæ‰§è¡Œ
    // level1: ç»“æŸ
    // level1: defer     <- level1çš„deferåæ‰§è¡Œ
}
```

**å…³é”®ç†è§£**ï¼šæ¯ä¸ªå‡½æ•°çš„deferåœ¨**è¯¥å‡½æ•°è¿”å›æ—¶**æ‰§è¡Œï¼Œå†…å±‚å‡½æ•°çš„deferå…ˆäºå¤–å±‚å‡½æ•°çš„deferæ‰§è¡Œã€‚

#### ç¤ºä¾‹3ï¼šä¸‰å±‚åµŒå¥—å‡½æ•°çš„defer

```go
package main

import "fmt"

func level3() {
    fmt.Println("level3: å¼€å§‹")
    defer fmt.Println("level3: defer 1")
    defer fmt.Println("level3: defer 2")
    fmt.Println("level3: ç»“æŸ")
}

func level2() {
    fmt.Println("level2: å¼€å§‹")
    defer fmt.Println("level2: defer 1")
    level3()  // è°ƒç”¨level3
    defer fmt.Println("level2: defer 2")
    fmt.Println("level2: ç»“æŸ")
}

func level1() {
    fmt.Println("level1: å¼€å§‹")
    defer fmt.Println("level1: defer")
    level2()  // è°ƒç”¨level2
    fmt.Println("level1: ç»“æŸ")
}

func main() {
    level1()
    // è¾“å‡ºï¼š
    // level1: å¼€å§‹
    // level2: å¼€å§‹
    // level3: å¼€å§‹
    // level3: ç»“æŸ
    // level3: defer 2    <- level3çš„deferï¼ˆLIFOé¡ºåºï¼‰
    // level3: defer 1
    // level2: defer 2    <- level2çš„deferï¼ˆLIFOé¡ºåºï¼‰
    // level2: defer 1
    // level2: ç»“æŸ
    // level1: defer      <- level1çš„defer
    // level1: ç»“æŸ
}
```

#### ç¤ºä¾‹4ï¼šdeferä¸panicçš„äº¤äº’

```go
package main

import "fmt"

func level3() {
    fmt.Println("level3: å¼€å§‹")
    defer fmt.Println("level3: defer 1")
    defer fmt.Println("level3: defer 2")
    panic("level3 panic")  // è§¦å‘panic
    fmt.Println("level3: ç»“æŸï¼ˆä¸ä¼šæ‰§è¡Œï¼‰")
}

func level2() {
    fmt.Println("level2: å¼€å§‹")
    defer fmt.Println("level2: defer 1")
    defer func() {
        if r := recover(); r != nil {
            fmt.Printf("level2: æ•è·panic: %v\n", r)
        }
    }()
    level3()  // è°ƒç”¨level3ï¼Œä¼šè§¦å‘panic
    defer fmt.Println("level2: defer 2")
    fmt.Println("level2: ç»“æŸï¼ˆä¸ä¼šæ‰§è¡Œï¼‰")
}

func level1() {
    fmt.Println("level1: å¼€å§‹")
    defer fmt.Println("level1: defer")
    level2()  // è°ƒç”¨level2
    fmt.Println("level1: ç»“æŸ")
}

func main() {
    level1()
    // è¾“å‡ºï¼š
    // level1: å¼€å§‹
    // level2: å¼€å§‹
    // level3: å¼€å§‹
    // level3: defer 2    <- panicå‰ï¼Œlevel3çš„deferå…ˆæ‰§è¡Œï¼ˆLIFOï¼‰
    // level3: defer 1
    // level2: æ•è·panic: level3 panic  <- level2çš„deferä¸­çš„recoveræ•è·
    // level2: defer 1     <- level2çš„å…¶ä»–deferç»§ç»­æ‰§è¡Œ
    // level2: defer 2
    // level2: ç»“æŸ        <- level2æ­£å¸¸è¿”å›
    // level1: defer
    // level1: ç»“æŸ
}
```

#### ç¤ºä¾‹5ï¼šdeferä¸è¿”å›å€¼ï¼ˆå¤šå±‚åµŒå¥—ï¼‰

```go
package main

import "fmt"

func level3() (result int) {
    defer func() {
        result += 10
        fmt.Printf("level3: deferä¿®æ”¹resultä¸º%d\n", result)
    }()
    result = 1
    return result  // è¿”å›11ï¼ˆdeferä¿®æ”¹åï¼‰
}

func level2() (result int) {
    defer func() {
        result += 100
        fmt.Printf("level2: deferä¿®æ”¹resultä¸º%d\n", result)
    }()
    result = level3()  // æ¥æ”¶level3çš„è¿”å›å€¼11
    return result  // è¿”å›111ï¼ˆdeferä¿®æ”¹åï¼‰
}

func level1() (result int) {
    defer func() {
        result += 1000
        fmt.Printf("level1: deferä¿®æ”¹resultä¸º%d\n", result)
    }()
    result = level2()  // æ¥æ”¶level2çš„è¿”å›å€¼111
    return result  // è¿”å›1111ï¼ˆdeferä¿®æ”¹åï¼‰
}

func main() {
    result := level1()
    fmt.Printf("æœ€ç»ˆç»“æœ: %d\n", result)
    // è¾“å‡ºï¼š
    // level3: deferä¿®æ”¹resultä¸º11
    // level2: deferä¿®æ”¹resultä¸º111
    // level1: deferä¿®æ”¹resultä¸º1111
    // æœ€ç»ˆç»“æœ: 1111
}
```

#### ç¤ºä¾‹6ï¼šå¤æ‚çš„å¤šå±‚deferåœºæ™¯

```go
package main

import "fmt"

func processResource(name string) {
    fmt.Printf("%s: æ‰“å¼€èµ„æº\n", name)
    defer fmt.Printf("%s: å…³é—­èµ„æº\n", name)
    
    if name == "resource2" {
        panic("resource2 panic")
    }
    
    fmt.Printf("%s: ä½¿ç”¨èµ„æº\n", name)
}

func level2() {
    fmt.Println("level2: å¼€å§‹")
    defer fmt.Println("level2: defer 1")
    
    processResource("resource1")
    
    defer fmt.Println("level2: defer 2")
    
    processResource("resource2")  // ä¼šè§¦å‘panic
    
    defer fmt.Println("level2: defer 3")  // ä¸ä¼šæ‰§è¡Œï¼ˆpanicåï¼‰
    fmt.Println("level2: ç»“æŸï¼ˆä¸ä¼šæ‰§è¡Œï¼‰")
}

func level1() {
    fmt.Println("level1: å¼€å§‹")
    defer fmt.Println("level1: defer")
    
    defer func() {
        if r := recover(); r != nil {
            fmt.Printf("level1: æ•è·panic: %v\n", r)
        }
    }()
    
    level2()
    fmt.Println("level1: ç»“æŸ")
}

func main() {
    level1()
    // è¾“å‡ºï¼š
    // level1: å¼€å§‹
    // level2: å¼€å§‹
    // resource1: æ‰“å¼€èµ„æº
    // resource1: ä½¿ç”¨èµ„æº
    // resource1: å…³é—­èµ„æº      <- resource1çš„deferæ‰§è¡Œ
    // level2: defer 2          <- level2çš„deferï¼ˆLIFOé¡ºåºï¼‰
    // level2: defer 1
    // resource2: æ‰“å¼€èµ„æº
    // resource2: å…³é—­èµ„æº      <- resource2çš„deferæ‰§è¡Œï¼ˆå³ä½¿panicï¼‰
    // level1: æ•è·panic: resource2 panic
    // level1: defer
    // level1: ç»“æŸ
}
```

### 5.7 deferçš„æ‰§è¡Œæ—¶æœºæ€»ç»“

1. **deferåœ¨å‡½æ•°è¿”å›æ—¶æ‰§è¡Œ**ï¼šæ— è®ºæ˜¯æ­£å¸¸è¿”å›è¿˜æ˜¯panicè¿”å›
2. **å¤šä¸ªdeferæŒ‰LIFOé¡ºåºæ‰§è¡Œ**ï¼šåè¿›å…ˆå‡º
3. **å†…å±‚å‡½æ•°çš„deferå…ˆäºå¤–å±‚å‡½æ•°çš„deferæ‰§è¡Œ**
4. **deferçš„å‚æ•°åœ¨å£°æ˜æ—¶æ±‚å€¼**ï¼šä¸æ˜¯æ‰§è¡Œæ—¶
5. **deferå¯ä»¥è®¿é—®å’Œä¿®æ”¹å‘½åè¿”å›å€¼**
6. **å³ä½¿å‘ç”Ÿpanicï¼Œdeferä¹Ÿä¼šæ‰§è¡Œ**ï¼šè¿™æ˜¯èµ„æºæ¸…ç†çš„é‡è¦ä¿è¯

### 5.8 deferçš„æœ€ä½³å®è·µ

```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨deferç¡®ä¿èµ„æºæ¸…ç†
func readFile(filename string) error {
    file, err := os.Open(filename)
    if err != nil {
        return err
    }
    defer file.Close()  // ç¡®ä¿æ–‡ä»¶è¢«å…³é—­
    
    // å¤„ç†æ–‡ä»¶...
    return nil
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨deferè¿›è¡Œé”™è¯¯æ¢å¤
func riskyOperation() {
    defer func() {
        if r := recover(); r != nil {
            log.Printf("æ¢å¤panic: %v", r)
        }
    }()
    
    // å¯èƒ½panicçš„æ“ä½œ...
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨deferè®°å½•å‡½æ•°æ‰§è¡Œæ—¶é—´
func expensiveOperation() {
    defer func(start time.Time) {
        fmt.Printf("æ‰§è¡Œæ—¶é—´: %v\n", time.Since(start))
    }(time.Now())
    
    // è€—æ—¶æ“ä½œ...
}

// âŒ é”™è¯¯ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨deferï¼ˆå¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼ï¼‰
for i := 0; i < 1000; i++ {
    file, _ := os.Open(fmt.Sprintf("file%d.txt", i))
    defer file.Close()  // æ‰€æœ‰æ–‡ä»¶åœ¨å‡½æ•°ç»“æŸæ—¶æ‰å…³é—­
}

// âœ… æ­£ç¡®ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨å‡½æ•°åŒ…è£…
for i := 0; i < 1000; i++ {
    func() {
        file, _ := os.Open(fmt.Sprintf("file%d.txt", i))
        defer file.Close()  // æ¯æ¬¡å¾ªç¯ç»“æŸæ—¶å…³é—­
        // ä½¿ç”¨file...
    }()
}
```

---

## å…­ã€æ–¹æ³•ï¼ˆMethodï¼‰

æ–¹æ³•æ˜¯æœ‰æ¥æ”¶è€…çš„å‡½æ•°ï¼š

```go
type Rectangle struct {
    Width, Height float64
}

// å€¼æ¥æ”¶è€…æ–¹æ³•
func (r Rectangle) Area() float64 {
    return r.Width * r.Height
}

// æŒ‡é’ˆæ¥æ”¶è€…æ–¹æ³•
func (r *Rectangle) Scale(factor float64) {
    r.Width *= factor
    r.Height *= factor
}
```

---

## ä¸ƒã€å‡½æ•°çš„æœ€ä½³å®è·µ

```go
// âœ… é”™è¯¯å¤„ç†ï¼šè¿”å›error
func doSomething() error {
    // ...
    return nil
}

// âœ… ä½¿ç”¨å‘½åè¿”å›å€¼æé«˜å¯è¯»æ€§
func parse(input string) (result string, err error) {
    // ...
}

// âœ… ä½¿ç”¨deferç¡®ä¿èµ„æºæ¸…ç†
func readFile(filename string) error {
    file, err := os.Open(filename)
    if err != nil {
        return err
    }
    defer file.Close()
    // ...
}

// âœ… å‡½æ•°åº”è¯¥çŸ­å°ç²¾æ‚ï¼Œå•ä¸€èŒè´£
func calculateTotal(items []Item) float64 {
    // ...
}

// âŒ é¿å…è¿‡é•¿çš„å‡½æ•°
// âŒ é¿å…è¿‡å¤šçš„å‚æ•°ï¼ˆè¶…è¿‡3-4ä¸ªè€ƒè™‘ä½¿ç”¨ç»“æ„ä½“ï¼‰
```

---

## å…«ã€ç»¼åˆç¤ºä¾‹

```go
package main

import (
    "fmt"
    "errors"
)

// è®¡ç®—å™¨ç»“æ„ä½“
type Calculator struct {
    result float64
}

// æ„é€ å‡½æ•°
func NewCalculator() *Calculator {
    return &Calculator{result: 0}
}

// åŠ æ³•
func (c *Calculator) Add(value float64) {
    c.result += value
}

// å‡æ³•
func (c *Calculator) Subtract(value float64) {
    c.result -= value
}

// ä¹˜æ³•
func (c *Calculator) Multiply(value float64) {
    c.result *= value
}

// é™¤æ³•
func (c *Calculator) Divide(value float64) error {
    if value == 0 {
        return errors.New("é™¤æ•°ä¸èƒ½ä¸º0")
    }
    c.result /= value
    return nil
}

// è·å–ç»“æœ
func (c *Calculator) GetResult() float64 {
    return c.result
}

// é‡ç½®
func (c *Calculator) Reset() {
    c.result = 0
}

func main() {
    calc := NewCalculator()
    
    // æ‰§è¡Œä¸€ç³»åˆ—è®¡ç®—
    operations := []struct {
        op    string
        value float64
    }{
        {"add", 10},
        {"multiply", 2},
        {"subtract", 5},
        {"divide", 3},
    }
    
    for _, op := range operations {
        switch op.op {
        case "add":
            calc.Add(op.value)
        case "subtract":
            calc.Subtract(op.value)
        case "multiply":
            calc.Multiply(op.value)
        case "divide":
            if err := calc.Divide(op.value); err != nil {
                fmt.Println("é”™è¯¯:", err)
                return
            }
        }
        fmt.Printf("æ‰§è¡Œ %s %.2fï¼Œå½“å‰ç»“æœ: %.2f\n", op.op, op.value, calc.GetResult())
    }
    
    fmt.Printf("\næœ€ç»ˆç»“æœ: %.2f\n", calc.GetResult())
}
```

---

## æ€»ç»“

1. **å‡½æ•°å®šä¹‰**ï¼šæ”¯æŒå¤šè¿”å›å€¼ã€å‘½åè¿”å›å€¼ã€å¯å˜å‚æ•°
2. **å‡½æ•°ä½œä¸ºå€¼**ï¼šå‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼
3. **åŒ¿åå‡½æ•°å’Œé—­åŒ…**ï¼šå¯ä»¥æ•è·å¤–éƒ¨å˜é‡ï¼Œæ³¨æ„å¾ªç¯å˜é‡çš„é™·é˜±
4. **deferè¯­å¥**ï¼š
   - æŒ‰LIFOé¡ºåºæ‰§è¡Œ
   - å‚æ•°åœ¨å£°æ˜æ—¶æ±‚å€¼
   - å†…å±‚å‡½æ•°çš„deferå…ˆäºå¤–å±‚å‡½æ•°çš„deferæ‰§è¡Œ
   - å³ä½¿å‘ç”Ÿpanicä¹Ÿä¼šæ‰§è¡Œ
   - å¯ä»¥è®¿é—®å’Œä¿®æ”¹å‘½åè¿”å›å€¼
5. **æ–¹æ³•**ï¼šæœ‰æ¥æ”¶è€…çš„å‡½æ•°ï¼Œæ”¯æŒå€¼æ¥æ”¶è€…å’ŒæŒ‡é’ˆæ¥æ”¶è€…

æŒæ¡è¿™äº›æ ¸å¿ƒç‰¹æ€§ï¼Œç‰¹åˆ«æ˜¯deferçš„æ‰§è¡Œæœºåˆ¶ï¼Œæ˜¯ç¼–å†™é«˜è´¨é‡Goä»£ç çš„åŸºç¡€ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¦ç‰¹åˆ«æ³¨æ„ï¼š
- deferçš„æ‰§è¡Œæ—¶æœºå’Œé¡ºåº
- å¤šå±‚åµŒå¥—å‡½æ•°ä¸­deferçš„æ‰§è¡Œé¡ºåº
- deferä¸panicçš„äº¤äº’
- deferä¸è¿”å›å€¼çš„äº¤äº’
- åœ¨å¾ªç¯ä¸­æ­£ç¡®ä½¿ç”¨defer
