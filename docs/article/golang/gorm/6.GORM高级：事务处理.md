---
title: 6ã€GORMé«˜çº§ï¼šäº‹åŠ¡å¤„ç†
date: 2026-01-09
description: æ·±å…¥å­¦ä¹ GORMçš„äº‹åŠ¡å¤„ç†ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§
---

# 6ã€GORMé«˜çº§ï¼šäº‹åŠ¡å¤„ç†

æœ¬æ–‡æ¡£æ·±å…¥è®²è§£GORMçš„äº‹åŠ¡å¤„ç†æœºåˆ¶ï¼Œäº‹åŠ¡æ˜¯ç¡®ä¿æ•°æ®åº“æ“ä½œåŸå­æ€§å’Œä¸€è‡´æ€§çš„é‡è¦æ‰‹æ®µã€‚

## ğŸ¯ æœ¬è¯¾å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬è¯¾åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ç†è§£æ•°æ®åº“äº‹åŠ¡çš„æ¦‚å¿µ
- âœ… æŒæ¡GORMçš„äº‹åŠ¡ä½¿ç”¨æ–¹æ³•
- âœ… å­¦ä¼šæ‰‹åŠ¨äº‹åŠ¡ç®¡ç†
- âœ… ç†è§£è‡ªåŠ¨äº‹åŠ¡å¤„ç†
- âœ… æŒæ¡äº‹åŠ¡çš„åµŒå¥—å’Œå›æ»š
- âœ… ç†è§£äº‹åŠ¡çš„æ€§èƒ½å½±å“

---

## å‰ç½®çŸ¥è¯†

- **ç¬¬1-5è¯¾**ï¼šæŒæ¡GORMçš„åŸºç¡€æ“ä½œå’Œå…³è”

---

## ä¸€ã€äº‹åŠ¡åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ

äº‹åŠ¡ï¼ˆTransactionï¼‰æ˜¯ä¸€ç»„æ•°æ®åº“æ“ä½œï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚äº‹åŠ¡å…·æœ‰ACIDç‰¹æ€§ï¼š

- **åŸå­æ€§ï¼ˆAtomicityï¼‰**ï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ
- **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**ï¼šäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“ä¿æŒä¸€è‡´çŠ¶æ€
- **éš”ç¦»æ€§ï¼ˆIsolationï¼‰**ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´ç›¸äº’éš”ç¦»
- **æŒä¹…æ€§ï¼ˆDurabilityï¼‰**ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ï¼Ÿ

```go
// æ²¡æœ‰äº‹åŠ¡çš„é—®é¢˜ï¼šå¦‚æœä¸­é—´æ­¥éª¤å¤±è´¥ï¼Œæ•°æ®ä¼šä¸ä¸€è‡´
func TransferMoney(db *gorm.DB, fromID, toID uint, amount float64) error {
    // ä»è´¦æˆ·Aæ‰£æ¬¾
    var fromAccount Account
    db.First(&fromAccount, fromID)
    fromAccount.Balance -= amount
    db.Save(&fromAccount)  // å¦‚æœè¿™é‡ŒæˆåŠŸï¼Œä½†ä¸‹ä¸€æ­¥å¤±è´¥ï¼Œæ•°æ®å°±ä¸ä¸€è‡´äº†

    // å‘è´¦æˆ·Bè½¬è´¦
    var toAccount Account
    db.First(&toAccount, toID)
    toAccount.Balance += amount
    db.Save(&toAccount)  // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œè´¦æˆ·Aå·²ç»æ‰£æ¬¾äº†ï¼Œä½†è´¦æˆ·Bæ²¡æœ‰æ”¶åˆ°

    return nil
}
```

---

## äºŒã€æ‰‹åŠ¨äº‹åŠ¡

### 2.1 åŸºæœ¬ä½¿ç”¨

```go
package main

import (
    "fmt"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

type Account struct {
    ID      uint    `gorm:"primaryKey"`
    Balance float64
}

func main() {
    db, _ := gorm.Open(sqlite.Open("test.db"), &gorm.Config{})
    db.AutoMigrate(&Account{})

    // å¼€å§‹äº‹åŠ¡
    tx := db.Begin()

    // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ
    account := Account{Balance: 1000.0}
    if err := tx.Create(&account).Error; err != nil {
        tx.Rollback()  // å›æ»šäº‹åŠ¡
        fmt.Printf("åˆ›å»ºå¤±è´¥: %v\n", err)
        return
    }

    // æäº¤äº‹åŠ¡
    if err := tx.Commit().Error; err != nil {
        fmt.Printf("æäº¤å¤±è´¥: %v\n", err)
        return
    }

    fmt.Println("äº‹åŠ¡æ‰§è¡ŒæˆåŠŸ")
}
```

### 2.2 è½¬è´¦ç¤ºä¾‹

```go
func TransferMoney(db *gorm.DB, fromID, toID uint, amount float64) error {
    // å¼€å§‹äº‹åŠ¡
    tx := db.Begin()
    defer func() {
        if r := recover(); r != nil {
            tx.Rollback()
        }
    }()

    // ä»è´¦æˆ·Aæ‰£æ¬¾
    var fromAccount Account
    if err := tx.First(&fromAccount, fromID).Error; err != nil {
        tx.Rollback()
        return fmt.Errorf("æŸ¥è¯¢è´¦æˆ·å¤±è´¥: %v", err)
    }

    if fromAccount.Balance < amount {
        tx.Rollback()
        return fmt.Errorf("ä½™é¢ä¸è¶³")
    }

    fromAccount.Balance -= amount
    if err := tx.Save(&fromAccount).Error; err != nil {
        tx.Rollback()
        return fmt.Errorf("æ‰£æ¬¾å¤±è´¥: %v", err)
    }

    // å‘è´¦æˆ·Bè½¬è´¦
    var toAccount Account
    if err := tx.First(&toAccount, toID).Error; err != nil {
        tx.Rollback()
        return fmt.Errorf("æŸ¥è¯¢è´¦æˆ·å¤±è´¥: %v", err)
    }

    toAccount.Balance += amount
    if err := tx.Save(&toAccount).Error; err != nil {
        tx.Rollback()
        return fmt.Errorf("è½¬è´¦å¤±è´¥: %v", err)
    }

    // æäº¤äº‹åŠ¡
    if err := tx.Commit().Error; err != nil {
        return fmt.Errorf("æäº¤å¤±è´¥: %v", err)
    }

    return nil
}
```

### 2.3 é”™è¯¯å¤„ç†æ¨¡å¼

```go
func ProcessOrder(db *gorm.DB, orderID uint) error {
    tx := db.Begin()
    defer func() {
        if r := recover(); r != nil {
            tx.Rollback()
            panic(r)  // é‡æ–°æŠ›å‡ºpanic
        }
    }()

    // æ‰§è¡Œå¤šä¸ªæ“ä½œ
    if err := tx.Model(&Order{}).Where("id = ?", orderID).Update("status", "processing").Error; err != nil {
        tx.Rollback()
        return err
    }

    if err := tx.Model(&OrderItem{}).Where("order_id = ?", orderID).Update("status", "processing").Error; err != nil {
        tx.Rollback()
        return err
    }

    return tx.Commit().Error
}
```

---

## ä¸‰ã€è‡ªåŠ¨äº‹åŠ¡

### 3.1 Transactionæ–¹æ³•

GORMæä¾›äº†`Transaction`æ–¹æ³•ï¼Œè‡ªåŠ¨å¤„ç†äº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼š

```go
func TransferMoney(db *gorm.DB, fromID, toID uint, amount float64) error {
    return db.Transaction(func(tx *gorm.DB) error {
        // ä»è´¦æˆ·Aæ‰£æ¬¾
        var fromAccount Account
        if err := tx.First(&fromAccount, fromID).Error; err != nil {
            return err  // è¿”å›é”™è¯¯ä¼šè‡ªåŠ¨å›æ»š
        }

        if fromAccount.Balance < amount {
            return fmt.Errorf("ä½™é¢ä¸è¶³")  // è¿”å›é”™è¯¯ä¼šè‡ªåŠ¨å›æ»š
        }

        fromAccount.Balance -= amount
        if err := tx.Save(&fromAccount).Error; err != nil {
            return err  // è¿”å›é”™è¯¯ä¼šè‡ªåŠ¨å›æ»š
        }

        // å‘è´¦æˆ·Bè½¬è´¦
        var toAccount Account
        if err := tx.First(&toAccount, toID).Error; err != nil {
            return err
        }

        toAccount.Balance += amount
        if err := tx.Save(&toAccount).Error; err != nil {
            return err
        }

        return nil  // è¿”å›nilä¼šè‡ªåŠ¨æäº¤
    })
}
```

### 3.2 åµŒå¥—äº‹åŠ¡

```go
func ProcessOrder(db *gorm.DB, orderID uint) error {
    return db.Transaction(func(tx *gorm.DB) error {
        // æ›´æ–°è®¢å•çŠ¶æ€
        if err := tx.Model(&Order{}).Where("id = ?", orderID).Update("status", "processing").Error; err != nil {
            return err
        }

        // åµŒå¥—äº‹åŠ¡ï¼šå¤„ç†åº“å­˜
        return tx.Transaction(func(tx2 *gorm.DB) error {
            // åœ¨åµŒå¥—äº‹åŠ¡ä¸­æ“ä½œ
            return ProcessInventory(tx2, orderID)
        })
    })
}
```

---

## å››ã€äº‹åŠ¡éš”ç¦»çº§åˆ«

### 4.1 è®¾ç½®éš”ç¦»çº§åˆ«

```go
// è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«
db.Exec("SET TRANSACTION ISOLATION LEVEL READ COMMITTED")

tx := db.Begin()
// åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ
tx.Commit()
```

### 4.2 éš”ç¦»çº§åˆ«è¯´æ˜

| éš”ç¦»çº§åˆ« | è¯´æ˜ | é—®é¢˜ |
|---------|------|------|
| READ UNCOMMITTED | è¯»æœªæäº¤ | è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯» |
| READ COMMITTED | è¯»å·²æäº¤ | ä¸å¯é‡å¤è¯»ã€å¹»è¯» |
| REPEATABLE READ | å¯é‡å¤è¯» | å¹»è¯» |
| SERIALIZABLE | ä¸²è¡ŒåŒ– | æ— é—®é¢˜ï¼Œä½†æ€§èƒ½æœ€ä½ |

---

## äº”ã€ä¿å­˜ç‚¹ï¼ˆSavepointï¼‰

### 5.1 ä½¿ç”¨ä¿å­˜ç‚¹

ä¿å­˜ç‚¹å…è®¸åœ¨äº‹åŠ¡ä¸­åˆ›å»ºæ£€æŸ¥ç‚¹ï¼Œå¯ä»¥å›æ»šåˆ°ä¿å­˜ç‚¹ï¼š

```go
func ComplexOperation(db *gorm.DB) error {
    tx := db.Begin()
    defer func() {
        if r := recover(); r != nil {
            tx.Rollback()
        }
    }()

    // æ“ä½œ1
    if err := tx.Create(&user1).Error; err != nil {
        tx.Rollback()
        return err
    }

    // åˆ›å»ºä¿å­˜ç‚¹
    tx.Exec("SAVEPOINT sp1")

    // æ“ä½œ2ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
    if err := tx.Create(&user2).Error; err != nil {
        // å›æ»šåˆ°ä¿å­˜ç‚¹
        tx.Exec("ROLLBACK TO SAVEPOINT sp1")
        // ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œ
    }

    // æ“ä½œ3
    if err := tx.Create(&user3).Error; err != nil {
        tx.Rollback()
        return err
    }

    return tx.Commit().Error
}
```

---

## å…­ã€äº‹åŠ¡æœ€ä½³å®è·µ

### 6.1 äº‹åŠ¡èŒƒå›´

```go
// å¥½çš„åšæ³•ï¼šäº‹åŠ¡èŒƒå›´å°½å¯èƒ½å°
func UpdateUser(db *gorm.DB, userID uint, name string) error {
    return db.Transaction(func(tx *gorm.DB) error {
        return tx.Model(&User{}).Where("id = ?", userID).Update("name", name).Error
    })
}

// ä¸å¥½çš„åšæ³•ï¼šäº‹åŠ¡èŒƒå›´å¤ªå¤§
func ProcessEverything(db *gorm.DB) error {
    return db.Transaction(func(tx *gorm.DB) error {
        // å¤ªå¤šæ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¼šé•¿æ—¶é—´é”å®šèµ„æº
        // ...
    })
}
```

### 6.2 é”™è¯¯å¤„ç†

```go
func SafeTransaction(db *gorm.DB) error {
    return db.Transaction(func(tx *gorm.DB) error {
        // æ“ä½œ1
        if err := tx.Create(&user1).Error; err != nil {
            return fmt.Errorf("åˆ›å»ºç”¨æˆ·1å¤±è´¥: %w", err)  // åŒ…è£…é”™è¯¯
        }

        // æ“ä½œ2
        if err := tx.Create(&user2).Error; err != nil {
            return fmt.Errorf("åˆ›å»ºç”¨æˆ·2å¤±è´¥: %w", err)
        }

        return nil
    })
}
```

### 6.3 è¶…æ—¶å¤„ç†

```go
import (
    "context"
    "time"
)

func TransactionWithTimeout(db *gorm.DB) error {
    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
    defer cancel()

    return db.WithContext(ctx).Transaction(func(tx *gorm.DB) error {
        // åœ¨è¶…æ—¶æ—¶é—´å†…æ‰§è¡Œæ“ä½œ
        return tx.Create(&user).Error
    })
}
```

---

## ä¸ƒã€å®Œæ•´ç¤ºä¾‹

### 7.1 è®¢å•å¤„ç†ç³»ç»Ÿ

```go
package main

import (
    "fmt"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

type Order struct {
    ID     uint    `gorm:"primaryKey"`
    UserID uint
    Total  float64
    Status string
}

type OrderItem struct {
    ID        uint    `gorm:"primaryKey"`
    OrderID   uint
    ProductID uint
    Quantity  int
    Price     float64
}

type Product struct {
    ID      uint    `gorm:"primaryKey"`
    Name    string
    Stock   int
    Price   float64
}

func CreateOrder(db *gorm.DB, userID uint, items []struct {
    ProductID uint
    Quantity  int
}) (*Order, error) {
    var order *Order

    err := db.Transaction(func(tx *gorm.DB) error {
        // 1. åˆ›å»ºè®¢å•
        order = &Order{
            UserID: userID,
            Status: "pending",
        }
        if err := tx.Create(order).Error; err != nil {
            return fmt.Errorf("åˆ›å»ºè®¢å•å¤±è´¥: %w", err)
        }

        var total float64

        // 2. å¤„ç†è®¢å•é¡¹å’Œåº“å­˜
        for _, item := range items {
            // æŸ¥è¯¢äº§å“
            var product Product
            if err := tx.First(&product, item.ProductID).Error; err != nil {
                return fmt.Errorf("äº§å“ä¸å­˜åœ¨: %w", err)
            }

            // æ£€æŸ¥åº“å­˜
            if product.Stock < item.Quantity {
                return fmt.Errorf("äº§å“ %s åº“å­˜ä¸è¶³", product.Name)
            }

            // æ‰£å‡åº“å­˜
            product.Stock -= item.Quantity
            if err := tx.Save(&product).Error; err != nil {
                return fmt.Errorf("æ›´æ–°åº“å­˜å¤±è´¥: %w", err)
            }

            // åˆ›å»ºè®¢å•é¡¹
            orderItem := OrderItem{
                OrderID:   order.ID,
                ProductID: item.ProductID,
                Quantity:  item.Quantity,
                Price:     product.Price,
            }
            if err := tx.Create(&orderItem).Error; err != nil {
                return fmt.Errorf("åˆ›å»ºè®¢å•é¡¹å¤±è´¥: %w", err)
            }

            total += product.Price * float64(item.Quantity)
        }

        // 3. æ›´æ–°è®¢å•æ€»ä»·
        order.Total = total
        order.Status = "completed"
        if err := tx.Save(order).Error; err != nil {
            return fmt.Errorf("æ›´æ–°è®¢å•å¤±è´¥: %w", err)
        }

        return nil
    })

    if err != nil {
        return nil, err
    }

    return order, nil
}

func main() {
    db, _ := gorm.Open(sqlite.Open("orders.db"), &gorm.Config{})
    db.AutoMigrate(&Order{}, &OrderItem{}, &Product{})

    // åˆ›å»ºäº§å“
    product1 := Product{Name: "å•†å“1", Stock: 100, Price: 10.0}
    product2 := Product{Name: "å•†å“2", Stock: 50, Price: 20.0}
    db.Create(&product1)
    db.Create(&product2)

    // åˆ›å»ºè®¢å•
    items := []struct {
        ProductID uint
        Quantity  int
    }{
        {ProductID: product1.ID, Quantity: 2},
        {ProductID: product2.ID, Quantity: 1},
    }

    order, err := CreateOrder(db, 1, items)
    if err != nil {
        fmt.Printf("åˆ›å»ºè®¢å•å¤±è´¥: %v\n", err)
        return
    }

    fmt.Printf("è®¢å•åˆ›å»ºæˆåŠŸ: ID=%d, Total=%.2f\n", order.ID, order.Total)
}
```

---

## å…«ã€äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–

### 8.1 å‡å°‘äº‹åŠ¡æ—¶é—´

```go
// å¥½çš„åšæ³•ï¼šåœ¨äº‹åŠ¡å¤–å‡†å¤‡æ•°æ®
func EfficientTransaction(db *gorm.DB, userID uint) error {
    // åœ¨äº‹åŠ¡å¤–æŸ¥è¯¢æ•°æ®
    var user User
    db.First(&user, userID)

    // åœ¨äº‹åŠ¡å†…åªæ‰§è¡Œå†™æ“ä½œ
    return db.Transaction(func(tx *gorm.DB) error {
        user.Status = "active"
        return tx.Save(&user).Error
    })
}
```

### 8.2 æ‰¹é‡æ“ä½œ

```go
// ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘äº‹åŠ¡æ—¶é—´
func BatchCreate(db *gorm.DB, users []User) error {
    return db.Transaction(func(tx *gorm.DB) error {
        return tx.CreateInBatches(users, 100).Error
    })
}
```

---

## æ€»ç»“

### äº‹åŠ¡å¤„ç†è¦ç‚¹

1. **æ‰‹åŠ¨äº‹åŠ¡**ï¼š
   - ä½¿ç”¨`Begin()`å¼€å§‹äº‹åŠ¡
   - ä½¿ç”¨`Commit()`æäº¤äº‹åŠ¡
   - ä½¿ç”¨`Rollback()`å›æ»šäº‹åŠ¡
   - å§‹ç»ˆå¤„ç†é”™è¯¯

2. **è‡ªåŠ¨äº‹åŠ¡**ï¼š
   - ä½¿ç”¨`Transaction()`æ–¹æ³•
   - è¿”å›é”™è¯¯è‡ªåŠ¨å›æ»š
   - è¿”å›nilè‡ªåŠ¨æäº¤

3. **äº‹åŠ¡èŒƒå›´**ï¼š
   - ä¿æŒäº‹åŠ¡èŒƒå›´å°½å¯èƒ½å°
   - é¿å…é•¿æ—¶é—´é”å®šèµ„æº
   - åœ¨äº‹åŠ¡å¤–å‡†å¤‡æ•°æ®

4. **é”™è¯¯å¤„ç†**ï¼š
   - å§‹ç»ˆæ£€æŸ¥é”™è¯¯
   - ä½¿ç”¨deferç¡®ä¿å›æ»š
   - åŒ…è£…é”™è¯¯ä¿¡æ¯

### æœ€ä½³å®è·µ

1. **äº‹åŠ¡è®¾è®¡**ï¼š
   - åªå°†ç›¸å…³çš„æ“ä½œæ”¾åœ¨äº‹åŠ¡ä¸­
   - é¿å…åœ¨äº‹åŠ¡ä¸­è¿›è¡Œé•¿æ—¶é—´æ“ä½œ
   - ä½¿ç”¨ä¿å­˜ç‚¹å¤„ç†å¤æ‚åœºæ™¯

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å‡å°‘äº‹åŠ¡æ—¶é—´
   - ä½¿ç”¨æ‰¹é‡æ“ä½œ
   - åˆç†è®¾ç½®éš”ç¦»çº§åˆ«

3. **é”™è¯¯å¤„ç†**ï¼š
   - ä½¿ç”¨Transactionæ–¹æ³•ç®€åŒ–é”™è¯¯å¤„ç†
   - åŒ…è£…é”™è¯¯æä¾›ä¸Šä¸‹æ–‡
   - è®°å½•äº‹åŠ¡å¤±è´¥çš„åŸå› 

æŒæ¡äº‹åŠ¡å¤„ç†æ˜¯æ„å»ºå¯é åº”ç”¨çš„å…³é”®ã€‚åœ¨ä¸‹ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ GORMçš„é’©å­å‡½æ•°å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚