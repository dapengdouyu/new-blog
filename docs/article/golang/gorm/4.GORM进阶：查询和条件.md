---
title: 4ã€GORMè¿›é˜¶ï¼šæŸ¥è¯¢å’Œæ¡ä»¶
date: 2026-01-09
description: æ·±å…¥å­¦ä¹ GORMçš„æŸ¥è¯¢æ–¹æ³•ï¼ŒæŒæ¡å¤æ‚æŸ¥è¯¢æ¡ä»¶å’Œèšåˆæ“ä½œ
---

# 4ã€GORMè¿›é˜¶ï¼šæŸ¥è¯¢å’Œæ¡ä»¶

æœ¬æ–‡æ¡£æ·±å…¥è®²è§£GORMçš„æŸ¥è¯¢åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¤æ‚æ¡ä»¶æŸ¥è¯¢ã€èšåˆå‡½æ•°ã€åŸç”ŸSQLç­‰é«˜çº§ç‰¹æ€§ã€‚

## ğŸ¯ æœ¬è¯¾å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬è¯¾åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… æŒæ¡å„ç§æŸ¥è¯¢æ–¹æ³•å’Œæ¡ä»¶
- âœ… å­¦ä¼šä½¿ç”¨èšåˆå‡½æ•°å’Œåˆ†ç»„
- âœ… ç†è§£å­æŸ¥è¯¢å’Œè”åˆæŸ¥è¯¢
- âœ… æŒæ¡åŸç”ŸSQLçš„ä½¿ç”¨
- âœ… å­¦ä¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

---

## å‰ç½®çŸ¥è¯†

- **ç¬¬1-3è¯¾**ï¼šæŒæ¡GORMçš„åŸºç¡€æ“ä½œå’ŒCRUD

---

## ä¸€ã€é«˜çº§æŸ¥è¯¢æ–¹æ³•

### 1.1 æ¡ä»¶æŸ¥è¯¢

#### å­—ç¬¦ä¸²æ¡ä»¶

```go
var users []User

// ç­‰å€¼æŸ¥è¯¢
db.Where("name = ?", "å¼ ä¸‰").Find(&users)

// æ¯”è¾ƒæŸ¥è¯¢
db.Where("age > ?", 18).Find(&users)
db.Where("age >= ?", 18).Find(&users)
db.Where("age < ?", 30).Find(&users)
db.Where("age <= ?", 30).Find(&users)
db.Where("age <> ?", 25).Find(&users)

// INæŸ¥è¯¢
db.Where("name IN ?", []string{"å¼ ä¸‰", "æå››"}).Find(&users)

// LIKEæŸ¥è¯¢
db.Where("name LIKE ?", "%å¼ %").Find(&users)

// BETWEENæŸ¥è¯¢
db.Where("age BETWEEN ? AND ?", 20, 30).Find(&users)

// IS NULL / IS NOT NULL
db.Where("email IS NOT NULL").Find(&users)
```

#### ç»“æ„ä½“æ¡ä»¶

```go
var users []User

// ä½¿ç”¨ç»“æ„ä½“ä½œä¸ºæ¡ä»¶ï¼ˆåªä½¿ç”¨éé›¶å€¼å­—æ®µï¼‰
db.Where(&User{Name: "å¼ ä¸‰", Age: 25}).Find(&users)

// ä½¿ç”¨mapä½œä¸ºæ¡ä»¶
db.Where(map[string]interface{}{"name": "å¼ ä¸‰", "age": 25}).Find(&users)
```

#### åˆ‡ç‰‡æ¡ä»¶

```go
var users []User

// INæŸ¥è¯¢çš„ç®€åŒ–å†™æ³•
db.Where("name IN ?", []string{"å¼ ä¸‰", "æå››"}).Find(&users)
db.Find(&users, []int{1, 2, 3})  // æŸ¥è¯¢IDä¸º1,2,3çš„è®°å½•
```

### 1.2 é“¾å¼æŸ¥è¯¢

```go
var users []User

// é“¾å¼è°ƒç”¨æ„å»ºå¤æ‚æŸ¥è¯¢
db.Where("age > ?", 18).
   Where("name LIKE ?", "%å¼ %").
   Where("email IS NOT NULL").
   Order("age DESC").
   Limit(10).
   Offset(0).
   Find(&users)
```

### 1.3 Notæ¡ä»¶

```go
var users []User

// NOTæ¡ä»¶
db.Not("name = ?", "å¼ ä¸‰").Find(&users)
db.Not("name IN ?", []string{"å¼ ä¸‰", "æå››"}).Find(&users)
db.Not(User{Name: "å¼ ä¸‰"}).Find(&users)
```

### 1.4 Oræ¡ä»¶

```go
var users []User

// ORæ¡ä»¶
db.Where("age > ?", 30).Or("name LIKE ?", "%å¼ %").Find(&users)

// å¤šä¸ªORæ¡ä»¶
db.Where("age > ?", 30).
   Or(db.Where("name LIKE ?", "%å¼ %")).
   Or(db.Where("email LIKE ?", "%@gmail.com")).
   Find(&users)
```

---

## äºŒã€æ’åºå’Œåˆ†é¡µ

### 2.1 æ’åº

```go
var users []User

// å•å­—æ®µæ’åº
db.Order("age DESC").Find(&users)  // æŒ‰å¹´é¾„é™åº
db.Order("age ASC").Find(&users)    // æŒ‰å¹´é¾„å‡åº

// å¤šå­—æ®µæ’åº
db.Order("age DESC, name ASC").Find(&users)

// éšæœºæ’åº
db.Order("RAND()").Find(&users)

// æ¡ä»¶æ’åº
db.Order("CASE WHEN age < 18 THEN 1 ELSE 0 END").Find(&users)
```

### 2.2 åˆ†é¡µ

```go
var users []User

// åŸºç¡€åˆ†é¡µ
page := 1
pageSize := 10
offset := (page - 1) * pageSize

db.Offset(offset).Limit(pageSize).Find(&users)

// åˆ†é¡µå‡½æ•°
func Paginate(page, pageSize int) func(db *gorm.DB) *gorm.DB {
    return func(db *gorm.DB) *gorm.DB {
        offset := (page - 1) * pageSize
        return db.Offset(offset).Limit(pageSize)
    }
}

db.Scopes(Paginate(1, 10)).Find(&users)
```

### 2.3 é™åˆ¶å’Œåç§»

```go
var users []User

// é™åˆ¶æ•°é‡
db.Limit(10).Find(&users)

// åç§»é‡
db.Offset(10).Find(&users)

// ç»„åˆä½¿ç”¨
db.Limit(10).Offset(20).Find(&users)  // è·³è¿‡20æ¡ï¼Œå–10æ¡
```

---

## ä¸‰ã€é€‰æ‹©å­—æ®µ

### 3.1 SelectæŒ‡å®šå­—æ®µ

```go
var users []User

// é€‰æ‹©æŒ‡å®šå­—æ®µ
db.Select("name", "email").Find(&users)

// é€‰æ‹©å­—æ®µå¹¶è®¡ç®—
db.Select("name", "email", "age * 2 as double_age").Find(&users)
```

### 3.2 Omitæ’é™¤å­—æ®µ

```go
var users []User

// æ’é™¤æŒ‡å®šå­—æ®µ
db.Omit("password", "created_at", "updated_at").Find(&users)
```

### 3.3 å­—æ®µåˆ«å

```go
type Result struct {
    Name  string
    Email string
    Total int
}

var results []Result

// ä½¿ç”¨å­—æ®µåˆ«å
db.Model(&User{}).
   Select("name", "email", "count(*) as total").
   Group("name", "email").
   Find(&results)
```

---

## å››ã€èšåˆå‡½æ•°

### 4.1 Countè®¡æ•°

```go
var count int64

// ç»Ÿè®¡è®°å½•æ•°
db.Model(&User{}).Count(&count)

// æ¡ä»¶è®¡æ•°
db.Model(&User{}).Where("age > ?", 18).Count(&count)

// å»é‡è®¡æ•°
db.Model(&User{}).Distinct("name").Count(&count)
```

### 4.2 Sumæ±‚å’Œ

```go
var total int64

// æ±‚å’Œ
db.Model(&Order{}).Select("sum(total_price)").Scan(&total)

// æ¡ä»¶æ±‚å’Œ
db.Model(&Order{}).
   Where("status = ?", "completed").
   Select("sum(total_price)").Scan(&total)
```

### 4.3 Avgå¹³å‡å€¼

```go
var avg float64

// å¹³å‡å€¼
db.Model(&User{}).Select("avg(age)").Scan(&avg)
```

### 4.4 Maxå’ŒMin

```go
var maxAge, minAge int

// æœ€å¤§å€¼
db.Model(&User{}).Select("max(age)").Scan(&maxAge)

// æœ€å°å€¼
db.Model(&User{}).Select("min(age)").Scan(&minAge)
```

### 4.5 åˆ†ç»„æŸ¥è¯¢

```go
type Result struct {
    Status string
    Count  int64
}

var results []Result

// åˆ†ç»„ç»Ÿè®¡
db.Model(&Order{}).
   Select("status", "count(*) as count").
   Group("status").
   Find(&results)

// åˆ†ç»„å¹¶è¿‡æ»¤
db.Model(&Order{}).
   Select("status", "count(*) as count").
   Group("status").
   Having("count(*) > ?", 10).
   Find(&results)
```

---

## äº”ã€å­æŸ¥è¯¢

### 5.1 æ ‡é‡å­æŸ¥è¯¢

```go
var users []User

// å­æŸ¥è¯¢ä½œä¸ºæ¡ä»¶
db.Where("age > (?)", db.Model(&User{}).Select("avg(age)")).Find(&users)

// å­æŸ¥è¯¢ä½œä¸ºå­—æ®µ
db.Select("*", "(?) as avg_age", db.Model(&User{}).Select("avg(age)")).Find(&users)
```

### 5.2 EXISTSå­æŸ¥è¯¢

```go
var users []User

// EXISTSæŸ¥è¯¢
db.Where("EXISTS (?)", 
    db.Model(&Order{}).Select("1").Where("orders.user_id = users.id"),
).Find(&users)
```

### 5.3 INå­æŸ¥è¯¢

```go
var users []User

// INå­æŸ¥è¯¢
db.Where("id IN (?)", 
    db.Model(&Order{}).Select("user_id").Where("status = ?", "completed"),
).Find(&users)
```

---

## å…­ã€åŸç”ŸSQL

### 6.1 åŸç”ŸSQLæŸ¥è¯¢

```go
var users []User

// ä½¿ç”¨åŸç”ŸSQLæŸ¥è¯¢
db.Raw("SELECT * FROM users WHERE age > ?", 18).Scan(&users)

// æ‰§è¡ŒåŸç”ŸSQL
db.Exec("UPDATE users SET status = ? WHERE age < ?", "inactive", 18)
```

### 6.2 å‘½åå‚æ•°

```go
var users []User

// ä½¿ç”¨å‘½åå‚æ•°
db.Raw("SELECT * FROM users WHERE age > @age AND name LIKE @name",
    map[string]interface{}{
        "age":  18,
        "name": "%å¼ %",
    },
).Scan(&users)
```

### 6.3 åŸç”ŸSQLä¸GORMç»“åˆ

```go
var users []User

// åœ¨GORMæŸ¥è¯¢ä¸­ä½¿ç”¨åŸç”ŸSQL
db.Where("age > (?)", db.Raw("SELECT avg(age) FROM users")).Find(&users)

// ä½¿ç”¨åŸç”ŸSQLä½œä¸ºå­æŸ¥è¯¢
subQuery := db.Model(&Order{}).Select("user_id").Where("status = ?", "completed")
db.Where("id IN (?)", subQuery).Find(&users)
```

---

## ä¸ƒã€æŸ¥è¯¢ä¼˜åŒ–

### 7.1 é¢„åŠ è½½ä¼˜åŒ–

```go
// é¿å…N+1æŸ¥è¯¢é—®é¢˜
// ä¸å¥½çš„åšæ³•
var users []User
db.Find(&users)
for _, user := range users {
    db.Model(&user).Association("Orders").Find(&user.Orders)  // N+1æŸ¥è¯¢
}

// å¥½çš„åšæ³•ï¼šä½¿ç”¨é¢„åŠ è½½
db.Preload("Orders").Find(&users)
```

### 7.2 ç´¢å¼•ä½¿ç”¨

```go
// ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
type User struct {
    ID    uint   `gorm:"primaryKey"`
    Email string `gorm:"uniqueIndex"`  // å”¯ä¸€ç´¢å¼•
    Age   int    `gorm:"index"`         // æ™®é€šç´¢å¼•
    Name  string `gorm:"index:idx_name"` // å‘½åç´¢å¼•
}

// å¤åˆç´¢å¼•
db.Model(&User{}).AddIndex("idx_age_name", "age", "name")
```

### 7.3 æŸ¥è¯¢è®¡åˆ’

```go
// ä½¿ç”¨EXPLAINæŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’
db.Explain(db.Model(&User{}).Where("age > ?", 18))
```

### 7.4 åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ

```go
// åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
db.Select("id", "name", "email").Find(&users)
```

---

## å…«ã€å¤æ‚æŸ¥è¯¢ç¤ºä¾‹

### 8.1 å¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢

```go
func SearchUsers(db *gorm.DB, name string, minAge, maxAge int, status string) []User {
    var users []User
    query := db.Model(&User{})

    if name != "" {
        query = query.Where("name LIKE ?", "%"+name+"%")
    }

    if minAge > 0 {
        query = query.Where("age >= ?", minAge)
    }

    if maxAge > 0 {
        query = query.Where("age <= ?", maxAge)
    }

    if status != "" {
        query = query.Where("status = ?", status)
    }

    query.Order("created_at DESC").Find(&users)
    return users
}
```

### 8.2 ç»Ÿè®¡æŸ¥è¯¢

```go
type UserStats struct {
    TotalUsers    int64
    ActiveUsers   int64
    AvgAge        float64
    MaxAge        int
    MinAge        int
}

func GetUserStats(db *gorm.DB) UserStats {
    var stats UserStats

    db.Model(&User{}).Count(&stats.TotalUsers)
    db.Model(&User{}).Where("status = ?", "active").Count(&stats.ActiveUsers)
    db.Model(&User{}).Select("avg(age)").Scan(&stats.AvgAge)
    db.Model(&User{}).Select("max(age)").Scan(&stats.MaxAge)
    db.Model(&User{}).Select("min(age)").Scan(&stats.MinAge)

    return stats
}
```

### 8.3 åˆ†é¡µæŸ¥è¯¢å°è£…

```go
type Pagination struct {
    Page     int
    PageSize int
    Total    int64
    Data     interface{}
}

func PaginateQuery(db *gorm.DB, model interface{}, page, pageSize int) Pagination {
    var total int64
    db.Model(model).Count(&total)

    offset := (page - 1) * pageSize
    db.Offset(offset).Limit(pageSize).Find(model)

    return Pagination{
        Page:     page,
        PageSize: pageSize,
        Total:    total,
        Data:     model,
    }
}
```

---

## ä¹ã€æŸ¥è¯¢ç»“æœå¤„ç†

### 9.1 æ‰«æåˆ°ç»“æ„ä½“

```go
type UserInfo struct {
    Name  string
    Email string
    Age   int
}

var infos []UserInfo
db.Model(&User{}).Select("name", "email", "age").Find(&infos)
```

### 9.2 æ‰«æåˆ°Map

```go
var results []map[string]interface{}
db.Model(&User{}).Find(&results)

for _, result := range results {
    fmt.Printf("Name: %v, Email: %v\n", result["name"], result["email"])
}
```

### 9.3 æ¸¸æ ‡æŸ¥è¯¢

```go
// å¤„ç†å¤§é‡æ•°æ®æ—¶ä½¿ç”¨æ¸¸æ ‡
var users []User
db.Where("id > ?", lastID).Limit(100).Find(&users)
```

---

## æ€»ç»“

### æŸ¥è¯¢è¦ç‚¹

1. **æ¡ä»¶æŸ¥è¯¢**ï¼š
   - ä½¿ç”¨`Where`æ·»åŠ å„ç§æ¡ä»¶
   - æ”¯æŒå­—ç¬¦ä¸²ã€ç»“æ„ä½“ã€mapç­‰æ¡ä»¶
   - æ”¯æŒ`Not`ã€`Or`ç­‰é€»è¾‘æ“ä½œ

2. **æ’åºå’Œåˆ†é¡µ**ï¼š
   - `Order`æ§åˆ¶æ’åº
   - `Limit`å’Œ`Offset`å®ç°åˆ†é¡µ
   - å¯ä»¥ç»„åˆä½¿ç”¨

3. **èšåˆå‡½æ•°**ï¼š
   - `Count`ã€`Sum`ã€`Avg`ã€`Max`ã€`Min`
   - `Group By`å’Œ`Having`å®ç°åˆ†ç»„

4. **å­æŸ¥è¯¢**ï¼š
   - æ”¯æŒæ ‡é‡å­æŸ¥è¯¢
   - æ”¯æŒEXISTSå’ŒINå­æŸ¥è¯¢

5. **åŸç”ŸSQL**ï¼š
   - ä½¿ç”¨`Raw`æ‰§è¡ŒåŸç”ŸSQL
   - æ”¯æŒå‘½åå‚æ•°
   - å¯ä»¥ä¸GORMæŸ¥è¯¢ç»“åˆ

### æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
2. **é¢„åŠ è½½**ï¼šé¿å…N+1æŸ¥è¯¢é—®é¢˜
3. **å­—æ®µé€‰æ‹©**ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
4. **åˆ†é¡µ**ï¼šå¤§é‡æ•°æ®ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢

æŒæ¡è¿™äº›æŸ¥è¯¢æŠ€å·§åï¼Œä½ å°†èƒ½å¤Ÿå¤„ç†å„ç§å¤æ‚çš„æ•°æ®æ£€ç´¢éœ€æ±‚ã€‚åœ¨ä¸‹ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å…³è”å…³ç³»å’Œé¢„åŠ è½½ã€‚