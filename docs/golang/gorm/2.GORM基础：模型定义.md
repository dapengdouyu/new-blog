---
title: 2ã€GORMåŸºç¡€ï¼šæ¨¡å‹å®šä¹‰
date: 2026-01-09
description: æ·±å…¥å­¦ä¹ GORMæ¨¡å‹å®šä¹‰ï¼ŒæŒæ¡ç»“æ„ä½“æ ‡ç­¾å’Œæ•°æ®åº“è¿ç§»
---

# 2ã€GORMåŸºç¡€ï¼šæ¨¡å‹å®šä¹‰

æœ¬æ–‡æ¡£æ·±å…¥è®²è§£GORMæ¨¡å‹çš„å®šä¹‰æ–¹æ³•ï¼ŒåŒ…æ‹¬ç»“æ„ä½“æ ‡ç­¾ã€å­—æ®µç±»å‹æ˜ å°„å’Œæ•°æ®åº“è¿ç§»ã€‚

## ğŸ¯ æœ¬è¯¾å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬è¯¾åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… æŒæ¡GORMæ¨¡å‹çš„å®šä¹‰æ–¹æ³•
- âœ… ç†è§£ç»“æ„ä½“æ ‡ç­¾çš„ä½œç”¨
- âœ… å­¦ä¼šä½¿ç”¨GORMçš„å­—æ®µæ ‡ç­¾
- âœ… æŒæ¡æ•°æ®åº“è¿ç§»çš„åŸºæœ¬æ¦‚å¿µ
- âœ… ç†è§£å­—æ®µç±»å‹æ˜ å°„è§„åˆ™

---

## å‰ç½®çŸ¥è¯†

- **ç¬¬1è¯¾ï¼šGORMå…¥é—¨** - äº†è§£GORMçš„åŸºæœ¬æ¦‚å¿µå’Œè¿æ¥æ–¹æ³•

---

## ä¸€ã€æ¨¡å‹åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯æ¨¡å‹ï¼Ÿ

æ¨¡å‹ï¼ˆModelï¼‰æ˜¯GORMä¸­è¡¨ç¤ºæ•°æ®åº“è¡¨çš„ç»“æ„ä½“ã€‚æ¯ä¸ªæ¨¡å‹å¯¹åº”æ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨ï¼Œæ¨¡å‹çš„å­—æ®µå¯¹åº”è¡¨çš„åˆ—ã€‚

#### åŸºæœ¬æ¨¡å‹å®šä¹‰

```go
package main

import "gorm.io/gorm"

// User ç”¨æˆ·æ¨¡å‹
type User struct {
    ID    uint   // ä¸»é”®
    Name  string // å­—ç¬¦ä¸²å­—æ®µ
    Email string // å­—ç¬¦ä¸²å­—æ®µ
    Age   int    // æ•´æ•°å­—æ®µ
}
```

### 1.2 æ¨¡å‹çº¦å®š

GORMéµå¾ªä¸€äº›çº¦å®šï¼Œå‡å°‘é…ç½®ï¼š

1. **è¡¨å**ï¼šç»“æ„ä½“åçš„å¤æ•°å½¢å¼ï¼ˆå¦‚`User` â†’ `users`ï¼‰
2. **ä¸»é”®**ï¼šåä¸º`ID`çš„å­—æ®µè‡ªåŠ¨æˆä¸ºä¸»é”®
3. **æ—¶é—´æˆ³**ï¼š`CreatedAt`å’Œ`UpdatedAt`å­—æ®µè‡ªåŠ¨ç®¡ç†
4. **è½¯åˆ é™¤**ï¼š`DeletedAt`å­—æ®µå®ç°è½¯åˆ é™¤

---

## äºŒã€GORMæ ‡ç­¾

### 2.1 æ ‡ç­¾è¯­æ³•

GORMä½¿ç”¨ç»“æ„ä½“æ ‡ç­¾ï¼ˆStruct Tagsï¼‰æ¥å®šä¹‰å­—æ®µçš„æ•°æ®åº“å±æ€§ï¼š

```go
type User struct {
    ID    uint   `gorm:"primaryKey"`
    Name  string `gorm:"size:100;not null"`
    Email string `gorm:"uniqueIndex;not null"`
}
```

### 2.2 å¸¸ç”¨æ ‡ç­¾

#### ä¸»é”®ç›¸å…³

```go
type User struct {
    ID       uint   `gorm:"primaryKey"`              // ä¸»é”®
    UUID     string `gorm:"primaryKey;type:uuid"`     // UUIDä¸»é”®
    Code     string `gorm:"primaryKey;size:50"`      // å­—ç¬¦ä¸²ä¸»é”®
    AutoIncrement int `gorm:"primaryKey;autoIncrement"` // è‡ªå¢ä¸»é”®
}
```

#### å­—æ®µç±»å‹å’Œå¤§å°

```go
type User struct {
    Name     string `gorm:"type:varchar(100)"`        // æŒ‡å®šç±»å‹
    Bio      string `gorm:"type:text"`               // æ–‡æœ¬ç±»å‹
    Age      int    `gorm:"type:tinyint"`            // å°æ•´æ•°
    Balance  float64 `gorm:"type:decimal(10,2)"`     // ç²¾ç¡®å°æ•°
    Created  time.Time `gorm:"type:datetime"`         // æ—¥æœŸæ—¶é—´
}
```

#### çº¦æŸ

```go
type User struct {
    Email    string `gorm:"uniqueIndex"`             // å”¯ä¸€ç´¢å¼•
    Username string `gorm:"uniqueIndex:idx_username"` // å‘½åå”¯ä¸€ç´¢å¼•
    Name     string `gorm:"not null"`                // éç©ºçº¦æŸ
    Age      int    `gorm:"default:0"`               // é»˜è®¤å€¼
    Status   string `gorm:"default:'active'"`        // å­—ç¬¦ä¸²é»˜è®¤å€¼
}
```

#### ç´¢å¼•

```go
type User struct {
    Email    string `gorm:"index"`                    // æ™®é€šç´¢å¼•
    Name     string `gorm:"index:idx_name"`          // å‘½åç´¢å¼•
    Age      int    `gorm:"index:idx_age"`           // å¹´é¾„ç´¢å¼•
    Email    string `gorm:"uniqueIndex:idx_email"`   // å”¯ä¸€ç´¢å¼•
    // å¤åˆç´¢å¼•
    // db.Model(&User{}).AddIndex("idx_name_age", "name", "age")
}
```

#### åˆ—åæ˜ å°„

```go
type User struct {
    ID        uint   `gorm:"column:user_id"`          // è‡ªå®šä¹‰åˆ—å
    FirstName string `gorm:"column:first_name"`      // è›‡å½¢å‘½å
    LastName  string `gorm:"column:last_name"`       // è›‡å½¢å‘½å
}
```

---

## ä¸‰ã€å­—æ®µç±»å‹æ˜ å°„

### 3.1 Goç±»å‹åˆ°æ•°æ®åº“ç±»å‹

| Goç±»å‹ | æ•°æ®åº“ç±»å‹ï¼ˆMySQLï¼‰ | è¯´æ˜ |
|--------|-------------------|------|
| `string` | `varchar(255)` | å­—ç¬¦ä¸²ï¼Œé»˜è®¤255é•¿åº¦ |
| `int` | `int` | 32ä½æ•´æ•° |
| `int8` | `tinyint` | 8ä½æ•´æ•° |
| `int16` | `smallint` | 16ä½æ•´æ•° |
| `int32` | `int` | 32ä½æ•´æ•° |
| `int64` | `bigint` | 64ä½æ•´æ•° |
| `uint` | `int unsigned` | æ— ç¬¦å·æ•´æ•° |
| `float32` | `float` | å•ç²¾åº¦æµ®ç‚¹æ•° |
| `float64` | `double` | åŒç²¾åº¦æµ®ç‚¹æ•° |
| `bool` | `tinyint(1)` | å¸ƒå°”å€¼ |
| `time.Time` | `datetime` | æ—¥æœŸæ—¶é—´ |
| `[]byte` | `blob` | äºŒè¿›åˆ¶æ•°æ® |

### 3.2 è‡ªå®šä¹‰ç±»å‹

```go
package main

import (
    "database/sql/driver"
    "encoding/json"
    "errors"

    "gorm.io/gorm"
)

// JSONç±»å‹ï¼šå­˜å‚¨JSONæ•°æ®
type JSON json.RawMessage

// Value å®ç°driver.Valueræ¥å£
func (j JSON) Value() (driver.Value, error) {
    if len(j) == 0 {
        return nil, nil
    }
    return json.RawMessage(j).MarshalJSON()
}

// Scan å®ç°sql.Scanneræ¥å£
func (j *JSON) Scan(value interface{}) error {
    if value == nil {
        *j = nil
        return nil
    }
    bytes, ok := value.([]byte)
    if !ok {
        return errors.New("æ— æ³•æ‰«æJSONç±»å‹")
    }
    return json.Unmarshal(bytes, j)
}

// User ç”¨æˆ·æ¨¡å‹
type User struct {
    ID      uint   `gorm:"primaryKey"`
    Name    string
    Profile JSON   `gorm:"type:json"`  // ä½¿ç”¨è‡ªå®šä¹‰JSONç±»å‹
}
```

### 3.3 æ—¶é—´ç±»å‹

```go
package main

import (
    "time"
    "gorm.io/gorm"
)

type User struct {
    ID        uint      `gorm:"primaryKey"`
    Name      string
    CreatedAt time.Time // è‡ªåŠ¨ç®¡ç†åˆ›å»ºæ—¶é—´
    UpdatedAt time.Time // è‡ªåŠ¨ç®¡ç†æ›´æ–°æ—¶é—´
    DeletedAt gorm.DeletedAt `gorm:"index"` // è½¯åˆ é™¤æ—¶é—´
}
```

#### æ—¶é—´å­—æ®µçš„è‡ªåŠ¨ç®¡ç†

```go
// GORMä¼šè‡ªåŠ¨ç®¡ç†CreatedAtå’ŒUpdatedAt
user := User{Name: "å¼ ä¸‰"}
db.Create(&user)  // CreatedAtå’ŒUpdatedAtè‡ªåŠ¨è®¾ç½®

user.Name = "æå››"
db.Save(&user)    // UpdatedAtè‡ªåŠ¨æ›´æ–°
```

---

## å››ã€æ•°æ®åº“è¿ç§»

### 4.1 AutoMigrate

`AutoMigrate`ä¼šæ ¹æ®æ¨¡å‹è‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–°è¡¨ç»“æ„ï¼š

```go
package main

import (
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

type User struct {
    ID    uint   `gorm:"primaryKey"`
    Name  string
    Email string `gorm:"uniqueIndex"`
}

func main() {
    db, _ := gorm.Open(sqlite.Open("test.db"), &gorm.Config{})

    // è‡ªåŠ¨è¿ç§»ï¼šåˆ›å»ºè¡¨æˆ–æ›´æ–°è¡¨ç»“æ„
    db.AutoMigrate(&User{})
}
```

#### è¿ç§»å¤šä¸ªæ¨¡å‹

```go
// è¿ç§»å¤šä¸ªæ¨¡å‹
db.AutoMigrate(&User{}, &Product{}, &Order{})
```

### 4.2 è¿ç§»é€‰é¡¹

```go
// åªåˆ›å»ºè¡¨ï¼Œä¸æ›´æ–°
db.AutoMigrate(&User{})

// è¿ç§»æ—¶ç¦ç”¨å¤–é”®çº¦æŸ
db, _ := gorm.Open(mysql.Open(dsn), &gorm.Config{
    DisableForeignKeyConstraintWhenMigrating: true,
})
db.AutoMigrate(&User{})
```

### 4.3 æ‰‹åŠ¨è¿ç§»

```go
// åˆ›å»ºè¡¨
db.Migrator().CreateTable(&User{})

// æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
if db.Migrator().HasTable(&User{}) {
    fmt.Println("è¡¨å·²å­˜åœ¨")
}

// åˆ é™¤è¡¨
db.Migrator().DropTable(&User{})

// æ·»åŠ åˆ—
db.Migrator().AddColumn(&User{}, "Phone")

// åˆ é™¤åˆ—
db.Migrator().DropColumn(&User{}, "Phone")

// ä¿®æ”¹åˆ—
db.Migrator().AlterColumn(&User{}, "Name")
```

---

## äº”ã€æ¨¡å‹ç¤ºä¾‹

### 5.1 ç”¨æˆ·æ¨¡å‹

```go
package main

import (
    "time"
    "gorm.io/gorm"
)

// User ç”¨æˆ·æ¨¡å‹
type User struct {
    ID        uint           `gorm:"primaryKey;autoIncrement"`
    UUID      string         `gorm:"type:char(36);uniqueIndex;not null"`
    Username  string         `gorm:"type:varchar(50);uniqueIndex;not null"`
    Email     string         `gorm:"type:varchar(255);uniqueIndex;not null"`
    Password  string         `gorm:"type:varchar(255);not null"`
    FirstName string         `gorm:"type:varchar(100)"`
    LastName  string         `gorm:"type:varchar(100)"`
    Age       int            `gorm:"type:tinyint;default:0"`
    Status    string         `gorm:"type:varchar(20);default:'active'"`
    Bio       string         `gorm:"type:text"`
    Avatar    string         `gorm:"type:varchar(500)"`
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt `gorm:"index"`
}
```

### 5.2 äº§å“æ¨¡å‹

```go
package main

import (
    "time"
    "gorm.io/gorm"
)

// Product äº§å“æ¨¡å‹
type Product struct {
    ID          uint           `gorm:"primaryKey"`
    Code        string         `gorm:"type:varchar(50);uniqueIndex;not null"`
    Name        string         `gorm:"type:varchar(200);not null"`
    Description string         `gorm:"type:text"`
    Price       float64        `gorm:"type:decimal(10,2);not null"`
    Stock       int            `gorm:"type:int;default:0"`
    CategoryID  uint           `gorm:"index"`
    Status      string         `gorm:"type:varchar(20);default:'active'"`
    CreatedAt   time.Time
    UpdatedAt   time.Time
    DeletedAt   gorm.DeletedAt `gorm:"index"`
}
```

### 5.3 è®¢å•æ¨¡å‹

```go
package main

import (
    "time"
    "gorm.io/gorm"
)

// Order è®¢å•æ¨¡å‹
type Order struct {
    ID         uint           `gorm:"primaryKey"`
    OrderNo    string         `gorm:"type:varchar(50);uniqueIndex;not null"`
    UserID     uint           `gorm:"index;not null"`
    TotalPrice float64        `gorm:"type:decimal(10,2);not null"`
    Status     string         `gorm:"type:varchar(20);default:'pending'"`
    Remark     string         `gorm:"type:text"`
    CreatedAt  time.Time
    UpdatedAt  time.Time
    DeletedAt  gorm.DeletedAt `gorm:"index"`
}
```

---

## å…­ã€é«˜çº§æ ‡ç­¾ç”¨æ³•

### 6.1 å¤åˆç´¢å¼•

```go
type User struct {
    ID       uint
    FirstName string
    LastName  string
    Email     string
}

// åˆ›å»ºå¤åˆç´¢å¼•
db.Model(&User{}).AddIndex("idx_name", "first_name", "last_name")
```

### 6.2 å¤–é”®çº¦æŸ

```go
type User struct {
    ID   uint   `gorm:"primaryKey"`
    Name string
}

type Order struct {
    ID     uint   `gorm:"primaryKey"`
    UserID uint   `gorm:"index"`
    User   User   `gorm:"foreignKey:UserID;references:ID"` // å¤–é”®å…³è”
    Total  float64
}
```

### 6.3 å­—æ®µå¿½ç•¥

```go
type User struct {
    ID       uint   `gorm:"primaryKey"`
    Name     string
    Password string `gorm:"-"`  // å¿½ç•¥æ­¤å­—æ®µï¼Œä¸æ˜ å°„åˆ°æ•°æ®åº“
}
```

### 6.4 å­—æ®µæƒé™

```go
type User struct {
    ID       uint   `gorm:"primaryKey"`
    Name     string
    Email    string
    Password string `gorm:"->:false;<-:create"` // åªå…è®¸åˆ›å»ºæ—¶å†™å…¥ï¼Œä¸å…è®¸è¯»å–
}
```

---

## ä¸ƒã€å‘½åç­–ç•¥

### 7.1 è¡¨åç­–ç•¥

```go
import (
    "gorm.io/gorm"
    "gorm.io/gorm/schema"
)

// è‡ªå®šä¹‰å‘½åç­–ç•¥
db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
    NamingStrategy: schema.NamingStrategy{
        TablePrefix:   "t_",      // è¡¨å‰ç¼€
        SingularTable: true,      // ä½¿ç”¨å•æ•°è¡¨å
        NameReplacer:  strings.NewReplacer("CID", "Cid"), // åç§°æ›¿æ¢
    },
})
```

### 7.2 åˆ—åç­–ç•¥

```go
// é»˜è®¤ï¼šé©¼å³°å‘½åè½¬è›‡å½¢å‘½å
// UserName -> user_name

// è‡ªå®šä¹‰åˆ—å
type User struct {
    FirstName string `gorm:"column:first_name"`
    LastName  string `gorm:"column:last_name"`
}
```

---

## å…«ã€æ¨¡å‹éªŒè¯

### 8.1 å­—æ®µéªŒè¯

```go
type User struct {
    ID    uint   `gorm:"primaryKey"`
    Email string `gorm:"uniqueIndex;not null"`
    Age   int    `gorm:"check:age > 0"`  // æ£€æŸ¥çº¦æŸï¼ˆéƒ¨åˆ†æ•°æ®åº“æ”¯æŒï¼‰
}
```

### 8.2 æ¨¡å‹æ–¹æ³•éªŒè¯

```go
type User struct {
    ID    uint   `gorm:"primaryKey"`
    Email string `gorm:"uniqueIndex;not null"`
    Age   int
}

// BeforeCreate é’©å­ä¸­éªŒè¯
func (u *User) BeforeCreate(tx *gorm.DB) error {
    if u.Age < 0 {
        return errors.New("å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°")
    }
    return nil
}
```

---

## ä¹ã€å®Œæ•´ç¤ºä¾‹

### 9.1 å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿæ¨¡å‹

```go
package main

import (
    "time"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

// User ç”¨æˆ·æ¨¡å‹
type User struct {
    ID        uint           `gorm:"primaryKey;autoIncrement"`
    UUID      string         `gorm:"type:char(36);uniqueIndex;not null"`
    Username  string         `gorm:"type:varchar(50);uniqueIndex;not null"`
    Email     string         `gorm:"type:varchar(255);uniqueIndex;not null"`
    Password  string         `gorm:"type:varchar(255);not null"`
    FirstName string         `gorm:"type:varchar(100)"`
    LastName  string         `gorm:"type:varchar(100)"`
    Age       int            `gorm:"type:tinyint;default:0"`
    Status    string         `gorm:"type:varchar(20);default:'active';index"`
    Bio       string         `gorm:"type:text"`
    Avatar    string         `gorm:"type:varchar(500)"`
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt `gorm:"index"`
}

func main() {
    db, _ := gorm.Open(sqlite.Open("users.db"), &gorm.Config{})

    // è‡ªåŠ¨è¿ç§»
    db.AutoMigrate(&User{})

    // åˆ›å»ºç”¨æˆ·
    user := User{
        UUID:     "550e8400-e29b-41d4-a716-446655440000",
        Username: "zhangsan",
        Email:    "zhangsan@example.com",
        Password: "hashed_password",
        FirstName: "ä¸‰",
        LastName:  "å¼ ",
        Age:       25,
        Status:    "active",
    }

    db.Create(&user)
    fmt.Printf("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: %+v\n", user)
}
```

---

## æ€»ç»“

### æ¨¡å‹å®šä¹‰è¦ç‚¹

1. **ç»“æ„ä½“å®šä¹‰**ï¼š
   - ä½¿ç”¨ç»“æ„ä½“è¡¨ç¤ºæ•°æ®åº“è¡¨
   - å­—æ®µå¯¹åº”è¡¨çš„åˆ—
   - ä½¿ç”¨æ ‡ç­¾å®šä¹‰æ•°æ®åº“å±æ€§

2. **GORMæ ‡ç­¾**ï¼š
   - `primaryKey`ï¼šä¸»é”®
   - `uniqueIndex`ï¼šå”¯ä¸€ç´¢å¼•
   - `not null`ï¼šéç©ºçº¦æŸ
   - `default`ï¼šé»˜è®¤å€¼
   - `type`ï¼šå­—æ®µç±»å‹
   - `size`ï¼šå­—æ®µå¤§å°

3. **ç±»å‹æ˜ å°„**ï¼š
   - Goç±»å‹è‡ªåŠ¨æ˜ å°„åˆ°æ•°æ®åº“ç±»å‹
   - å¯ä»¥è‡ªå®šä¹‰ç±»å‹å’Œåºåˆ—åŒ–
   - æ—¶é—´ç±»å‹è‡ªåŠ¨ç®¡ç†

4. **æ•°æ®åº“è¿ç§»**ï¼š
   - ä½¿ç”¨`AutoMigrate`è‡ªåŠ¨åˆ›å»ºå’Œæ›´æ–°è¡¨
   - æ”¯æŒæ‰‹åŠ¨è¿ç§»æ“ä½œ
   - å¯ä»¥ç¦ç”¨å¤–é”®çº¦æŸ

### æœ€ä½³å®è·µ

1. **æ¨¡å‹è®¾è®¡**ï¼š
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„å­—æ®µå
   - åˆç†è®¾ç½®å­—æ®µç±»å‹å’Œå¤§å°
   - æ·»åŠ å¿…è¦çš„ç´¢å¼•å’Œçº¦æŸ

2. **æ ‡ç­¾ä½¿ç”¨**ï¼š
   - æ˜ç¡®æŒ‡å®šä¸»é”®
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
   - è®¾ç½®åˆç†çš„é»˜è®¤å€¼

3. **è¿ç§»ç®¡ç†**ï¼š
   - å¼€å‘ç¯å¢ƒä½¿ç”¨AutoMigrate
   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¿ç§»è„šæœ¬
   - å®šæœŸå¤‡ä»½æ•°æ®åº“

æŒæ¡æ¨¡å‹å®šä¹‰æ˜¯ä½¿ç”¨GORMçš„åŸºç¡€ã€‚åœ¨ä¸‹ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨è¿™äº›æ¨¡å‹è¿›è¡ŒCRUDæ“ä½œã€‚