---
title: 7ã€GORMé«˜çº§ï¼šé’©å­å‡½æ•°
date: 2026-01-09
description: æ·±å…¥å­¦ä¹ GORMçš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œåœ¨æ•°æ®æ“ä½œå‰åæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
---

# 7ã€GORMé«˜çº§ï¼šé’©å­å‡½æ•°

æœ¬æ–‡æ¡£æ·±å…¥è®²è§£GORMçš„é’©å­å‡½æ•°ï¼ˆHooksï¼‰ï¼Œé’©å­å‡½æ•°å…è®¸åœ¨æ•°æ®æ“ä½œçš„ç‰¹å®šé˜¶æ®µæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚

## ğŸ¯ æœ¬è¯¾å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬è¯¾åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ç†è§£GORMçš„ç”Ÿå‘½å‘¨æœŸé’©å­
- âœ… æŒæ¡åˆ›å»ºç›¸å…³çš„é’©å­å‡½æ•°
- âœ… æŒæ¡æ›´æ–°ç›¸å…³çš„é’©å­å‡½æ•°
- âœ… æŒæ¡åˆ é™¤ç›¸å…³çš„é’©å­å‡½æ•°
- âœ… æŒæ¡æŸ¥è¯¢ç›¸å…³çš„é’©å­å‡½æ•°
- âœ… ç†è§£é’©å­çš„æ‰§è¡Œé¡ºåº

---

## å‰ç½®çŸ¥è¯†

- **ç¬¬1-6è¯¾**ï¼šæŒæ¡GORMçš„åŸºç¡€æ“ä½œå’Œäº‹åŠ¡å¤„ç†

---

## ä¸€ã€é’©å­å‡½æ•°åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯é’©å­å‡½æ•°ï¼Ÿ

é’©å­å‡½æ•°ï¼ˆHooksï¼‰æ˜¯åœ¨æ¨¡å‹ç”Ÿå‘½å‘¨æœŸç‰¹å®šé˜¶æ®µè‡ªåŠ¨è°ƒç”¨çš„æ–¹æ³•ã€‚GORMæ”¯æŒä»¥ä¸‹é’©å­ï¼š

**åˆ›å»ºç›¸å…³**ï¼š
- `BeforeCreate`ï¼šåˆ›å»ºå‰
- `AfterCreate`ï¼šåˆ›å»ºå

**æ›´æ–°ç›¸å…³**ï¼š
- `BeforeUpdate`ï¼šæ›´æ–°å‰
- `AfterUpdate`ï¼šæ›´æ–°å
- `BeforeSave`ï¼šä¿å­˜å‰ï¼ˆåˆ›å»ºå’Œæ›´æ–°ï¼‰
- `AfterSave`ï¼šä¿å­˜åï¼ˆåˆ›å»ºå’Œæ›´æ–°ï¼‰

**åˆ é™¤ç›¸å…³**ï¼š
- `BeforeDelete`ï¼šåˆ é™¤å‰
- `AfterDelete`ï¼šåˆ é™¤å

**æŸ¥è¯¢ç›¸å…³**ï¼š
- `AfterFind`ï¼šæŸ¥è¯¢å

### 1.2 é’©å­å‡½æ•°ç­¾å

æ‰€æœ‰é’©å­å‡½æ•°éƒ½æ¥æ”¶`*gorm.DB`å‚æ•°ï¼Œå¯ä»¥è¿”å›`error`ï¼š

```go
func (u *User) BeforeCreate(tx *gorm.DB) error {
    // åˆ›å»ºå‰çš„é€»è¾‘
    return nil
}
```

---

## äºŒã€åˆ›å»ºç›¸å…³é’©å­

### 2.1 BeforeCreate

åœ¨åˆ›å»ºè®°å½•ä¹‹å‰æ‰§è¡Œï¼š

```go
package main

import (
    "time"
    "gorm.io/gorm"
)

type User struct {
    ID        uint      `gorm:"primaryKey"`
    UUID      string
    Name      string
    Email     string
    CreatedAt time.Time
}

// BeforeCreate åˆ›å»ºå‰é’©å­
func (u *User) BeforeCreate(tx *gorm.DB) error {
    // ç”ŸæˆUUID
    if u.UUID == "" {
        u.UUID = generateUUID()
    }

    // éªŒè¯æ•°æ®
    if u.Email == "" {
        return fmt.Errorf("é‚®ç®±ä¸èƒ½ä¸ºç©º")
    }

    // è®¾ç½®åˆ›å»ºæ—¶é—´
    u.CreatedAt = time.Now()

    return nil
}

func generateUUID() string {
    // UUIDç”Ÿæˆé€»è¾‘
    return "uuid-string"
}
```

### 2.2 AfterCreate

åœ¨åˆ›å»ºè®°å½•ä¹‹åæ‰§è¡Œï¼š

```go
// AfterCreate åˆ›å»ºåé’©å­
func (u *User) AfterCreate(tx *gorm.DB) error {
    // å‘é€æ¬¢è¿é‚®ä»¶
    sendWelcomeEmail(u.Email)

    // è®°å½•æ—¥å¿—
    log.Printf("æ–°ç”¨æˆ·åˆ›å»º: %s (ID: %d)", u.Name, u.ID)

    return nil
}
```

### 2.3 å®Œæ•´ç¤ºä¾‹

```go
package main

import (
    "fmt"
    "log"
    "time"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

type User struct {
    ID        uint      `gorm:"primaryKey"`
    UUID      string
    Name      string
    Email     string
    CreatedAt time.Time
}

func (u *User) BeforeCreate(tx *gorm.DB) error {
    if u.UUID == "" {
        u.UUID = fmt.Sprintf("user-%d", time.Now().Unix())
    }
    u.CreatedAt = time.Now()
    log.Printf("å‡†å¤‡åˆ›å»ºç”¨æˆ·: %s", u.Name)
    return nil
}

func (u *User) AfterCreate(tx *gorm.DB) error {
    log.Printf("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: %s (UUID: %s)", u.Name, u.UUID)
    return nil
}

func main() {
    db, _ := gorm.Open(sqlite.Open("test.db"), &gorm.Config{})
    db.AutoMigrate(&User{})

    user := User{
        Name:  "å¼ ä¸‰",
        Email: "zhangsan@example.com",
    }

    db.Create(&user)
    fmt.Printf("ç”¨æˆ·: %+v\n", user)
}
```

---

## ä¸‰ã€æ›´æ–°ç›¸å…³é’©å­

### 3.1 BeforeUpdate

åœ¨æ›´æ–°è®°å½•ä¹‹å‰æ‰§è¡Œï¼š

```go
type User struct {
    ID        uint      `gorm:"primaryKey"`
    Name      string
    Email     string
    UpdatedAt time.Time
}

// BeforeUpdate æ›´æ–°å‰é’©å­
func (u *User) BeforeUpdate(tx *gorm.DB) error {
    // æ›´æ–°ä¿®æ”¹æ—¶é—´
    u.UpdatedAt = time.Now()

    // è®°å½•ä¿®æ”¹å†å²
    log.Printf("å‡†å¤‡æ›´æ–°ç”¨æˆ·: %d", u.ID)

    // éªŒè¯æ•°æ®
    if u.Email != "" && !isValidEmail(u.Email) {
        return fmt.Errorf("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    }

    return nil
}
```

### 3.2 AfterUpdate

åœ¨æ›´æ–°è®°å½•ä¹‹åæ‰§è¡Œï¼š

```go
// AfterUpdate æ›´æ–°åé’©å­
func (u *User) AfterUpdate(tx *gorm.DB) error {
    // å‘é€é€šçŸ¥
    sendUpdateNotification(u.ID)

    // è®°å½•æ—¥å¿—
    log.Printf("ç”¨æˆ·æ›´æ–°æˆåŠŸ: %d", u.ID)

    return nil
}
```

### 3.3 BeforeSaveå’ŒAfterSave

`BeforeSave`å’Œ`AfterSave`åœ¨åˆ›å»ºå’Œæ›´æ–°æ—¶éƒ½ä¼šæ‰§è¡Œï¼š

```go
// BeforeSave ä¿å­˜å‰é’©å­ï¼ˆåˆ›å»ºå’Œæ›´æ–°éƒ½ä¼šæ‰§è¡Œï¼‰
func (u *User) BeforeSave(tx *gorm.DB) error {
    // æ•°æ®éªŒè¯
    if u.Name == "" {
        return fmt.Errorf("ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    }

    // æ•°æ®åŠ å¯†ï¼ˆå¦‚å¯†ç ï¼‰
    if u.Password != "" {
        u.Password = hashPassword(u.Password)
    }

    return nil
}

// AfterSave ä¿å­˜åé’©å­ï¼ˆåˆ›å»ºå’Œæ›´æ–°éƒ½ä¼šæ‰§è¡Œï¼‰
func (u *User) AfterSave(tx *gorm.DB) error {
    // æ¸…é™¤æ•æ„Ÿæ•°æ®
    u.Password = ""

    return nil
}
```

### 3.4 æ›´æ–°é’©å­ç¤ºä¾‹

```go
package main

import (
    "fmt"
    "log"
    "time"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

type User struct {
    ID        uint      `gorm:"primaryKey"`
    Name      string
    Email     string
    UpdatedAt time.Time
}

func (u *User) BeforeUpdate(tx *gorm.DB) error {
    u.UpdatedAt = time.Now()
    log.Printf("å‡†å¤‡æ›´æ–°ç”¨æˆ·: %d", u.ID)
    return nil
}

func (u *User) AfterUpdate(tx *gorm.DB) error {
    log.Printf("ç”¨æˆ·æ›´æ–°æˆåŠŸ: %d", u.ID)
    return nil
}

func main() {
    db, _ := gorm.Open(sqlite.Open("test.db"), &gorm.Config{})
    db.AutoMigrate(&User{})

    // åˆ›å»ºç”¨æˆ·
    user := User{Name: "å¼ ä¸‰", Email: "zhangsan@example.com"}
    db.Create(&user)

    // æ›´æ–°ç”¨æˆ·
    user.Name = "æå››"
    db.Save(&user)
    fmt.Printf("æ›´æ–°å: %+v\n", user)
}
```

---

## å››ã€åˆ é™¤ç›¸å…³é’©å­

### 4.1 BeforeDelete

åœ¨åˆ é™¤è®°å½•ä¹‹å‰æ‰§è¡Œï¼š

```go
type User struct {
    ID        uint      `gorm:"primaryKey"`
    Name      string
    DeletedAt gorm.DeletedAt
}

// BeforeDelete åˆ é™¤å‰é’©å­
func (u *User) BeforeDelete(tx *gorm.DB) error {
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ é™¤
    if u.Name == "admin" {
        return fmt.Errorf("ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜ç”¨æˆ·")
    }

    // åˆ é™¤ç›¸å…³æ•°æ®
    tx.Model(&Order{}).Where("user_id = ?", u.ID).Delete(&Order{})

    // è®°å½•æ—¥å¿—
    log.Printf("å‡†å¤‡åˆ é™¤ç”¨æˆ·: %d", u.ID)

    return nil
}
```

### 4.2 AfterDelete

åœ¨åˆ é™¤è®°å½•ä¹‹åæ‰§è¡Œï¼š

```go
// AfterDelete åˆ é™¤åé’©å­
func (u *User) AfterDelete(tx *gorm.DB) error {
    // å‘é€é€šçŸ¥
    sendDeletionNotification(u.Email)

    // è®°å½•æ—¥å¿—
    log.Printf("ç”¨æˆ·åˆ é™¤æˆåŠŸ: %d", u.ID)

    return nil
}
```

### 4.3 è½¯åˆ é™¤é’©å­

```go
// è½¯åˆ é™¤æ—¶ï¼ŒBeforeDeleteå’ŒAfterDeleteä¹Ÿä¼šæ‰§è¡Œ
func (u *User) BeforeDelete(tx *gorm.DB) error {
    // è½¯åˆ é™¤å‰çš„é€»è¾‘
    log.Printf("å‡†å¤‡è½¯åˆ é™¤ç”¨æˆ·: %d", u.ID)
    return nil
}

func (u *User) AfterDelete(tx *gorm.DB) error {
    // è½¯åˆ é™¤åçš„é€»è¾‘
    log.Printf("ç”¨æˆ·è½¯åˆ é™¤æˆåŠŸ: %d", u.ID)
    return nil
}
```

---

## äº”ã€æŸ¥è¯¢ç›¸å…³é’©å­

### 5.1 AfterFind

åœ¨æŸ¥è¯¢è®°å½•ä¹‹åæ‰§è¡Œï¼š

```go
type User struct {
    ID        uint      `gorm:"primaryKey"`
    Name      string
    Password  string
    LastLogin time.Time
}

// AfterFind æŸ¥è¯¢åé’©å­
func (u *User) AfterFind(tx *gorm.DB) error {
    // æ¸…é™¤æ•æ„Ÿä¿¡æ¯
    u.Password = ""

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´ï¼ˆå¦‚æœéœ€è¦ï¼‰
    // u.LastLogin = time.Now()
    // tx.Save(u)

    // æ ¼å¼åŒ–æ•°æ®
    log.Printf("æŸ¥è¯¢åˆ°ç”¨æˆ·: %s (ID: %d)", u.Name, u.ID)

    return nil
}
```

### 5.2 AfterFindç¤ºä¾‹

```go
package main

import (
    "fmt"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

type User struct {
    ID       uint   `gorm:"primaryKey"`
    Name     string
    Password string
    Email    string
}

func (u *User) AfterFind(tx *gorm.DB) error {
    // æ¸…é™¤å¯†ç å­—æ®µ
    u.Password = ""
    return nil
}

func main() {
    db, _ := gorm.Open(sqlite.Open("test.db"), &gorm.Config{})
    db.AutoMigrate(&User{})

    // åˆ›å»ºç”¨æˆ·
    user := User{
        Name:     "å¼ ä¸‰",
        Password: "secret123",
        Email:    "zhangsan@example.com",
    }
    db.Create(&user)

    // æŸ¥è¯¢ç”¨æˆ·ï¼ˆAfterFindä¼šè‡ªåŠ¨æ¸…é™¤å¯†ç ï¼‰
    var foundUser User
    db.First(&foundUser, user.ID)
    fmt.Printf("ç”¨æˆ·: %+v\n", foundUser)  // Passwordå­—æ®µä¸ºç©º
}
```

---

## å…­ã€é’©å­æ‰§è¡Œé¡ºåº

### 6.1 åˆ›å»ºæ—¶çš„æ‰§è¡Œé¡ºåº

```
BeforeSave â†’ BeforeCreate â†’ åˆ›å»ºè®°å½• â†’ AfterCreate â†’ AfterSave
```

### 6.2 æ›´æ–°æ—¶çš„æ‰§è¡Œé¡ºåº

```
BeforeSave â†’ BeforeUpdate â†’ æ›´æ–°è®°å½• â†’ AfterUpdate â†’ AfterSave
```

### 6.3 åˆ é™¤æ—¶çš„æ‰§è¡Œé¡ºåº

```
BeforeDelete â†’ åˆ é™¤è®°å½• â†’ AfterDelete
```

### 6.4 æŸ¥è¯¢æ—¶çš„æ‰§è¡Œé¡ºåº

```
æŸ¥è¯¢è®°å½• â†’ AfterFind
```

### 6.5 å®Œæ•´ç¤ºä¾‹

```go
type User struct {
    ID   uint   `gorm:"primaryKey"`
    Name string
}

func (u *User) BeforeSave(tx *gorm.DB) error {
    fmt.Println("1. BeforeSave")
    return nil
}

func (u *User) BeforeCreate(tx *gorm.DB) error {
    fmt.Println("2. BeforeCreate")
    return nil
}

func (u *User) AfterCreate(tx *gorm.DB) error {
    fmt.Println("3. AfterCreate")
    return nil
}

func (u *User) AfterSave(tx *gorm.DB) error {
    fmt.Println("4. AfterSave")
    return nil
}

// åˆ›å»ºæ—¶çš„è¾“å‡ºï¼š
// 1. BeforeSave
// 2. BeforeCreate
// 3. AfterCreate
// 4. AfterSave
```

---

## ä¸ƒã€é’©å­ä¸­çš„é”™è¯¯å¤„ç†

### 7.1 è¿”å›é”™è¯¯

é’©å­å‡½æ•°è¿”å›é”™è¯¯ä¼šä¸­æ–­æ“ä½œï¼š

```go
func (u *User) BeforeCreate(tx *gorm.DB) error {
    if u.Email == "" {
        return fmt.Errorf("é‚®ç®±ä¸èƒ½ä¸ºç©º")  // è¿”å›é”™è¯¯ï¼Œåˆ›å»ºæ“ä½œä¼šè¢«å–æ¶ˆ
    }
    return nil
}

// ä½¿ç”¨
user := User{Name: "å¼ ä¸‰"}  // æ²¡æœ‰é‚®ç®±
err := db.Create(&user)
if err != nil {
    fmt.Printf("åˆ›å»ºå¤±è´¥: %v\n", err)  // ä¼šè¾“å‡ºï¼šåˆ›å»ºå¤±è´¥: é‚®ç®±ä¸èƒ½ä¸ºç©º
}
```

### 7.2 åœ¨é’©å­ä¸­ä½¿ç”¨äº‹åŠ¡

é’©å­å‡½æ•°ä¸­çš„æ“ä½œä¹Ÿåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼š

```go
func (u *User) AfterCreate(tx *gorm.DB) error {
    // åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­åˆ›å»ºç›¸å…³è®°å½•
    profile := Profile{
        UserID: u.ID,
        Bio:    "é»˜è®¤ç®€ä»‹",
    }
    return tx.Create(&profile).Error  // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡ä¼šå›æ»š
}
```

---

## å…«ã€å®é™…åº”ç”¨åœºæ™¯

### 8.1 æ•°æ®éªŒè¯

```go
type User struct {
    ID       uint   `gorm:"primaryKey"`
    Email    string
    Password string
}

func (u *User) BeforeSave(tx *gorm.DB) error {
    // éªŒè¯é‚®ç®±æ ¼å¼
    if u.Email != "" && !strings.Contains(u.Email, "@") {
        return fmt.Errorf("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    }

    // éªŒè¯å¯†ç å¼ºåº¦
    if u.Password != "" && len(u.Password) < 8 {
        return fmt.Errorf("å¯†ç é•¿åº¦è‡³å°‘8ä½")
    }

    return nil
}
```

### 8.2 æ•°æ®åŠ å¯†

```go
import "golang.org/x/crypto/bcrypt"

func (u *User) BeforeCreate(tx *gorm.DB) error {
    // åŠ å¯†å¯†ç 
    if u.Password != "" {
        hashedPassword, err := bcrypt.GenerateFromPassword([]byte(u.Password), bcrypt.DefaultCost)
        if err != nil {
            return err
        }
        u.Password = string(hashedPassword)
    }
    return nil
}
```

### 8.3 è‡ªåŠ¨å¡«å……å­—æ®µ

```go
type User struct {
    ID        uint      `gorm:"primaryKey"`
    UUID      string
    CreatedAt time.Time
    UpdatedAt time.Time
}

func (u *User) BeforeCreate(tx *gorm.DB) error {
    if u.UUID == "" {
        u.UUID = generateUUID()
    }
    u.CreatedAt = time.Now()
    u.UpdatedAt = time.Now()
    return nil
}

func (u *User) BeforeUpdate(tx *gorm.DB) error {
    u.UpdatedAt = time.Now()
    return nil
}
```

### 8.4 å®¡è®¡æ—¥å¿—

```go
type User struct {
    ID        uint      `gorm:"primaryKey"`
    Name      string
    CreatedBy uint
    UpdatedBy uint
}

func (u *User) BeforeCreate(tx *gorm.DB) error {
    // ä»ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ID
    if userID, ok := tx.Statement.Context.Value("user_id").(uint); ok {
        u.CreatedBy = userID
    }
    return nil
}

func (u *User) BeforeUpdate(tx *gorm.DB) error {
    // ä»ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ID
    if userID, ok := tx.Statement.Context.Value("user_id").(uint); ok {
        u.UpdatedBy = userID
    }
    return nil
}
```

### 8.5 å…³è”æ“ä½œ

```go
type Order struct {
    ID     uint      `gorm:"primaryKey"`
    UserID uint
    Items  []OrderItem
}

func (o *Order) AfterCreate(tx *gorm.DB) error {
    // åˆ›å»ºè®¢å•åï¼Œå‘é€é€šçŸ¥
    go sendOrderNotification(o.ID)
    return nil
}

func (o *Order) BeforeDelete(tx *gorm.DB) error {
    // åˆ é™¤è®¢å•å‰ï¼Œåˆ é™¤æ‰€æœ‰è®¢å•é¡¹
    return tx.Where("order_id = ?", o.ID).Delete(&OrderItem{}).Error
}
```

---

## ä¹ã€é’©å­æœ€ä½³å®è·µ

### 9.1 ä¿æŒé’©å­ç®€å•

```go
// å¥½çš„åšæ³•ï¼šé’©å­åªåšå¿…è¦çš„æ“ä½œ
func (u *User) BeforeCreate(tx *gorm.DB) error {
    u.UUID = generateUUID()
    return nil
}

// ä¸å¥½çš„åšæ³•ï¼šé’©å­ä¸­åšå¤ªå¤šäº‹æƒ…
func (u *User) BeforeCreate(tx *gorm.DB) error {
    u.UUID = generateUUID()
    sendEmail()  // ä¸åº”è¯¥åœ¨é’©å­ä¸­åšå¼‚æ­¥æ“ä½œ
    callExternalAPI()  // ä¸åº”è¯¥åœ¨é’©å­ä¸­è°ƒç”¨å¤–éƒ¨API
    return nil
}
```

### 9.2 é”™è¯¯å¤„ç†

```go
// å§‹ç»ˆè¿”å›é”™è¯¯
func (u *User) BeforeCreate(tx *gorm.DB) error {
    if u.Email == "" {
        return fmt.Errorf("é‚®ç®±ä¸èƒ½ä¸ºç©º")  // è¿”å›æ˜ç¡®çš„é”™è¯¯
    }
    return nil
}
```

### 9.3 é¿å…åœ¨é’©å­ä¸­ä¿®æ”¹æŸ¥è¯¢

```go
// ä¸å¥½çš„åšæ³•ï¼šåœ¨AfterFindä¸­ä¿®æ”¹æŸ¥è¯¢
func (u *User) AfterFind(tx *gorm.DB) error {
    tx.Model(u).Update("last_login", time.Now())  // å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯
    return nil
}

// å¥½çš„åšæ³•ï¼šåªåšæ•°æ®è½¬æ¢
func (u *User) AfterFind(tx *gorm.DB) error {
    u.Password = ""  // æ¸…é™¤æ•æ„Ÿä¿¡æ¯
    return nil
}
```

---

## åã€å®Œæ•´ç¤ºä¾‹

### 10.1 ç”¨æˆ·ç®¡ç†ç³»ç»Ÿé’©å­

```go
package main

import (
    "fmt"
    "log"
    "time"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

type User struct {
    ID        uint      `gorm:"primaryKey"`
    UUID      string
    Name      string
    Email     string
    Password  string
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt
}

// BeforeCreate åˆ›å»ºå‰
func (u *User) BeforeCreate(tx *gorm.DB) error {
    log.Printf("å‡†å¤‡åˆ›å»ºç”¨æˆ·: %s", u.Name)

    // ç”ŸæˆUUID
    if u.UUID == "" {
        u.UUID = fmt.Sprintf("user-%d", time.Now().Unix())
    }

    // éªŒè¯
    if u.Email == "" {
        return fmt.Errorf("é‚®ç®±ä¸èƒ½ä¸ºç©º")
    }

    // åŠ å¯†å¯†ç 
    if u.Password != "" {
        u.Password = hashPassword(u.Password)
    }

    u.CreatedAt = time.Now()
    u.UpdatedAt = time.Now()

    return nil
}

// AfterCreate åˆ›å»ºå
func (u *User) AfterCreate(tx *gorm.DB) error {
    log.Printf("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: %s (UUID: %s)", u.Name, u.UUID)
    // æ¸…é™¤å¯†ç ï¼ˆä¸åœ¨æ•°æ®åº“ä¸­å­˜å‚¨æ˜æ–‡ï¼‰
    u.Password = ""
    return nil
}

// BeforeUpdate æ›´æ–°å‰
func (u *User) BeforeUpdate(tx *gorm.DB) error {
    log.Printf("å‡†å¤‡æ›´æ–°ç”¨æˆ·: %d", u.ID)
    u.UpdatedAt = time.Now()

    // å¦‚æœå¯†ç è¢«æ›´æ–°ï¼Œé‡æ–°åŠ å¯†
    if tx.Statement.Changed("Password") {
        u.Password = hashPassword(u.Password)
    }

    return nil
}

// AfterUpdate æ›´æ–°å
func (u *User) AfterUpdate(tx *gorm.DB) error {
    log.Printf("ç”¨æˆ·æ›´æ–°æˆåŠŸ: %d", u.ID)
    u.Password = ""
    return nil
}

// BeforeDelete åˆ é™¤å‰
func (u *User) BeforeDelete(tx *gorm.DB) error {
    log.Printf("å‡†å¤‡åˆ é™¤ç”¨æˆ·: %d", u.ID)
    if u.Name == "admin" {
        return fmt.Errorf("ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜")
    }
    return nil
}

// AfterDelete åˆ é™¤å
func (u *User) AfterDelete(tx *gorm.DB) error {
    log.Printf("ç”¨æˆ·åˆ é™¤æˆåŠŸ: %d", u.ID)
    return nil
}

// AfterFind æŸ¥è¯¢å
func (u *User) AfterFind(tx *gorm.DB) error {
    // æ¸…é™¤æ•æ„Ÿä¿¡æ¯
    u.Password = ""
    return nil
}

func hashPassword(password string) string {
    // ç®€å•çš„å“ˆå¸Œç¤ºä¾‹ï¼ˆå®é™…åº”ä½¿ç”¨bcryptç­‰ï¼‰
    return "hashed_" + password
}

func main() {
    db, _ := gorm.Open(sqlite.Open("users.db"), &gorm.Config{})
    db.AutoMigrate(&User{})

    // åˆ›å»ºç”¨æˆ·
    user := User{
        Name:     "å¼ ä¸‰",
        Email:    "zhangsan@example.com",
        Password: "password123",
    }
    db.Create(&user)
    fmt.Printf("åˆ›å»ºå: %+v\n", user)

    // æ›´æ–°ç”¨æˆ·
    user.Name = "æå››"
    db.Save(&user)
    fmt.Printf("æ›´æ–°å: %+v\n", user)

    // æŸ¥è¯¢ç”¨æˆ·
    var foundUser User
    db.First(&foundUser, user.ID)
    fmt.Printf("æŸ¥è¯¢å: %+v\n", foundUser)
}
```

---

## æ€»ç»“

### é’©å­å‡½æ•°è¦ç‚¹

1. **åˆ›å»ºé’©å­**ï¼š
   - `BeforeCreate`ï¼šåˆ›å»ºå‰ï¼Œç”¨äºéªŒè¯å’Œåˆå§‹åŒ–
   - `AfterCreate`ï¼šåˆ›å»ºåï¼Œç”¨äºé€šçŸ¥å’Œæ—¥å¿—

2. **æ›´æ–°é’©å­**ï¼š
   - `BeforeUpdate`ï¼šæ›´æ–°å‰ï¼Œç”¨äºéªŒè¯å’Œä¿®æ”¹æ—¶é—´
   - `AfterUpdate`ï¼šæ›´æ–°åï¼Œç”¨äºé€šçŸ¥
   - `BeforeSave`/`AfterSave`ï¼šä¿å­˜å‰åï¼ˆåˆ›å»ºå’Œæ›´æ–°éƒ½æ‰§è¡Œï¼‰

3. **åˆ é™¤é’©å­**ï¼š
   - `BeforeDelete`ï¼šåˆ é™¤å‰ï¼Œç”¨äºæ£€æŸ¥å’Œæ¸…ç†
   - `AfterDelete`ï¼šåˆ é™¤åï¼Œç”¨äºé€šçŸ¥

4. **æŸ¥è¯¢é’©å­**ï¼š
   - `AfterFind`ï¼šæŸ¥è¯¢åï¼Œç”¨äºæ•°æ®è½¬æ¢å’Œæ¸…ç†

### æ‰§è¡Œé¡ºåº

- **åˆ›å»º**ï¼šBeforeSave â†’ BeforeCreate â†’ åˆ›å»º â†’ AfterCreate â†’ AfterSave
- **æ›´æ–°**ï¼šBeforeSave â†’ BeforeUpdate â†’ æ›´æ–° â†’ AfterUpdate â†’ AfterSave
- **åˆ é™¤**ï¼šBeforeDelete â†’ åˆ é™¤ â†’ AfterDelete
- **æŸ¥è¯¢**ï¼šæŸ¥è¯¢ â†’ AfterFind

### æœ€ä½³å®è·µ

1. **ä¿æŒç®€å•**ï¼šé’©å­åªåšå¿…è¦çš„æ“ä½œ
2. **é”™è¯¯å¤„ç†**ï¼šå§‹ç»ˆè¿”å›æ˜ç¡®çš„é”™è¯¯
3. **é¿å…å‰¯ä½œç”¨**ï¼šä¸è¦åœ¨é’©å­ä¸­åšå¼‚æ­¥æ“ä½œ
4. **æ•°æ®å®‰å…¨**ï¼šåœ¨é’©å­ä¸­å¤„ç†æ•æ„Ÿæ•°æ®

æŒæ¡é’©å­å‡½æ•°å¯ä»¥è®©ä½ åœ¨æ•°æ®æ“ä½œçš„å„ä¸ªé˜¶æ®µæ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼Œå®ç°æ›´çµæ´»çš„ä¸šåŠ¡å¤„ç†ã€‚åœ¨ä¸‹ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ GORMçš„é«˜çº§ç‰¹æ€§å’Œæ€§èƒ½ä¼˜åŒ–ã€‚