---
title: Nginx高级：安全配置
date: 2026-01-12
description: 学习如何配置Nginx安全策略，包括访问控制、限流、安全头等
---

# Nginx高级：安全配置

## 一、安全配置概述

### 1.1 Web服务器安全威胁

- **DDoS攻击**：大量请求导致服务不可用
- **SQL注入**：通过输入注入恶意SQL
- **XSS攻击**：跨站脚本攻击
- **CSRF攻击**：跨站请求伪造
- **目录遍历**：访问未授权文件
- **信息泄露**：暴露服务器信息

### 1.2 Nginx安全配置目标

- **防止未授权访问**
- **限制请求频率**
- **隐藏服务器信息**
- **保护敏感数据**
- **防止常见攻击**

## 二、隐藏服务器信息

### 2.1 隐藏Nginx版本

```nginx
http {
    # 隐藏Nginx版本号
    server_tokens off;
}
```

### 2.2 自定义错误页面

```nginx
server {
    # 自定义404错误页面
    error_page 404 /404.html;
    location = /404.html {
        root /var/www/html;
        internal;  # 只能内部访问
    }
    
    # 自定义50x错误页面
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /var/www/html;
        internal;
    }
}
```

### 2.3 禁用不必要的HTTP方法

```nginx
server {
    # 只允许GET、HEAD、POST方法
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
        return 405;
    }
}
```

## 三、访问控制

### 3.1 IP白名单和黑名单

```nginx
server {
    # 允许特定IP
    location /admin {
        allow 192.168.1.100;
        allow 10.0.0.0/8;
        deny all;
    }
    
    # 拒绝特定IP
    location / {
        deny 192.168.1.200;
        deny 10.0.0.100;
        allow all;
    }
}
```

### 3.2 基于地理位置限制

```nginx
# 需要geoip模块
http {
    geoip_country /usr/share/GeoIP/GeoIP.dat;
    
    map $geoip_country_code $allowed_country {
        default 0;
        CN 1;  # 允许中国
        US 1;  # 允许美国
    }
    
    server {
        if ($allowed_country = 0) {
            return 403;
        }
    }
}
```

### 3.3 用户认证（Basic Auth）

```bash
# 创建密码文件
sudo apt install apache2-utils  # Ubuntu/Debian
sudo htpasswd -c /etc/nginx/.htpasswd username
```

```nginx
server {
    location /admin {
        auth_basic "Restricted Area";
        auth_basic_user_file /etc/nginx/.htpasswd;
    }
}
```

## 四、限流配置

### 4.1 请求频率限制（limit_req）

```nginx
http {
    # 定义限流区域
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=1r/s;
    
    server {
        # API限流（每秒10个请求）
        location /api {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://backend;
        }
        
        # 登录限流（每秒1个请求）
        location /login {
            limit_req zone=login_limit burst=5 nodelay;
            proxy_pass http://backend;
        }
    }
}
```

### 4.2 连接数限制（limit_conn）

```nginx
http {
    # 定义连接限制区域
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    
    server {
        # 每个IP最多10个连接
        limit_conn conn_limit 10;
        
        # 下载限流
        location /download {
            limit_conn conn_limit 1;  # 每个IP最多1个下载连接
            limit_rate 100k;  # 限制下载速度
        }
    }
}
```

### 4.3 限流配置说明

- **zone**: 限流区域名称和内存大小
- **rate**: 请求速率（r/s = 每秒请求数，r/m = 每分钟请求数）
- **burst**: 突发请求数
- **nodelay**: 不延迟处理突发请求

### 4.4 白名单IP不限流

```nginx
http {
    # 定义白名单
    geo $limit {
        default 1;
        127.0.0.1 0;  # 本地不限流
        192.168.1.0/24 0;  # 内网不限流
    }
    
    map $limit $limit_key {
        0 "";
        1 $binary_remote_addr;
    }
    
    limit_req_zone $limit_key zone=api_limit:10m rate=10r/s;
    
    server {
        location /api {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://backend;
        }
    }
}
```

## 五、安全响应头

### 5.1 基本安全头

```nginx
server {
    # 强制HTTPS（HSTS）
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    
    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # 防止MIME类型嗅探
    add_header X-Content-Type-Options "nosniff" always;
    
    # XSS保护
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 引用策略
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # 内容安全策略
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
}
```

### 5.2 安全头说明

- **Strict-Transport-Security**: 强制使用HTTPS
- **X-Frame-Options**: 防止页面被嵌入iframe
- **X-Content-Type-Options**: 防止MIME类型嗅探
- **X-XSS-Protection**: 启用浏览器XSS过滤器
- **Referrer-Policy**: 控制引用信息
- **Content-Security-Policy**: 内容安全策略

### 5.3 移除服务器信息头

```nginx
server {
    # 移除Server头（需要headers-more模块）
    more_clear_headers Server;
    more_clear_headers "X-Powered-By";
}
```

## 六、文件访问安全

### 6.1 禁止访问隐藏文件

```nginx
server {
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
```

### 6.2 禁止访问敏感文件

```nginx
server {
    # 禁止访问特定文件类型
    location ~ \.(sql|log|conf|bak|backup|old)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 禁止访问特定目录
    location ~ ^/(\.git|\.svn|\.env|config|backup) {
        deny all;
        access_log off;
        log_not_found off;
    }
}
```

### 6.3 防止目录遍历

```nginx
server {
    location / {
        # 禁止目录遍历
        try_files $uri $uri/ =404;
    }
}
```

## 七、SSL/TLS安全

### 7.1 强化的SSL配置

```nginx
server {
    listen 443 ssl http2;
    
    # 只使用TLS 1.2和1.3
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # 现代加密套件
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    
    # SSL会话配置
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
}
```

### 7.2 强制HTTPS

```nginx
# HTTP重定向到HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}
```

## 八、请求验证

### 8.1 请求大小限制

```nginx
http {
    # 限制请求体大小
    client_max_body_size 10m;
    
    # 限制请求头大小
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
}
```

### 8.2 请求超时限制

```nginx
http {
    # 客户端请求超时
    client_body_timeout 10s;
    client_header_timeout 10s;
    
    # 发送超时
    send_timeout 10s;
}
```

### 8.3 验证请求头

```nginx
server {
    # 验证Host头
    if ($host !~ ^(example\.com|www\.example\.com)$ ) {
        return 444;
    }
    
    # 验证User-Agent（防止爬虫）
    if ($http_user_agent ~* (bot|crawler|spider)) {
        return 403;
    }
}
```

## 九、DDoS防护

### 9.1 连接限制

```nginx
http {
    # 限制每个IP的连接数
    limit_conn_zone $binary_remote_addr zone=perip:10m;
    limit_conn_zone $server_name zone=perserver:10m;
    
    server {
        limit_conn perip 10;  # 每个IP最多10个连接
        limit_conn perserver 1000;  # 每个服务器最多1000个连接
    }
}
```

### 9.2 请求频率限制

```nginx
http {
    # 限制请求频率
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
    
    server {
        limit_req zone=req_limit burst=20 nodelay;
    }
}
```

### 9.3 慢速攻击防护

```nginx
http {
    # 限制客户端请求体读取速度
    client_body_timeout 10s;
    client_header_timeout 10s;
    
    # 限制连接保持时间
    keepalive_timeout 10s;
}
```

## 十、日志安全

### 10.1 记录安全事件

```nginx
# 记录被拒绝的请求
log_format security '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   'blocked=$blocked';

server {
    set $blocked 0;
    
    # 如果被限流，设置标记
    limit_req_status 429;
    
    # 记录被拒绝的请求
    access_log /var/log/nginx/security.log security if=$blocked;
}
```

### 10.2 不记录敏感信息

```nginx
# 不记录查询参数中的敏感信息
map $args $log_args {
    ~*password  "";
    ~*token     "";
    default     $args;
}

log_format safe '$remote_addr - $remote_user [$time_local] '
                '"$request_method $request_uri" $status';
```

## 十一、完整安全配置示例

### 11.1 生产环境安全配置

```nginx
http {
    # 隐藏服务器信息
    server_tokens off;
    
    # 限流配置
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    
    # 请求大小限制
    client_max_body_size 10m;
    client_body_timeout 10s;
    client_header_timeout 10s;
    
    server {
        listen 443 ssl http2;
        server_name example.com;
        
        # SSL配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;
        
        # 安全响应头
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        
        # 限流
        limit_conn conn_limit 10;
        limit_req zone=api_limit burst=20 nodelay;
        
        # 禁止访问隐藏文件
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
        
        # 禁止访问敏感文件
        location ~ \.(sql|log|conf|bak)$ {
            deny all;
            access_log off;
        }
        
        # 只允许GET、HEAD、POST方法
        if ($request_method !~ ^(GET|HEAD|POST)$ ) {
            return 405;
        }
        
        root /var/www/html;
        index index.html;
        
        location / {
            try_files $uri $uri/ =404;
        }
    }
    
    # HTTP重定向到HTTPS
    server {
        listen 80;
        server_name example.com;
        return 301 https://$server_name$request_uri;
    }
}
```

## 十二、安全测试

### 12.1 使用安全扫描工具

- **SSL Labs**: https://www.ssllabs.com/ssltest/
- **Security Headers**: https://securityheaders.com/
- **Mozilla Observatory**: https://observatory.mozilla.org/

### 12.2 手动测试

```bash
# 测试安全头
curl -I https://example.com

# 测试限流
for i in {1..20}; do curl https://example.com/api; done

# 测试IP限制
curl -H "X-Forwarded-For: 192.168.1.200" https://example.com/admin
```

## 十三、下一步学习

完成本课后，你应该能够：

- ✅ 隐藏服务器信息
- ✅ 配置访问控制（IP白名单/黑名单）
- ✅ 配置限流（请求频率、连接数）
- ✅ 添加安全响应头
- ✅ 保护敏感文件和目录
- ✅ 配置SSL/TLS安全
- ✅ 防护DDoS攻击

接下来可以学习：

1. **第10课：常见场景配置** - 学习实际项目配置案例

## 十四、总结

- 安全配置是Web服务器的重要部分
- 隐藏服务器信息减少攻击面
- 使用限流防止DDoS攻击
- 添加安全响应头增强浏览器保护
- 合理配置访问控制保护敏感资源
- 定期进行安全测试和更新

掌握安全配置后，你就可以部署更安全的Web应用了！
