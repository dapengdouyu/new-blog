---
title: Nginx高级：性能优化
date: 2026-01-12
description: 学习如何优化Nginx性能，包括连接优化、缓存配置、压缩优化等
---

# Nginx高级：性能优化

## 一、性能优化概述

### 1.1 性能优化的目标

- **提高并发处理能力**：处理更多同时连接
- **降低响应时间**：减少请求处理时间
- **提高吞吐量**：处理更多请求/秒
- **降低资源消耗**：减少CPU和内存使用

### 1.2 性能优化的关键点

1. **连接和进程优化**
2. **缓存配置**
3. **压缩优化**
4. **缓冲和超时配置**
5. **文件访问优化**

## 二、连接和进程优化

### 2.1 工作进程优化

```nginx
# 自动检测CPU核心数（推荐）
worker_processes auto;

# 手动设置（通常等于CPU核心数）
worker_processes 4;

# 绑定工作进程到特定CPU核心
worker_cpu_affinity auto;
```

### 2.2 连接数优化

```nginx
events {
    # 每个工作进程的最大连接数
    worker_connections 1024;
    
    # 使用epoll（Linux）
    use epoll;
    
    # 允许一个工作进程同时接受多个连接
    multi_accept on;
}
```

**最大并发连接数计算**：
```
最大并发连接数 = worker_processes × worker_connections
```

### 2.3 文件描述符限制

```bash
# 查看当前限制
ulimit -n

# 临时增加限制
ulimit -n 65535

# 永久修改（编辑 /etc/security/limits.conf）
* soft nofile 65535
* hard nofile 65535
```

## 三、HTTP连接优化

### 3.1 Keep-Alive连接

```nginx
http {
    # 保持连接超时时间
    keepalive_timeout 65;
    
    # 保持连接的最大请求数
    keepalive_requests 100;
    
    # 禁用Keep-Alive（不推荐）
    # keepalive_timeout 0;
}
```

### 3.2 连接复用（上游服务器）

```nginx
upstream backend {
    server 127.0.0.1:3000;
    keepalive 32;  # 保持32个空闲连接
}

server {
    location / {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
```

### 3.3 TCP优化

```nginx
http {
    # 启用TCP_NOPUSH（与sendfile配合）
    tcp_nopush on;
    
    # 启用TCP_NODELAY
    tcp_nodelay on;
    
    # 启用sendfile（零拷贝）
    sendfile on;
}
```

## 四、缓存配置

### 4.1 代理缓存（Proxy Cache）

```nginx
http {
    # 定义缓存路径和参数
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    server {
        location / {
            proxy_pass http://backend;
            
            # 启用缓存
            proxy_cache my_cache;
            
            # 缓存键
            proxy_cache_key "$scheme$request_method$host$request_uri";
            
            # 缓存状态
            add_header X-Cache-Status $upstream_cache_status;
            
            # 缓存条件
            proxy_cache_valid 200 60m;
            proxy_cache_valid 404 1m;
        }
    }
}
```

### 4.2 缓存配置说明

- **levels**: 缓存目录层级结构
- **keys_zone**: 缓存键的内存区域和大小
- **max_size**: 缓存最大大小
- **inactive**: 非活动缓存保留时间
- **use_temp_path**: 是否使用临时路径

### 4.3 缓存条件

```nginx
location / {
    proxy_pass http://backend;
    proxy_cache my_cache;
    
    # 根据响应状态码缓存
    proxy_cache_valid 200 302 10m;
    proxy_cache_valid 404 1m;
    proxy_cache_valid any 5m;
    
    # 根据响应头缓存
    proxy_cache_bypass $http_pragma $http_authorization;
    proxy_no_cache $http_pragma $http_authorization;
}
```

### 4.4 FastCGI缓存

```nginx
http {
    fastcgi_cache_path /var/cache/nginx/fastcgi levels=1:2 
                       keys_zone=fastcgi_cache:10m max_size=1g;
    
    server {
        location ~ \.php$ {
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_cache fastcgi_cache;
            fastcgi_cache_valid 200 60m;
            fastcgi_cache_key "$scheme$request_method$host$request_uri";
            add_header X-Cache-Status $upstream_cache_status;
        }
    }
}
```

## 五、压缩优化

### 5.1 Gzip压缩

```nginx
http {
    # 启用Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    
    # 压缩级别（1-9，6是平衡点）
    gzip_comp_level 6;
    
    # 最小压缩文件大小
    gzip_min_length 1000;
    
    # 需要压缩的MIME类型
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    
    # 禁用某些浏览器的压缩
    gzip_disable "msie6";
}
```

### 5.2 压缩优化建议

- **压缩级别**：6是性能和压缩率的平衡点
- **最小文件大小**：小于1KB的文件压缩效果不明显
- **MIME类型**：只压缩文本类型，图片和视频已经压缩

### 5.3 Brotli压缩（需要模块）

```nginx
http {
    brotli on;
    brotli_comp_level 6;
    brotli_types text/plain text/css application/json application/javascript;
    brotli_min_length 1000;
}
```

## 六、缓冲和超时配置

### 6.1 代理缓冲

```nginx
location / {
    proxy_pass http://backend;
    
    # 启用缓冲
    proxy_buffering on;
    
    # 缓冲区大小
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    # 临时文件
    proxy_temp_file_write_size 16k;
    proxy_max_temp_file_size 0;  # 0表示禁用临时文件
}
```

### 6.2 超时配置

```nginx
location / {
    proxy_pass http://backend;
    
    # 连接超时
    proxy_connect_timeout 60s;
    
    # 发送超时
    proxy_send_timeout 60s;
    
    # 读取超时
    proxy_read_timeout 60s;
}
```

### 6.3 客户端请求缓冲

```nginx
http {
    # 客户端请求体大小限制
    client_max_body_size 10m;
    
    # 客户端请求头缓冲区
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    
    # 客户端请求体缓冲区
    client_body_buffer_size 128k;
}
```

## 七、文件访问优化

### 7.1 sendfile和文件描述符缓存

```nginx
http {
    # 启用sendfile（零拷贝）
    sendfile on;
    
    # 文件描述符缓存
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
}
```

### 7.2 open_file_cache说明

- **max**: 缓存的最大文件描述符数量
- **inactive**: 非活动文件的缓存时间
- **valid**: 检查文件是否仍然有效的时间间隔
- **min_uses**: 文件被访问的最小次数才缓存
- **errors**: 是否缓存文件打开错误

### 7.3 直接IO（需要模块）

```nginx
location / {
    aio on;
    directio 512;
    output_buffers 1 128k;
}
```

## 八、静态资源优化

### 8.1 静态文件缓存

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}
```

### 8.2 静态文件服务优化

```nginx
location /static {
    alias /var/www/static;
    
    # 启用sendfile
    sendfile on;
    
    # 文件描述符缓存
    open_file_cache max=10000 inactive=30s;
    
    # 禁用访问日志
    access_log off;
}
```

## 九、负载均衡优化

### 9.1 连接复用

```nginx
upstream backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    keepalive 32;  # 保持32个空闲连接
}

server {
    location / {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
```

### 9.2 健康检查（Nginx Plus）

```nginx
upstream backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    
    # 健康检查（需要Nginx Plus）
    health_check interval=5s fails=3 passes=2;
}
```

## 十、性能监控

### 10.1 启用状态模块（需要编译时添加）

```nginx
location /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    deny all;
}
```

访问 `http://localhost/nginx_status` 可以看到：
- 活动连接数
- 接受的连接数
- 处理的请求数
- 读取和写入的连接数

### 10.2 性能指标

```nginx
# 在日志中记录性能指标
log_format performance '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'rt=$request_time uct="$upstream_connect_time" '
                      'uht="$upstream_header_time" urt="$upstream_response_time"';

access_log /var/log/nginx/access.log performance;
```

### 10.3 使用工具监控

- **htop/top**: 监控CPU和内存使用
- **iftop**: 监控网络流量
- **nginx-rrd**: Nginx性能图表
- **Prometheus + Grafana**: 专业监控方案

## 十一、完整性能优化配置

### 11.1 生产环境优化配置

```nginx
user nginx;
worker_processes auto;
worker_cpu_affinity auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 日志格式（包含性能指标）
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'urt="$upstream_response_time"';
    
    access_log /var/log/nginx/access.log main;
    
    # 文件访问优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # 文件描述符缓存
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;
    
    # 客户端请求配置
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    client_body_buffer_size 128k;
    
    # 代理缓存
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=proxy_cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    # 包含其他配置
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

## 十二、性能测试

### 12.1 使用ab（Apache Bench）

```bash
# 安装ab
sudo apt install apache2-utils  # Ubuntu/Debian

# 测试（1000个请求，10个并发）
ab -n 1000 -c 10 http://example.com/

# 详细输出
ab -n 1000 -c 10 -v 2 http://example.com/
```

### 12.2 使用wrk

```bash
# 安装wrk
sudo apt install wrk  # Ubuntu/Debian

# 测试（持续30秒，12个线程，400个连接）
wrk -t12 -c400 -d30s http://example.com/

# 使用Lua脚本
wrk -t12 -c400 -d30s --script=post.lua http://example.com/
```

### 12.3 使用siege

```bash
# 安装siege
sudo apt install siege  # Ubuntu/Debian

# 测试（持续60秒，10个并发）
siege -c10 -t60s http://example.com/
```

## 十三、下一步学习

完成本课后，你应该能够：

- ✅ 优化Nginx的连接和进程配置
- ✅ 配置代理缓存和FastCGI缓存
- ✅ 优化Gzip压缩配置
- ✅ 配置缓冲和超时参数
- ✅ 优化文件访问性能
- ✅ 监控和测试Nginx性能

接下来可以学习：

1. **第9课：安全配置** - 学习如何配置Nginx安全策略
2. **第10课：常见场景配置** - 学习实际项目配置案例

## 十四、总结

- 性能优化需要综合考虑多个方面
- 合理配置工作进程和连接数
- 使用缓存减少后端压力
- 启用压缩减少传输数据量
- 优化文件访问和缓冲配置
- 定期监控和测试性能

掌握性能优化后，你就可以构建高性能的Web应用了！
