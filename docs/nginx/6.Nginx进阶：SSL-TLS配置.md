---
title: Nginx进阶：SSL/TLS配置
date: 2026-01-12
description: 学习如何配置Nginx的HTTPS，包括SSL证书获取、配置和安全优化
---

# Nginx进阶：SSL/TLS配置

## 一、SSL/TLS基础

### 1.1 什么是SSL/TLS

SSL（Secure Sockets Layer）和TLS（Transport Layer Security）是用于在网络上提供加密通信的协议。

- **SSL**: 旧版本，已废弃
- **TLS**: 现代标准，目前使用TLS 1.2和TLS 1.3

### 1.2 HTTPS的工作原理

1. 客户端请求HTTPS连接
2. 服务器发送SSL证书
3. 客户端验证证书
4. 双方协商加密算法
5. 建立加密连接
6. 开始加密通信

### 1.3 为什么需要HTTPS

- **数据加密**：保护数据传输安全
- **身份验证**：验证服务器身份
- **数据完整性**：防止数据被篡改
- **SEO优势**：搜索引擎优先排名
- **浏览器要求**：现代浏览器要求HTTPS

## 二、SSL证书类型

### 2.1 证书类型

1. **自签名证书**（Self-Signed）
   - 免费，但浏览器会显示警告
   - 适用于开发测试环境

2. **域名验证证书**（DV - Domain Validated）
   - 验证域名所有权
   - 适合个人网站和小型项目

3. **组织验证证书**（OV - Organization Validated）
   - 验证组织信息
   - 适合企业网站

4. **扩展验证证书**（EV - Extended Validated）
   - 最高级别验证
   - 浏览器地址栏显示组织名称

### 2.2 免费SSL证书

- **Let's Encrypt**：最流行的免费证书
- **Cloudflare**：提供免费SSL
- **ZeroSSL**：免费SSL证书

## 三、使用Let's Encrypt获取证书

### 3.1 安装Certbot

#### Ubuntu/Debian

```bash
# 安装Certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx
```

#### CentOS/RHEL

```bash
# 安装EPEL仓库
sudo yum install epel-release

# 安装Certbot
sudo yum install certbot python3-certbot-nginx
```

#### macOS

```bash
brew install certbot
```

### 3.2 自动获取和配置证书

```bash
# 自动获取证书并配置Nginx
sudo certbot --nginx -d example.com -d www.example.com
```

Certbot会自动：
1. 获取SSL证书
2. 配置Nginx
3. 设置自动续期

### 3.3 手动获取证书

```bash
# 只获取证书，不配置Nginx
sudo certbot certonly --nginx -d example.com -d www.example.com
```

证书文件位置：
- 证书：`/etc/letsencrypt/live/example.com/fullchain.pem`
- 私钥：`/etc/letsencrypt/live/example.com/privkey.pem`

### 3.4 证书续期

```bash
# 手动续期
sudo certbot renew

# 测试续期（不实际续期）
sudo certbot renew --dry-run

# 设置自动续期（通常已自动配置）
# Certbot会创建systemd timer或cron job
```

## 四、Nginx HTTPS配置

### 4.1 基本HTTPS配置

```nginx
server {
    listen 443 ssl;
    server_name example.com;
    
    # SSL证书
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    root /var/www/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 4.2 HTTP到HTTPS重定向

```nginx
# HTTP服务器（重定向到HTTPS）
server {
    listen 80;
    server_name example.com www.example.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS服务器
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;
    
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    root /var/www/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 4.3 同时支持HTTP和HTTPS

```nginx
# HTTP服务器
server {
    listen 80;
    server_name example.com;
    root /var/www/html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# HTTPS服务器
server {
    listen 443 ssl;
    server_name example.com;
    
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    root /var/www/html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

## 五、SSL安全配置

### 5.1 推荐的SSL配置

```nginx
server {
    listen 443 ssl http2;
    server_name example.com;
    
    # SSL证书
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # 只使用TLS 1.2和1.3
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # 现代加密套件
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    
    # SSL会话缓存
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/example.com/chain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    root /var/www/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 5.2 SSL配置说明

- **ssl_protocols**: 支持的TLS版本
- **ssl_ciphers**: 允许的加密套件
- **ssl_prefer_server_ciphers**: 优先使用服务器端的加密套件（TLS 1.3不需要）
- **ssl_session_cache**: SSL会话缓存，提高性能
- **ssl_session_timeout**: 会话超时时间
- **ssl_stapling**: OCSP Stapling，提高SSL验证速度

### 5.3 HTTP/2配置

```nginx
server {
    listen 443 ssl http2;  # 启用HTTP/2
    server_name example.com;
    
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # HTTP/2需要HTTPS
    # ...
}
```

## 六、自签名证书

### 6.1 生成自签名证书

```bash
# 创建证书目录
sudo mkdir -p /etc/nginx/ssl

# 生成私钥
sudo openssl genrsa -out /etc/nginx/ssl/example.com.key 2048

# 生成证书签名请求
sudo openssl req -new -key /etc/nginx/ssl/example.com.key -out /etc/nginx/ssl/example.com.csr

# 生成自签名证书
sudo openssl x509 -req -days 365 -in /etc/nginx/ssl/example.com.csr -signkey /etc/nginx/ssl/example.com.key -out /etc/nginx/ssl/example.com.crt
```

### 6.2 使用自签名证书

```nginx
server {
    listen 443 ssl;
    server_name example.com;
    
    ssl_certificate /etc/nginx/ssl/example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example.com.key;
    
    # 其他配置...
}
```

**注意**：自签名证书浏览器会显示安全警告，仅用于开发测试。

## 七、多域名SSL证书

### 7.1 SAN证书（Subject Alternative Name）

```nginx
server {
    listen 443 ssl;
    server_name example.com www.example.com api.example.com;
    
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # ...
}
```

### 7.2 通配符证书

```bash
# 获取通配符证书
sudo certbot certonly --dns-cloudflare -d "*.example.com" -d example.com
```

```nginx
server {
    listen 443 ssl;
    server_name *.example.com;
    
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # ...
}
```

## 八、SSL性能优化

### 8.1 SSL会话复用

```nginx
http {
    # 共享SSL会话缓存
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    server {
        listen 443 ssl;
        # 使用共享缓存
        # ...
    }
}
```

### 8.2 OCSP Stapling

```nginx
server {
    listen 443 ssl;
    
    # 启用OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/example.com/chain.pem;
    
    # DNS解析器
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # ...
}
```

### 8.3 TLS 1.3优化

```nginx
server {
    listen 443 ssl http2;
    
    # 优先使用TLS 1.3
    ssl_protocols TLSv1.3 TLSv1.2;
    
    # TLS 1.3的0-RTT（需要谨慎使用）
    # ssl_early_data on;
    
    # ...
}
```

## 九、SSL测试和验证

### 9.1 测试SSL配置

```bash
# 测试SSL连接
openssl s_client -connect example.com:443

# 检查证书信息
openssl x509 -in /etc/letsencrypt/live/example.com/fullchain.pem -text -noout
```

### 9.2 在线SSL测试工具

- **SSL Labs**: https://www.ssllabs.com/ssltest/
- **SSL Checker**: https://www.sslshopper.com/ssl-checker.html
- **Security Headers**: https://securityheaders.com/

### 9.3 检查SSL配置

```bash
# 使用testssl.sh
./testssl.sh example.com

# 使用nmap
nmap --script ssl-enum-ciphers -p 443 example.com
```

## 十、常见问题解决

### 10.1 证书过期

```bash
# 检查证书过期时间
sudo certbot certificates

# 手动续期
sudo certbot renew

# 检查自动续期
sudo systemctl status certbot.timer
```

### 10.2 混合内容警告

确保网站所有资源都使用HTTPS：

```nginx
# 强制HTTPS
add_header Strict-Transport-Security "max-age=63072000" always;

# 内容安全策略
add_header Content-Security-Policy "upgrade-insecure-requests" always;
```

### 10.3 证书链不完整

```nginx
# 使用完整证书链
ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
# 而不是
# ssl_certificate /etc/letsencrypt/live/example.com/cert.pem;
```

## 十一、完整配置示例

### 11.1 生产环境HTTPS配置

```nginx
# HTTP重定向到HTTPS
server {
    listen 80;
    server_name example.com www.example.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS服务器
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;
    
    # SSL证书
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    
    # SSL会话
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/example.com/chain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    root /var/www/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

## 十二、下一步学习

完成本课后，你应该能够：

- ✅ 理解SSL/TLS的基本概念
- ✅ 使用Let's Encrypt获取免费SSL证书
- ✅ 配置Nginx的HTTPS
- ✅ 优化SSL性能和安全性
- ✅ 处理HTTP到HTTPS的重定向

接下来可以学习：

1. **第7课：日志管理** - 学习如何管理和分析日志
2. **第8课：性能优化** - 学习如何优化Nginx性能

## 十三、总结

- HTTPS是现代Web应用的标准
- Let's Encrypt提供免费的SSL证书
- 使用TLS 1.2和1.3，禁用旧版本
- 配置OCSP Stapling提高性能
- 添加安全响应头增强安全性
- 定期检查证书过期时间

掌握SSL/TLS配置后，你就可以部署安全的HTTPS网站了！
