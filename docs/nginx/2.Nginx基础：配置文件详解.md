---
title: Nginx基础：配置文件详解
date: 2026-01-12
description: 深入理解Nginx配置文件的结构、指令和语法规则，掌握配置文件的组织方式和最佳实践
---

# Nginx基础：配置文件详解

## 一、配置文件位置和结构

### 1.1 主配置文件位置

不同系统的配置文件位置：

- **Linux (Ubuntu/Debian)**: `/etc/nginx/nginx.conf`
- **Linux (CentOS/RHEL)**: `/etc/nginx/nginx.conf`
- **macOS (Homebrew)**: `/usr/local/etc/nginx/nginx.conf`
- **Windows**: `安装目录/conf/nginx.conf`

### 1.2 配置文件目录结构

```
/etc/nginx/                    # Nginx配置根目录
├── nginx.conf                 # 主配置文件
├── mime.types                 # MIME类型定义文件
├── fastcgi_params             # FastCGI参数文件
├── proxy_params               # 代理参数文件
├── scgi_params                # SCGI参数文件
├── uwsgi_params               # uWSGI参数文件
├── conf.d/                    # 额外配置文件目录
│   └── default.conf          # 默认服务器配置
├── sites-available/           # 可用站点配置（Ubuntu/Debian）
│   └── default                # 默认站点配置
├── sites-enabled/             # 启用的站点配置（符号链接）
│   └── default -> ../sites-available/default
└── modules-available/         # 可用模块配置
```

### 1.3 查看配置文件位置

```bash
# 查看主配置文件路径和测试配置
nginx -t

# 输出示例：
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful

# 查看完整配置内容（包括所有include的文件）
nginx -T

# 查看配置文件路径和测试结果
nginx -T 2>&1 | grep -E "configuration file|test is"

# 查看Nginx编译信息和模块
nginx -V
```

### 1.4 配置文件组织最佳实践

**推荐的文件组织方式**：

```nginx
# /etc/nginx/nginx.conf - 主配置文件
# 只包含全局配置和include语句

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # 基础配置
    include /etc/nginx/mime.types;
    include /etc/nginx/conf.d/*.conf;
    
    # 站点配置
    include /etc/nginx/sites-enabled/*;
}
```

**优势**：
- 主配置文件简洁清晰
- 每个站点使用独立配置文件
- 便于管理和维护
- 易于版本控制

## 二、配置文件结构

### 2.1 基本结构

Nginx配置文件采用层次化的块结构，主要包含以下部分：

```nginx
# ============================================
# 全局配置块（Main Context）
# ============================================
# 在http和events块之外的配置
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# ============================================
# 事件配置块（Events Context）
# ============================================
# 配置连接处理方式
events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

# ============================================
# HTTP配置块（HTTP Context）
# ============================================
# HTTP服务器相关配置
http {
    # HTTP全局配置
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ============================================
    # 服务器配置块（Server Context）
    # ============================================
    # 虚拟主机配置
    server {
        listen 80;
        server_name example.com;
        
        # ============================================
        # 位置配置块（Location Context）
        # ============================================
        # URL匹配和请求处理
        location / {
            root /var/www/html;
            index index.html;
        }
    }
}
```

### 2.2 配置块层次关系

```
nginx.conf (全局/Main Context)
│
├── events { }                    # 事件处理配置（必需）
│   └── worker_connections         # 每个工作进程的连接数
│
└── http { }                      # HTTP服务器配置（必需）
    │
    ├── upstream { }             # 上游服务器组（可选）
    │   └── server               # 后端服务器定义
    │
    ├── map { }                  # 变量映射（可选）
    │   └── 变量转换规则
    │
    ├── geo { }                  # IP地址映射（可选）
    │   └── IP地址规则
    │
    └── server { }               # 虚拟主机配置（必需）
        │
        ├── location { }         # URL位置配置（可选）
        │   └── 请求处理指令
        │
        └── if { }               # 条件配置（谨慎使用）
            └── 条件判断指令
```

### 2.3 配置上下文（Context）说明

**上下文类型**：

1. **Main Context（全局上下文）**
   - 最外层，不在任何块内
   - 包含：user, worker_processes, error_log, pid等

2. **Events Context（事件上下文）**
   - 必需，配置连接处理
   - 只能有一个events块

3. **HTTP Context（HTTP上下文）**
   - 必需，HTTP服务器配置
   - 可以包含多个server块

4. **Server Context（服务器上下文）**
   - 虚拟主机配置
   - 可以包含多个location块

5. **Location Context（位置上下文）**
   - URL匹配和请求处理
   - 可以嵌套location块（不推荐）

6. **Upstream Context（上游上下文）**
   - 定义后端服务器组
   - 用于负载均衡

**重要规则**：
- 某些指令只能在特定上下文中使用
- 指令的作用域由其所在的上下文决定
- 子上下文可以继承和覆盖父上下文的配置

## 三、全局配置块（Main Context）

### 3.1 主要指令详解

#### user指令

```nginx
# 指定运行Nginx工作进程的用户和组
user nginx nginx;

# 只指定用户（使用该用户的主组）
user nginx;

# 不指定（使用编译时指定的用户，通常是nobody）
# user nobody;
```

**说明**：
- 主进程（master process）以root用户运行
- 工作进程（worker process）以指定用户运行
- 提高安全性，降低权限

**查看当前用户**：
```bash
ps aux | grep nginx
# 输出示例：
# root      1234  ... nginx: master process
# nginx     1235  ... nginx: worker process
```

#### worker_processes指令

```nginx
# 自动检测CPU核心数（推荐，Nginx 1.2.5+）
worker_processes auto;

# 手动指定进程数
worker_processes 4;

# 使用所有CPU核心
worker_processes 8;
```

**选择原则**：
- **CPU密集型应用**：worker_processes = CPU核心数
- **IO密集型应用**：worker_processes = CPU核心数 × 2
- **一般情况**：使用 `auto` 让Nginx自动检测

**查看CPU核心数**：
```bash
# Linux
grep processor /proc/cpuinfo | wc -l
# 或
nproc

# macOS
sysctl -n hw.ncpu
```

**验证配置**：
```bash
# 查看工作进程数
ps aux | grep "nginx: worker" | wc -l
```

#### error_log指令

```nginx
# 基本语法
error_log file [level];

# 示例
error_log /var/log/nginx/error.log warn;
error_log /var/log/nginx/error.log error;
error_log /var/log/nginx/error.log crit;
```

**日志级别**（从低到高）：
- `debug`: 调试信息（最详细）
- `info`: 一般信息
- `notice`: 通知
- `warn`: 警告（推荐生产环境）
- `error`: 错误
- `crit`: 严重错误
- `alert`: 警报
- `emerg`: 紧急（最高级别）

**日志级别说明**：
- 设置某个级别会记录该级别及更高级别的日志
- 例如：`warn` 会记录 warn, error, crit, alert, emerg

**特殊配置**：
```nginx
# 禁用错误日志（不推荐）
error_log /dev/null;

# 发送到syslog
error_log syslog:server=127.0.0.1:514;

# 发送到stderr（用于Docker等容器）
error_log stderr;
```

#### pid指令

```nginx
# 指定PID文件位置
pid /var/run/nginx.pid;

# 默认位置（如果不指定）
# /var/run/nginx.pid
```

**说明**：
- PID文件包含主进程的进程ID
- 用于进程管理和信号发送
- 通常由systemd或init系统管理

#### include指令

```nginx
# 包含其他配置文件
include /etc/nginx/modules-enabled/*.conf;
include /etc/nginx/conf.d/*.conf;
include /etc/nginx/sites-enabled/*;

# 包含特定文件
include /etc/nginx/conf.d/ssl.conf;
```

**说明**：
- 支持通配符（`*`）
- 可以包含多个文件
- 被包含的文件必须符合Nginx语法
- 如果文件不存在，Nginx会报错（除非使用可选包含）

### 3.2 完整全局配置示例

```nginx
# 运行用户
user nginx;

# 工作进程数（自动检测）
worker_processes auto;

# 错误日志
error_log /var/log/nginx/error.log warn;

# PID文件
pid /var/run/nginx.pid;

# 包含模块配置
include /etc/nginx/modules-enabled/*.conf;

# 工作进程CPU绑定（可选，需要编译时支持）
# worker_cpu_affinity auto;

# 工作进程优先级（可选）
# worker_priority -5;
```

## 四、events配置块（Events Context）

### 4.1 主要指令详解

#### worker_connections指令

```nginx
events {
    # 每个工作进程的最大连接数
    worker_connections 1024;
    
    # 高并发场景可以设置更大
    worker_connections 2048;
    
    # 注意：受系统限制（ulimit -n）
}
```

**说明**：
- 限制每个工作进程可以同时处理的连接数
- 包括客户端连接和到上游服务器的连接
- 实际值受系统文件描述符限制影响

**系统限制检查**：
```bash
# 查看当前限制
ulimit -n

# 临时增加限制
ulimit -n 65535

# 永久修改（编辑 /etc/security/limits.conf）
# * soft nofile 65535
# * hard nofile 65535
```

#### use指令

```nginx
events {
    # 自动选择最佳事件模型（推荐）
    # use epoll;  # Linux 2.6+
    # use kqueue; # FreeBSD, macOS
    # use select; # 兼容模式
    
    # 通常不需要手动指定，Nginx会自动选择
}
```

**事件模型说明**：
- **epoll**（Linux）：高效的事件通知机制
- **kqueue**（FreeBSD, macOS）：类似epoll
- **select/poll**：传统方式，效率较低

**最佳实践**：
- 通常不需要手动指定
- Nginx会自动选择最佳模型
- 只在特殊情况下才需要指定

#### multi_accept指令

```nginx
events {
    # 允许一个工作进程同时接受多个新连接
    multi_accept on;
    
    # 一次只接受一个新连接（默认）
    # multi_accept off;
}
```

**说明**：
- `on`: 工作进程一次接受所有新连接
- `off`: 工作进程一次只接受一个新连接
- 在高并发场景下，`on` 可以提高性能

### 4.2 并发连接数计算

**理论最大并发连接数**：
```
最大并发连接数 = worker_processes × worker_connections
```

**实际计算示例**：

```nginx
# 配置示例
worker_processes 4;
events {
    worker_connections 1024;
}

# 理论最大并发连接数 = 4 × 1024 = 4096
```

**实际考虑因素**：
- 系统文件描述符限制（`ulimit -n`）
- 系统内存限制
- 网络带宽限制
- 应用处理能力

**验证配置**：
```bash
# 查看当前连接数
netstat -an | grep :80 | wc -l
# 或
ss -an | grep :80 | wc -l

# 查看Nginx状态（需要stub_status模块）
curl http://localhost/nginx_status
```

### 4.3 完整events配置示例

```nginx
events {
    # 每个工作进程的最大连接数
    worker_connections 2048;
    
    # 使用epoll（Linux，通常自动选择）
    use epoll;
    
    # 允许同时接受多个连接
    multi_accept on;
    
    # 接受连接的队列大小（可选）
    # accept_mutex on;
    # accept_mutex_delay 500ms;
}
```

**性能优化建议**：
- 根据实际并发需求设置 `worker_connections`
- 确保系统文件描述符限制足够大
- 在高并发场景启用 `multi_accept`

## 五、HTTP配置块（HTTP Context）

### 5.1 基本结构

```nginx
http {
    # ============================================
    # MIME类型配置
    # ============================================
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ============================================
    # 日志配置
    # ============================================
    # 定义日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    # 设置访问日志
    access_log /var/log/nginx/access.log main;
    
    # ============================================
    # 性能优化配置
    # ============================================
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # ============================================
    # 客户端配置
    # ============================================
    client_max_body_size 20m;
    client_body_timeout 60s;
    client_header_timeout 60s;
    
    # ============================================
    # 压缩配置
    # ============================================
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json;
    
    # ============================================
    # 包含服务器配置
    # ============================================
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

### 5.2 常用HTTP指令详解

#### MIME类型配置

```nginx
http {
    # 包含MIME类型定义文件
    include /etc/nginx/mime.types;
    
    # 默认MIME类型（当无法识别文件类型时）
    default_type application/octet-stream;
    
    # 自定义MIME类型（可选）
    types {
        text/html html htm;
        text/css css;
        application/javascript js;
        image/jpeg jpg jpeg;
        image/png png;
        image/gif gif;
        image/webp webp;
        application/json json;
    }
}
```

#### 文件传输优化

```nginx
http {
    # 启用sendfile（零拷贝，Linux 2.2+）
    # 直接从文件系统发送文件到网络，不经过用户空间
    sendfile on;
    
    # TCP_NOPUSH选项（与sendfile配合使用）
    # 等待数据包填满后再发送，提高网络效率
    tcp_nopush on;
    
    # TCP_NODELAY选项
    # 立即发送数据，不等待缓冲区填满（用于实时性要求高的场景）
    tcp_nodelay on;
    
    # 注意：tcp_nopush和tcp_nodelay通常不同时使用
    # sendfile on + tcp_nopush on：适合大文件传输
    # sendfile on + tcp_nodelay on：适合小文件或实时性要求高的场景
}
```

#### 连接保持配置

```nginx
http {
    # Keep-Alive连接超时时间
    keepalive_timeout 65;
    
    # Keep-Alive连接的最大请求数
    keepalive_requests 100;
    
    # 禁用Keep-Alive（不推荐）
    # keepalive_timeout 0;
}
```

**说明**：
- `keepalive_timeout`: 连接保持时间，超过此时间无活动则关闭
- `keepalive_requests`: 一个连接最多处理的请求数，达到后关闭连接
- 合理配置可以减少连接建立开销

#### 客户端请求配置

```nginx
http {
    # 客户端请求体最大大小
    client_max_body_size 20m;
    
    # 客户端请求体读取超时
    client_body_timeout 60s;
    
    # 客户端请求头读取超时
    client_header_timeout 60s;
    
    # 客户端请求头缓冲区大小
    client_header_buffer_size 1k;
    
    # 大请求头缓冲区（当client_header_buffer_size不够时使用）
    large_client_header_buffers 4 8k;
    
    # 客户端请求体缓冲区大小
    client_body_buffer_size 128k;
    
    # 客户端请求体临时文件路径
    client_body_temp_path /var/cache/nginx/client_temp;
}
```

**常见场景**：
- 文件上传：需要增加 `client_max_body_size`
- 大请求头：需要增加 `large_client_header_buffers`
- 慢速客户端：需要增加超时时间

#### 文件访问优化

```nginx
http {
    # 文件描述符缓存
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
}
```

**参数说明**：
- `max`: 缓存的最大文件描述符数量
- `inactive`: 非活动文件的缓存时间
- `valid`: 检查文件是否仍然有效的时间间隔
- `min_uses`: 文件被访问的最小次数才缓存
- `errors`: 是否缓存文件打开错误

### 5.3 完整HTTP配置示例

```nginx
http {
    # MIME类型
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       '$request_time $upstream_response_time';
    
    # 访问日志
    access_log /var/log/nginx/access.log main;
    
    # 文件传输优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # 连接保持
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # 客户端配置
    client_max_body_size 20m;
    client_body_timeout 60s;
    client_header_timeout 60s;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    
    # 文件访问优化
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;
    
    # 包含其他配置
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

## 六、server配置块（Server Context）

### 6.1 基本结构

```nginx
server {
    # ============================================
    # 监听配置
    # ============================================
    listen 80;
    listen [::]:80;  # IPv6
    
    # ============================================
    # 服务器名称（域名）
    # ============================================
    server_name example.com www.example.com;
    
    # ============================================
    # 网站根目录和索引
    # ============================================
    root /var/www/html;
    index index.html index.htm index.php;
    
    # ============================================
    # 日志配置
    # ============================================
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log;
    
    # ============================================
    # 字符集配置
    # ============================================
    charset utf-8;
    
    # ============================================
    # 位置配置
    # ============================================
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 6.2 listen指令详解

```nginx
# 基本语法
listen address[:port] [default_server] [ssl] [http2] [spdy] [proxy_protocol];

# 监听80端口（IPv4和IPv6）
listen 80;
listen [::]:80;

# 只监听IPv4
listen 0.0.0.0:80;
listen 127.0.0.1:80;

# 只监听IPv6
listen [::]:80 ipv6only=on;

# 监听HTTPS
listen 443 ssl;

# 监听HTTP/2
listen 443 ssl http2;

# 设置为默认服务器
listen 80 default_server;

# 监听多个端口
listen 80;
listen 8080;
listen 8443 ssl http2;

# 监听Unix套接字（用于本地通信）
listen unix:/var/run/nginx.sock;
```

**常用参数说明**：
- `default_server`: 设置为默认服务器（处理未匹配的请求）
- `ssl`: 启用SSL/TLS
- `http2`: 启用HTTP/2（需要SSL）
- `proxy_protocol`: 启用PROXY协议支持

**端口监听优先级**：
1. 精确匹配的listen指令
2. 带default_server的listen指令
3. 第一个匹配的listen指令

### 6.3 server_name指令详解

```nginx
# 基本语法
server_name name1 name2 ...;

# 单个域名
server_name example.com;

# 多个域名
server_name example.com www.example.com example.org;

# 通配符域名（以*开头）
server_name *.example.com;
# 匹配：a.example.com, b.example.com
# 不匹配：example.com, a.b.example.com

# 通配符域名（以*结尾）
server_name example.*;
# 匹配：example.com, example.org
# 不匹配：www.example.com

# 正则表达式域名（区分大小写）
server_name ~^www\.(.+)$;
# 匹配：www.example.com，捕获example.com

# 正则表达式域名（不区分大小写）
server_name ~^(?<subdomain>.+)\.example\.com$;
# 匹配：api.example.com，捕获api

# 默认服务器（匹配所有未定义的域名）
server_name _;

# 空server_name（匹配没有Host头的请求）
server_name "";
```

**server_name匹配优先级**：

1. **精确匹配**
   ```nginx
   server_name example.com;  # 最高优先级
   ```

2. **以*开头的通配符**
   ```nginx
   server_name *.example.com;
   ```

3. **以*结尾的通配符**
   ```nginx
   server_name example.*;
   ```

4. **正则表达式匹配**（按配置顺序）
   ```nginx
   server_name ~^www\.(.+)$;
   ```

5. **默认服务器**
   ```nginx
   server_name _;
   listen 80 default_server;
   ```

**实际匹配示例**：

```nginx
# 请求：www.example.com
server {
    server_name www.example.com;  # ✅ 匹配（精确匹配）
}

# 请求：api.example.com
server {
    server_name *.example.com;  # ✅ 匹配（通配符）
}

# 请求：example.com
server {
    server_name ~^www\.(.+)$;  # ❌ 不匹配
    server_name example.com;    # ✅ 匹配
}
```

### 6.4 root和index指令

```nginx
server {
    # 网站根目录
    root /var/www/html;
    
    # 默认索引文件（按顺序查找）
    index index.html index.htm index.php;
    
    # 如果请求是目录，按index顺序查找文件
    # 例如：请求 / 会查找 /index.html, /index.htm, /index.php
}
```

**root vs alias**：

```nginx
# root指令：将location路径追加到root路径后
location /images/ {
    root /var/www/html;
    # 请求 /images/logo.png
    # 实际文件：/var/www/html/images/logo.png
}

# alias指令：替换location路径
location /images/ {
    alias /var/www/images/;
    # 请求 /images/logo.png
    # 实际文件：/var/www/images/logo.png
}
```

### 6.5 完整server配置示例

```nginx
server {
    # 监听配置
    listen 80;
    listen [::]:80;
    
    # 服务器名称
    server_name example.com www.example.com;
    
    # 网站根目录
    root /var/www/example.com;
    
    # 默认索引文件
    index index.html index.htm;
    
    # 字符集
    charset utf-8;
    
    # 日志配置
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log warn;
    
    # 错误页面
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # 位置配置
    location / {
        try_files $uri $uri/ =404;
    }
}
```

## 七、location配置块（Location Context）

### 7.1 基本语法

```nginx
location [修饰符] 匹配模式 {
    # 配置指令
}
```

**匹配模式类型**：
- 前缀匹配：`/path`
- 精确匹配：`= /path`
- 正则匹配：`~ pattern` 或 `~* pattern`
- 最长前缀匹配：`^~ /path`

### 7.2 匹配修饰符详解

#### 精确匹配（=）

```nginx
# 只匹配完全相同的路径
location = / {
    # 只匹配 http://example.com/
    # 不匹配 http://example.com/index.html
    return 301 /index.html;
}

location = /favicon.ico {
    # 只匹配 /favicon.ico
    log_not_found off;
    access_log off;
}
```

**特点**：
- 优先级最高
- 只匹配完全相同的路径
- 常用于首页或特定文件

#### 前缀匹配（无修饰符）

```nginx
# 匹配所有以指定路径开头的URL
location / {
    # 匹配所有URL：/, /index.html, /images/logo.png 等
    root /var/www/html;
    index index.html;
}

location /api {
    # 匹配：/api, /api/users, /api/users/123 等
    proxy_pass http://backend;
}
```

**特点**：
- 匹配所有以指定路径开头的URL
- 优先级最低（在正则匹配之后）
- 最常用的匹配方式

#### 正则匹配（~ 区分大小写）

```nginx
# 区分大小写的正则表达式
location ~ \.php$ {
    # 匹配：.php结尾的文件（区分大小写）
    # 匹配：index.php, test.PHP
    # 不匹配：index.PHP（如果严格区分大小写）
    fastcgi_pass 127.0.0.1:9000;
}

location ~ ^/user/(\d+)$ {
    # 匹配：/user/123, /user/456
    # 捕获组：$1 = 123, $1 = 456
    proxy_pass http://backend/user/$1;
}
```

#### 正则匹配（~* 不区分大小写）

```nginx
# 不区分大小写的正则表达式
location ~* \.(jpg|jpeg|png|gif|ico)$ {
    # 匹配：logo.jpg, LOGO.JPG, image.PNG 等（不区分大小写）
    expires 30d;
    add_header Cache-Control "public, immutable";
}

location ~* \.(css|js)$ {
    # 匹配：style.css, SCRIPT.JS 等
    expires 7d;
}
```

#### 最长前缀匹配（^~）

```nginx
# 如果匹配，不再检查正则表达式
location ^~ /images/ {
    # 匹配：/images/logo.png, /images/banner.jpg
    # 如果匹配，直接使用此location，不再检查其他正则location
    root /var/www;
    expires 1y;
}

location ^~ /static/ {
    # 匹配：/static/css/style.css
    # 优先级高于正则匹配
    alias /var/www/static/;
}
```

**特点**：
- 如果匹配，跳过所有正则匹配
- 优先级高于正则匹配
- 用于静态资源等不需要正则的场景

### 7.3 匹配优先级详解

**完整匹配顺序**：

1. **精确匹配** (`=`)
   ```nginx
   location = / { }  # 最高优先级
   ```

2. **最长前缀匹配** (`^~`)
   ```nginx
   location ^~ /images/ { }  # 如果匹配，跳过正则
   ```

3. **正则匹配** (`~` 或 `~*`，按配置顺序)
   ```nginx
   location ~ \.php$ { }  # 第一个正则
   location ~ \.html$ { }  # 第二个正则
   ```

4. **前缀匹配**（无修饰符）
   ```nginx
   location / { }  # 最低优先级，作为默认匹配
   ```

**匹配示例**：

```nginx
server {
    # 请求：http://example.com/
    location = / { }           # ✅ 匹配（精确匹配，优先级1）
    
    # 请求：http://example.com/images/logo.png
    location ^~ /images/ { }   # ✅ 匹配（最长前缀，优先级2）
    location ~ \.(jpg|png)$ { } # ❌ 不检查（因为^~已匹配）
    
    # 请求：http://example.com/index.php
    location ~ \.php$ { }     # ✅ 匹配（正则匹配，优先级3）
    location / { }            # ❌ 不匹配（正则已匹配）
    
    # 请求：http://example.com/about
    location ~ \.php$ { }     # ❌ 不匹配
    location / { }            # ✅ 匹配（前缀匹配，优先级4）
}
```

### 7.4 常用location配置示例

#### 静态文件服务

```nginx
server {
    root /var/www/html;
    
    # 静态资源（图片、字体等）
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # CSS和JS文件
    location ~* \.(css|js)$ {
        expires 7d;
        add_header Cache-Control "public";
    }
    
    # 默认位置
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

#### PHP应用配置

```nginx
server {
    root /var/www/html;
    index index.php index.html;
    
    # PHP文件处理
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 默认位置
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
}
```

#### 前后端分离配置

```nginx
server {
    root /var/www/frontend;
    index index.html;
    
    # 前端静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # WebSocket代理
    location /ws {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}
```

#### 文件下载配置

```nginx
server {
    root /var/www/downloads;
    
    # 下载目录
    location /download {
        alias /var/www/downloads;
        
        # 强制下载
        add_header Content-Disposition "attachment";
        
        # 限制下载速度
        limit_rate 1m;
    }
    
    # 禁止访问特定文件类型
    location ~ \.(sql|log|conf|bak)$ {
        deny all;
        access_log off;
    }
}
```

### 7.5 location嵌套（不推荐）

```nginx
location / {
    # 外层location
    
    location /images {
        # 内层location（不推荐使用）
        # 可能导致配置复杂和性能问题
    }
}
```

**注意**：location嵌套会增加配置复杂度，通常不推荐使用。

### 7.6 常用location指令详解

#### try_files指令

`try_files` 是location块中最常用的指令之一，用于按顺序尝试查找文件或目录。

**基本语法**：
```nginx
try_files file ... uri;
try_files file ... =code;
```

**工作原理**：
1. 按顺序检查每个文件或目录是否存在
2. 如果找到，返回该文件
3. 如果所有文件都不存在，执行最后一个参数（URI或状态码）

**常用示例**：

```nginx
# 示例1：基本用法（查找文件，找不到返回404）
location / {
    root /var/www/html;
    try_files $uri $uri/ =404;
}
# 说明：
# - 首先尝试 $uri（例如：/index.html）
# - 如果不存在，尝试 $uri/（例如：/index.html/，作为目录）
# - 如果都不存在，返回404错误
```

```nginx
# 示例2：前端路由（SPA应用）
location / {
    root /var/www/html;
    try_files $uri $uri/ /index.html;
}
# 说明：
# - 首先尝试 $uri（例如：/about）
# - 如果不存在，尝试 $uri/（例如：/about/）
# - 如果都不存在，返回 /index.html（前端路由处理）
# 这样所有路由都会由前端JavaScript处理
```

```nginx
# 示例3：PHP应用（Laravel、WordPress等）
location / {
    root /var/www/html;
    try_files $uri $uri/ /index.php?$query_string;
}
# 说明：
# - 首先尝试静态文件
# - 如果不存在，尝试目录
# - 如果都不存在，转发到index.php，并保留查询参数
```

```nginx
# 示例4：多级回退
location / {
    root /var/www/html;
    try_files $uri $uri/ /fallback.html /index.html =404;
}
# 说明：
# - 尝试 $uri
# - 尝试 $uri/
# - 尝试 /fallback.html
# - 尝试 /index.html
# - 如果都不存在，返回404
```

**实际应用场景**：

**场景1：静态网站**
```nginx
server {
    root /var/www/html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

**场景2：单页应用（React、Vue、Angular）**
```nginx
server {
    root /var/www/frontend;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源直接返回
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

**场景3：PHP框架（Laravel）**
```nginx
server {
    root /var/www/laravel/public;
    index index.php;
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

**场景4：带条件判断**
```nginx
location / {
    # 如果文件存在，直接返回
    try_files $uri $uri/ @fallback;
}

location @fallback {
    # 内部重定向到后端
    proxy_pass http://127.0.0.1:3000;
}
```

#### root和alias指令

这两个指令都用于指定文件系统的路径，但行为不同。

**root指令**：
```nginx
location /images/ {
    root /var/www/html;
    # 请求：/images/logo.png
    # 实际文件路径：/var/www/html/images/logo.png
    # root会将location路径追加到root路径后
}
```

**alias指令**：
```nginx
location /images/ {
    alias /var/www/images/;
    # 请求：/images/logo.png
    # 实际文件路径：/var/www/images/logo.png
    # alias会替换location路径
    # 注意：alias路径末尾的斜杠很重要
}
```

**区别对比**：

| 指令 | 请求路径 | root路径 | 实际文件路径 |
|------|---------|---------|------------|
| `root /var/www/html;` | `/images/logo.png` | `/var/www/html` | `/var/www/html/images/logo.png` |
| `alias /var/www/images/;` | `/images/logo.png` | `/var/www/images/` | `/var/www/images/logo.png` |

**使用建议**：
- 大多数情况使用 `root`
- 当location路径和文件系统路径不一致时使用 `alias`
- `alias` 路径末尾的斜杠很重要

#### index指令

指定当请求是目录时，按顺序查找的索引文件。

```nginx
# 基本用法
index index.html index.htm index.php;

# 说明：
# - 当请求是目录时（如：/），按顺序查找：
#   1. index.html
#   2. index.htm
#   3. index.php
# - 找到第一个存在的文件就返回
```

**实际示例**：
```nginx
server {
    root /var/www/html;
    index index.html index.php;
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # 请求 / 时：
    # 1. 尝试 /index.html
    # 2. 如果不存在，尝试 /index.php
    # 3. 如果都不存在，返回404
}
```

#### return指令

用于立即返回响应，可以返回状态码、重定向或自定义内容。

**基本语法**：
```nginx
return code [text];
return code URL;
return URL;
```

**常用示例**：

```nginx
# 返回状态码
location /forbidden {
    return 403;
}

# 返回状态码和文本
location /forbidden {
    return 403 "Access Forbidden";
}

# 永久重定向（301）
location /old {
    return 301 /new;
}

# 临时重定向（302）
location /temp {
    return 302 /new;
}

# 自定义响应
location /custom {
    return 200 "Custom Response\n";
    add_header Content-Type text/plain;
}
```

**重定向示例**：
```nginx
# HTTP到HTTPS重定向
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

# 域名重定向
server {
    listen 80;
    server_name www.example.com;
    return 301 https://example.com$request_uri;
}

# 路径重定向
location /old-path {
    return 301 /new-path;
}
```

#### rewrite指令

用于重写URL，比return更灵活，支持正则表达式。

**基本语法**：
```nginx
rewrite regex replacement [flag];
```

**常用标志（flag）**：
- `last`: 停止处理当前rewrite规则，继续匹配location
- `break`: 停止处理所有rewrite规则
- `redirect`: 临时重定向（302）
- `permanent`: 永久重定向（301）

**示例**：

```nginx
# 基本重写
location / {
    rewrite ^/old$ /new last;
    # /old -> /new
}

# 正则捕获
location / {
    rewrite ^/user/(\d+)$ /user.php?id=$1 last;
    # /user/123 -> /user.php?id=123
}

# 条件重写
location / {
    if ($request_uri ~* "^/old/(.*)$") {
        rewrite ^/old/(.*)$ /new/$1 permanent;
    }
}

# 移除www前缀
server {
    server_name www.example.com;
    rewrite ^(.*)$ https://example.com$1 permanent;
}
```

**rewrite vs return**：
- `return`: 简单直接，适合重定向
- `rewrite`: 更灵活，支持正则和复杂逻辑

#### add_header指令

用于添加HTTP响应头。

```nginx
# 基本用法
add_header Header-Name "value";

# 添加多个头
add_header X-Custom-Header "value1";
add_header X-Another-Header "value2";

# 使用always参数（即使状态码不是2xx也添加）
add_header X-Custom-Header "value" always;
```

**常用场景**：

```nginx
# 安全头
location / {
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# CORS头
location /api {
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type" always;
}

# 缓存控制
location ~* \.(jpg|jpeg|png|gif)$ {
    expires 1y;
    add_header Cache-Control "public, immutable" always;
}

# 自定义头
location / {
    add_header X-Served-By "nginx" always;
    add_header X-Request-ID $request_id always;
}
```

#### expires指令

用于设置响应头的Expires和Cache-Control，控制浏览器缓存。

```nginx
# 基本用法
expires time;

# 常用时间格式
expires 30d;        # 30天
expires 1y;         # 1年
expires 1h;         # 1小时
expires -1;         # 不缓存
expires epoch;       # 不缓存（明确设置）
expires max;        # 最大缓存（10年）
expires off;        # 不设置expires头
```

**示例**：

```nginx
# 静态资源长期缓存
location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# CSS和JS文件短期缓存
location ~* \.(css|js)$ {
    expires 7d;
    add_header Cache-Control "public";
}

# HTML文件不缓存
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# 动态内容不缓存
location /api {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
}
```

#### access_log和error_log指令

控制访问日志和错误日志的写入。

```nginx
# 访问日志
access_log path [format [buffer=size] [flush=time] [if=condition]];
access_log off;  # 禁用访问日志

# 错误日志
error_log file [level];
error_log off;   # 禁用错误日志（不推荐）
```

**示例**：

```nginx
server {
    # 全局访问日志
    access_log /var/log/nginx/access.log;
    
    # 特定location禁用日志
    location /health {
        access_log off;
        return 200 "OK";
    }
    
    # 使用条件记录
    map $status $loggable {
        ~^[23]  0;  # 2xx和3xx不记录
        default 1;
    }
    access_log /var/log/nginx/access.log combined if=$loggable;
    
    # 错误日志
    error_log /var/log/nginx/error.log warn;
    
    # 特定location的错误日志
    location /api {
        error_log /var/log/nginx/api.error.log debug;
    }
}
```

#### deny和allow指令

用于访问控制，基于IP地址。

```nginx
# 基本用法
allow address | CIDR | all;
deny address | CIDR | all;
```

**示例**：

```nginx
# IP白名单
location /admin {
    allow 192.168.1.100;
    allow 10.0.0.0/8;
    deny all;
}

# IP黑名单
location / {
    deny 192.168.1.200;
    deny 10.0.0.100;
    allow all;
}

# 复杂规则
location /api {
    allow 192.168.1.0/24;
    deny 192.168.1.100;  # 排除特定IP
    deny all;
}
```

**执行顺序**：
- 按配置顺序执行
- 找到第一个匹配的规则就停止
- 默认是allow all

#### proxy_pass指令

用于反向代理，将请求转发到后端服务器。

```nginx
# 基本语法
proxy_pass URL;

# 示例
location /api {
    proxy_pass http://127.0.0.1:3000;
    # 请求：/api/users
    # 转发到：http://127.0.0.1:3000/api/users
}

location /api/ {
    proxy_pass http://127.0.0.1:3000/;
    # 请求：/api/users
    # 转发到：http://127.0.0.1:3000/users（注意：/api被替换）
}

# 使用upstream
upstream backend {
    server 127.0.0.1:3000;
}

location / {
    proxy_pass http://backend;
}
```

**重要区别**：
- `proxy_pass http://backend;`（无尾随斜杠）：保留location路径
- `proxy_pass http://backend/;`（有尾随斜杠）：替换location路径

#### fastcgi_pass指令

用于FastCGI代理，通常用于PHP应用。

```nginx
location ~ \.php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
}
```

#### 指令优先级和组合使用

多个指令可以组合使用，按以下顺序处理：

```nginx
location / {
    # 1. 访问控制
    allow 192.168.1.0/24;
    deny all;
    
    # 2. 文件查找
    root /var/www/html;
    index index.html;
    try_files $uri $uri/ =404;
    
    # 3. 响应头
    add_header X-Custom "value" always;
    
    # 4. 缓存控制
    expires 1d;
}
```

**最佳实践**：
1. 先配置访问控制（deny/allow）
2. 再配置文件查找（root/index/try_files）
3. 最后配置响应头（add_header/expires）

## 八、配置文件语法规则

### 8.1 基本语法规则

#### 1. 指令以分号结尾

```nginx
# ✅ 正确
worker_processes auto;
listen 80;
root /var/www/html;

# ❌ 错误（缺少分号）
worker_processes auto
listen 80
root /var/www/html
```

**错误示例**：
```bash
# 测试配置时会报错
nginx -t
# nginx: [emerg] unexpected end of file, expecting ";" in /etc/nginx/nginx.conf:10
```

#### 2. 块用大括号包围

```nginx
# ✅ 正确
events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
    }
}

# ❌ 错误（缺少大括号）
events
    worker_connections 1024;

http
    server
        listen 80;
```

#### 3. 指令和参数用空格分隔

```nginx
# ✅ 正确
listen 80;
server_name example.com;
root /var/www/html;

# ❌ 错误（缺少空格）
listen80;
server_nameexample.com;
root/var/www/html;
```

#### 4. 注释使用 # 符号

```nginx
# 这是单行注释

# 这是多行注释
# 可以写多行
# 每行都需要 #

worker_processes auto;  # 这是行内注释

# 注意：不能嵌套注释
# # 这是错误的嵌套注释
```

#### 5. 字符串可以用引号（可选）

```nginx
# 以下两种写法等价
server_name example.com;
server_name "example.com";

# 包含空格的字符串必须用引号
server_name "example.com" "www.example.com";
```

### 8.2 变量使用详解

#### Nginx内置变量

**请求相关变量**：

```nginx
location / {
    # 请求URI（不含参数）
    return 200 "URI: $uri\n";
    # 输出：URI: /index.html
    
    # 完整请求URI（含参数）
    return 200 "Request URI: $request_uri\n";
    # 输出：Request URI: /index.html?id=123
    
    # 查询参数
    return 200 "Args: $args\n";
    # 输出：Args: id=123
    
    # 请求方法
    return 200 "Method: $request_method\n";
    # 输出：Method: GET
    
    # 请求协议
    return 200 "Scheme: $scheme\n";
    # 输出：Scheme: http
}
```

**客户端信息变量**：

```nginx
location / {
    # 客户端IP地址
    return 200 "Remote IP: $remote_addr\n";
    
    # 客户端端口
    return 200 "Remote Port: $remote_port\n";
    
    # 客户端用户名（如果使用HTTP认证）
    return 200 "Remote User: $remote_user\n";
    
    # 用户代理
    return 200 "User Agent: $http_user_agent\n";
    
    # 引用页面
    return 200 "Referer: $http_referer\n";
}
```

**响应相关变量**：

```nginx
location / {
    # 响应状态码
    return 200 "Status: $status\n";
    
    # 响应体大小
    return 200 "Body Size: $body_bytes_sent\n";
    
    # 响应时间
    return 200 "Request Time: $request_time\n";
}
```

**服务器信息变量**：

```nginx
location / {
    # 服务器名称
    return 200 "Server Name: $server_name\n";
    
    # 服务器端口
    return 200 "Server Port: $server_port\n";
    
    # 服务器地址
    return 200 "Server Addr: $server_addr\n";
}
```

**常用变量列表**：

| 变量 | 说明 | 示例 |
|------|------|------|
| `$uri` | 当前请求的URI（不含参数） | `/index.html` |
| `$request_uri` | 完整请求URI（含参数） | `/index.html?id=123` |
| `$args` | 查询参数 | `id=123&name=test` |
| `$request_method` | 请求方法 | `GET`, `POST` |
| `$remote_addr` | 客户端IP地址 | `192.168.1.100` |
| `$http_host` | 请求的Host头 | `example.com` |
| `$http_user_agent` | 用户代理 | `Mozilla/5.0...` |
| `$status` | 响应状态码 | `200`, `404` |
| `$body_bytes_sent` | 响应体大小（字节） | `1024` |
| `$request_time` | 请求处理时间（秒） | `0.123` |

#### 自定义变量

```nginx
# 使用set指令定义变量
set $my_var "hello";
set $my_number 123;
set $my_flag 1;

# 在location中使用
location / {
    set $greeting "Hello";
    set $name "World";
    return 200 "$greeting, $name!\n";
    # 输出：Hello, World!
}

# 变量可以用于条件判断
set $is_mobile 0;
if ($http_user_agent ~* "mobile") {
    set $is_mobile 1;
}
```

#### 变量作用域

```nginx
# HTTP级别的变量
http {
    set $global_var "global";
    
    server {
        # 可以访问global_var
        location / {
            return 200 "$global_var\n";
        }
    }
}

# Server级别的变量
server {
    set $server_var "server";
    
    location / {
        # 可以访问server_var
        return 200 "$server_var\n";
    }
}
```

### 8.3 指令继承和覆盖

#### 继承规则

```nginx
http {
    # HTTP级别的配置
    gzip on;
    gzip_types text/plain text/css;
    
    server {
        # Server级别继承HTTP级别的gzip配置
        # gzip仍然是on
        # 可以覆盖
        # gzip off;
        
        location / {
            # Location级别继承Server和HTTP级别的配置
            # gzip仍然是on（或off，如果server级别覆盖了）
        }
        
        location /api {
            # 可以再次覆盖
            gzip off;
        }
    }
}
```

#### 覆盖示例

```nginx
http {
    # 全局日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request"';
    access_log /var/log/nginx/access.log main;
    
    server {
        # 覆盖日志格式
        log_format custom '$remote_addr "$request"';
        access_log /var/log/nginx/custom.log custom;
        
        location / {
            # 使用server级别的日志配置
        }
        
        location /api {
            # 再次覆盖
            access_log /var/log/nginx/api.log main;
        }
    }
}
```

### 8.4 条件判断（if指令）

**注意**：if指令应该谨慎使用，可能导致意外的行为。

```nginx
# 基本语法
if (condition) {
    # 指令
}

# 条件判断示例
location / {
    # 判断请求方法
    if ($request_method != GET) {
        return 405;
    }
    
    # 判断文件是否存在
    if (!-f $request_filename) {
        return 404;
    }
    
    # 正则匹配
    if ($http_user_agent ~* "bot") {
        return 403;
    }
}
```

**if指令的限制**：
- 不能嵌套
- 某些指令不能在if块中使用
- 可能导致配置复杂和性能问题
- 推荐使用map指令替代

### 8.5 map指令（推荐替代if）

```nginx
# 定义变量映射
map $http_user_agent $is_bot {
    default 0;
    ~*bot 1;
    ~*crawler 1;
    ~*spider 1;
}

server {
    location / {
        # 使用映射的变量
        if ($is_bot) {
            return 403;
        }
    }
}
```

**map的优势**：
- 更清晰和可维护
- 性能更好
- 可以定义复杂的映射规则

## 九、配置文件测试和调试

### 9.1 测试配置文件

#### 基本测试命令

```bash
# 测试配置文件语法
sudo nginx -t

# 输出示例：
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful

# 测试并显示完整配置内容（包括所有include的文件）
sudo nginx -T

# 测试并显示配置文件和路径
sudo nginx -T 2>&1 | grep -E "configuration file|test is"

# 只显示错误信息
sudo nginx -t 2>&1 | grep error
```

#### 测试特定配置文件

```bash
# 测试指定的配置文件
sudo nginx -t -c /path/to/nginx.conf

# 测试并显示配置
sudo nginx -T -c /path/to/nginx.conf
```

#### 测试配置的详细步骤

```bash
# 步骤1：检查语法
sudo nginx -t

# 步骤2：如果语法正确，查看完整配置
sudo nginx -T | less

# 步骤3：检查特定配置
sudo nginx -T | grep -A 10 "server_name"

# 步骤4：验证配置后重载
sudo nginx -s reload
```

### 9.2 查看配置错误

#### 错误日志位置

```bash
# 查看错误日志（实时）
sudo tail -f /var/log/nginx/error.log

# 查看最近的错误（最后50行）
sudo tail -n 50 /var/log/nginx/error.log

# 查看特定错误级别的日志
sudo grep "error" /var/log/nginx/error.log
sudo grep "warn" /var/log/nginx/error.log

# 查看特定时间段的错误
sudo grep "2024-01-12" /var/log/nginx/error.log
```

#### 常见错误类型

**语法错误**：
```bash
# 错误示例：缺少分号
# nginx: [emerg] unexpected end of file, expecting ";" in /etc/nginx/nginx.conf:10

# 解决方法：检查第10行，添加分号
```

**文件不存在**：
```bash
# 错误示例：include的文件不存在
# nginx: [emerg] open() "/etc/nginx/conf.d/missing.conf" failed (2: No such file or directory)

# 解决方法：创建文件或删除include语句
```

**权限错误**：
```bash
# 错误示例：没有读取权限
# nginx: [emerg] open() "/etc/nginx/nginx.conf" failed (13: Permission denied)

# 解决方法：检查文件权限
sudo chmod 644 /etc/nginx/nginx.conf
```

**端口被占用**：
```bash
# 错误示例：端口已被使用
# nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)

# 解决方法：检查端口占用
sudo netstat -tlnp | grep :80
sudo lsof -i :80
```

### 9.3 逐步调试流程

#### 标准调试流程

```bash
# ============================================
# 步骤1：测试配置文件语法
# ============================================
sudo nginx -t

# 如果语法错误，根据错误信息修复
# 常见错误：
# - 缺少分号
# - 括号不匹配
# - 指令拼写错误
# - 文件路径错误

# ============================================
# 步骤2：查看完整配置（验证配置内容）
# ============================================
sudo nginx -T | less

# 检查：
# - 配置是否正确合并
# - include的文件是否正确加载
# - 变量是否正确替换

# ============================================
# 步骤3：重载配置（如果语法正确）
# ============================================
sudo nginx -s reload

# 或者重启Nginx
sudo systemctl reload nginx
# 或
sudo systemctl restart nginx

# ============================================
# 步骤4：查看错误日志
# ============================================
sudo tail -f /var/log/nginx/error.log

# 观察是否有运行时错误

# ============================================
# 步骤5：测试访问
# ============================================
curl -I http://localhost
curl http://localhost

# 或使用浏览器访问
```

#### 调试技巧

**1. 启用调试日志**：

```nginx
# 临时启用调试级别日志
error_log /var/log/nginx/error.log debug;

# 测试后改回warn级别
error_log /var/log/nginx/error.log warn;
```

**2. 使用return指令测试**：

```nginx
location /test {
    # 测试location是否匹配
    return 200 "Location matched!\n";
    add_header Content-Type text/plain;
}
```

**3. 检查变量值**：

```nginx
location /debug {
    # 输出变量值用于调试
    return 200 "URI: $uri\nArgs: $args\nHost: $host\n";
    add_header Content-Type text/plain;
}
```

**4. 使用curl测试**：

```bash
# 测试基本访问
curl http://localhost

# 测试特定路径
curl http://localhost/api/users

# 测试带参数
curl "http://localhost/api/users?id=123"

# 测试POST请求
curl -X POST http://localhost/api/users -d "name=test"

# 查看响应头
curl -I http://localhost

# 详细输出
curl -v http://localhost
```

**5. 检查Nginx进程**：

```bash
# 查看Nginx进程
ps aux | grep nginx

# 查看Nginx主进程PID
cat /var/run/nginx.pid

# 检查Nginx状态
sudo systemctl status nginx
```

### 9.4 常见问题排查

#### 问题1：配置修改后不生效

```bash
# 检查是否重载了配置
sudo nginx -s reload

# 检查Nginx是否正在运行
sudo systemctl status nginx

# 检查配置文件路径是否正确
sudo nginx -t
```

#### 问题2：访问返回404

```bash
# 检查文件是否存在
ls -la /var/www/html/index.html

# 检查文件权限
sudo chmod 644 /var/www/html/index.html
sudo chown www-data:www-data /var/www/html/index.html

# 检查root指令配置
sudo nginx -T | grep root
```

#### 问题3：访问返回403

```bash
# 检查目录权限
ls -ld /var/www/html

# 检查文件权限
ls -la /var/www/html

# 检查SELinux（CentOS/RHEL）
sudo getenforce
sudo setenforce 0  # 临时禁用测试
```

#### 问题4：配置语法正确但功能不工作

```bash
# 检查错误日志
sudo tail -f /var/log/nginx/error.log

# 检查访问日志
sudo tail -f /var/log/nginx/access.log

# 使用调试日志级别
error_log /var/log/nginx/error.log debug;
```

## 十、常用配置模板和最佳实践

### 10.1 最小配置模板

```nginx
# 最小可运行的Nginx配置
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    server {
        listen 80;
        server_name localhost;
        root /var/www/html;
        index index.html;
        
        location / {
            try_files $uri $uri/ =404;
        }
    }
}
```

**说明**：
- 最基础的配置
- 适合学习和测试
- 不包含性能优化和安全配置

### 10.2 开发环境配置

```nginx
user www-data;
worker_processes auto;
error_log /var/log/nginx/error.log debug;  # 开发环境使用debug级别
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 日志格式（开发环境可以更详细）
    log_format dev '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for" '
                   'rt=$request_time';
    
    access_log /var/log/nginx/access.log dev;
    
    # 基础性能配置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript;
    
    # 包含站点配置
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

### 10.3 生产环境配置模板

```nginx
# ============================================
# 全局配置
# ============================================
user nginx;
worker_processes auto;
worker_cpu_affinity auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# ============================================
# 事件配置
# ============================================
events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

# ============================================
# HTTP配置
# ============================================
http {
    # MIME类型
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       '$request_time $upstream_response_time '
                       '$upstream_addr';
    
    # 访问日志
    access_log /var/log/nginx/access.log main;
    
    # 文件传输优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # 连接保持
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # 客户端配置
    client_max_body_size 20m;
    client_body_timeout 60s;
    client_header_timeout 60s;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    client_body_buffer_size 128k;
    
    # 文件访问优化
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
    
    # 类型哈希表大小
    types_hash_max_size 2048;
    server_names_hash_bucket_size 128;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
    
    # 隐藏Nginx版本
    server_tokens off;
    
    # 包含其他配置
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

### 10.4 配置文件组织最佳实践

#### 推荐的文件结构

```
/etc/nginx/
├── nginx.conf                 # 主配置文件（只包含基础配置和include）
├── mime.types                 # MIME类型定义
├── conf.d/                    # 通用配置文件
│   ├── gzip.conf             # Gzip压缩配置
│   ├── security.conf         # 安全配置
│   └── cache.conf            # 缓存配置
└── sites-available/          # 可用站点配置
    ├── example.com           # 站点1配置
    └── test.com              # 站点2配置
```

#### 模块化配置示例

**主配置文件（nginx.conf）**：

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 包含通用配置
    include /etc/nginx/conf.d/*.conf;
    
    # 包含站点配置
    include /etc/nginx/sites-enabled/*;
}
```

**通用配置文件（conf.d/gzip.conf）**：

```nginx
# Gzip压缩配置
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_min_length 1000;
gzip_types text/plain text/css text/xml text/javascript 
           application/json application/javascript application/xml+rss;
```

**通用配置文件（conf.d/security.conf）**：

```nginx
# 安全配置
server_tokens off;

# 安全响应头（可以在server块中覆盖）
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
```

**站点配置文件（sites-available/example.com）**：

```nginx
server {
    listen 80;
    server_name example.com www.example.com;
    
    root /var/www/example.com;
    index index.html;
    
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
}
```

### 10.5 配置验证清单

在部署配置前，检查以下项目：

- [ ] 配置文件语法正确（`nginx -t`）
- [ ] 所有include的文件存在
- [ ] 文件路径和权限正确
- [ ] 端口没有被占用
- [ ] 日志目录存在且有写权限
- [ ] 网站根目录存在且有读权限
- [ ] SSL证书路径正确（如果使用HTTPS）
- [ ] 上游服务器可访问（如果使用代理）
- [ ] 防火墙规则已配置
- [ ] 错误日志级别合适（生产环境使用warn）

### 10.6 配置备份和版本控制

```bash
# 备份配置文件
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup.$(date +%Y%m%d)

# 备份整个配置目录
sudo tar -czf nginx-config-backup-$(date +%Y%m%d).tar.gz /etc/nginx/

# 使用Git管理配置（推荐）
cd /etc/nginx
sudo git init
sudo git add .
sudo git commit -m "Initial nginx configuration"
```

## 十一、常见配置错误和解决方案

### 11.1 语法错误

**错误1：缺少分号**

```nginx
# ❌ 错误
worker_processes auto
listen 80

# ✅ 正确
worker_processes auto;
listen 80;
```

**错误2：括号不匹配**

```nginx
# ❌ 错误
events {
    worker_connections 1024;
# 缺少闭合括号

# ✅ 正确
events {
    worker_connections 1024;
}
```

**错误3：指令拼写错误**

```nginx
# ❌ 错误
worker_proceses auto;  # 拼写错误
listn 80;              # 拼写错误

# ✅ 正确
worker_processes auto;
listen 80;
```

### 11.2 路径错误

**错误1：文件不存在**

```nginx
# ❌ 错误
include /etc/nginx/nonexistent.conf;

# ✅ 正确
# 确保文件存在，或使用可选包含
```

**错误2：路径权限不足**

```bash
# 检查文件权限
ls -la /etc/nginx/nginx.conf

# 修复权限
sudo chmod 644 /etc/nginx/nginx.conf
sudo chown root:root /etc/nginx/nginx.conf
```

### 11.3 逻辑错误

**错误1：location匹配顺序错误**

```nginx
# ❌ 错误顺序
location / {
    # 这个会匹配所有请求，包括/api
}

location /api {
    # 永远不会执行
}

# ✅ 正确顺序
location /api {
    # 先匹配更具体的路径
}

location / {
    # 最后匹配通用路径
}
```

**错误2：变量作用域错误**

```nginx
# ❌ 错误：在location外使用location变量
set $var $uri;  # $uri在location外可能未定义

# ✅ 正确：在location内使用
location / {
    set $var $uri;
}
```

### 11.4 性能问题

**问题1：worker_connections设置过大**

```nginx
# ❌ 可能的问题
worker_connections 100000;  # 超过系统限制

# ✅ 正确：根据系统限制设置
# 先检查：ulimit -n
worker_connections 2048;
```

**问题2：日志级别过高**

```nginx
# ❌ 生产环境使用debug级别
error_log /var/log/nginx/error.log debug;

# ✅ 生产环境使用warn级别
error_log /var/log/nginx/error.log warn;
```

## 十二、配置文件优化建议

### 12.1 性能优化

1. **合理设置worker_processes**
   ```nginx
   worker_processes auto;  # 自动检测CPU核心数
   ```

2. **优化worker_connections**
   ```nginx
   events {
       worker_connections 2048;  # 根据实际需求设置
   }
   ```

3. **启用文件传输优化**
   ```nginx
   sendfile on;
   tcp_nopush on;
   ```

4. **配置文件缓存**
   ```nginx
   open_file_cache max=10000 inactive=30s;
   ```

### 12.2 安全优化

1. **隐藏服务器信息**
   ```nginx
   server_tokens off;
   ```

2. **限制请求大小**
   ```nginx
   client_max_body_size 10m;
   ```

3. **配置超时**
   ```nginx
   client_body_timeout 10s;
   client_header_timeout 10s;
   ```

### 12.3 可维护性优化

1. **模块化配置**
   - 使用include分离配置
   - 每个站点使用独立文件

2. **添加注释**
   ```nginx
   # 这个配置用于...
   location /api {
       # 代理到后端服务器
   }
   ```

3. **使用有意义的变量名**
   ```nginx
   set $backend_url "http://127.0.0.1:3000";
   ```

## 十三、下一步学习

完成本课后，你应该能够：

- ✅ 理解Nginx配置文件的结构和层次关系
- ✅ 掌握所有主要配置指令的含义和用法
- ✅ 理解配置文件的语法规则和最佳实践
- ✅ 能够测试、调试和排查配置问题
- ✅ 编写清晰、可维护的Nginx配置
- ✅ 理解变量、继承、匹配优先级等高级概念
- ✅ 掌握配置文件组织和管理方法

接下来可以学习：

1. **第3课：虚拟主机配置** - 学习如何配置多个网站，掌握server块的匹配规则
2. **第4课：反向代理** - 学习反向代理和负载均衡配置，掌握upstream和proxy_pass的使用

## 十四、总结

### 核心要点

1. **配置文件结构**
   - Nginx采用层次化的块结构
   - 主要包含：Main、Events、HTTP、Server、Location上下文
   - 每个上下文有特定的指令和作用域

2. **语法规则**
   - 指令以分号结尾
   - 块用大括号包围
   - 指令和参数用空格分隔
   - 注释使用#符号

3. **配置继承**
   - 子上下文继承父上下文的配置
   - 可以在子上下文中覆盖父配置
   - 理解继承关系有助于编写清晰配置

4. **匹配优先级**
   - Location匹配有明确的优先级规则
   - 精确匹配 > 最长前缀匹配 > 正则匹配 > 前缀匹配
   - 理解优先级可以避免配置冲突

5. **测试和调试**
   - 使用`nginx -t`测试配置语法
   - 使用`nginx -T`查看完整配置
   - 查看错误日志排查问题
   - 逐步调试是解决问题的关键

6. **最佳实践**
   - 模块化组织配置文件
   - 使用include分离配置
   - 添加适当的注释
   - 定期备份配置
   - 使用版本控制管理配置

### 学习建议

- **多实践**：每学一个概念，立即编写配置验证
- **多测试**：修改配置后，使用`nginx -t`测试
- **多阅读**：阅读Nginx官方文档和示例配置
- **多总结**：遇到问题及时记录和总结

掌握配置文件的结构和语法是掌握Nginx的基础。通过本课的学习，你已经具备了编写、测试和调试Nginx配置的能力。接下来可以开始学习更高级的配置技巧了！
