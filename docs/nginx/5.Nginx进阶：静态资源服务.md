---
title: Nginx进阶：静态资源服务
date: 2026-01-12
description: 学习如何优化Nginx静态资源服务，包括缓存、压缩、目录浏览等配置
---

# Nginx进阶：静态资源服务

## 一、静态资源服务基础

### 1.1 什么是静态资源

静态资源是指不需要服务器动态处理就能直接返回给客户端的文件，包括：
- HTML文件
- CSS样式表
- JavaScript文件
- 图片（JPG、PNG、GIF、WebP等）
- 字体文件
- 视频、音频文件

### 1.2 Nginx作为静态资源服务器的优势

- **高性能**：直接读取文件，无需动态处理
- **低资源消耗**：CPU和内存占用少
- **高并发**：可以同时处理大量请求
- **易于缓存**：静态资源易于缓存

## 二、基本静态文件配置

### 2.1 最简单的配置

```nginx
server {
    listen 80;
    server_name example.com;
    root /var/www/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 2.2 文件类型配置

```nginx
http {
    # MIME类型配置
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 自定义MIME类型
    types {
        text/html html htm;
        text/css css;
        application/javascript js;
        image/jpeg jpg jpeg;
        image/png png;
        image/gif gif;
        image/webp webp;
    }
}
```

### 2.3 文件访问控制

```nginx
server {
    root /var/www/html;
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 禁止访问特定文件类型
    location ~ \.(sql|log|conf)$ {
        deny all;
    }
    
    # 允许访问特定目录
    location /public {
        allow all;
    }
    
    # 禁止访问特定目录
    location /private {
        deny all;
    }
}
```

## 三、文件缓存配置

### 3.1 浏览器缓存（Expires）

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
    expires 30d;  # 缓存30天
    add_header Cache-Control "public, immutable";
}
```

### 3.2 Cache-Control头

```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    # 使用Cache-Control
    add_header Cache-Control "public, max-age=2592000";  # 30天
    
    # 或者使用expires指令
    expires 30d;
}
```

### 3.3 不同文件类型的缓存策略

```nginx
# 图片、字体等长期不变的资源
location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
    expires 1y;  # 缓存1年
    add_header Cache-Control "public, immutable";
}

# CSS、JS文件
location ~* \.(css|js)$ {
    expires 7d;  # 缓存7天
    add_header Cache-Control "public";
}

# HTML文件（不缓存或短时间缓存）
location ~* \.html$ {
    expires -1;  # 不缓存
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
```

### 3.4 ETag和Last-Modified

```nginx
# ETag用于缓存验证
location / {
    etag on;
    if_modified_since exact;
}
```

## 四、Gzip压缩

### 4.1 启用Gzip压缩

```nginx
http {
    # 启用Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_min_length 1000;
    gzip_disable "msie6";
}
```

### 4.2 Gzip配置说明

- **gzip on**: 启用Gzip压缩
- **gzip_vary on**: 添加Vary: Accept-Encoding头
- **gzip_proxied**: 对代理请求也进行压缩
- **gzip_comp_level**: 压缩级别（1-9，6是平衡点）
- **gzip_types**: 需要压缩的MIME类型
- **gzip_min_length**: 最小压缩文件大小
- **gzip_disable**: 禁用某些浏览器的压缩

### 4.3 针对特定位置启用压缩

```nginx
location /api {
    gzip on;
    gzip_types application/json;
    proxy_pass http://backend;
}
```

## 五、Brotli压缩（需要模块）

### 5.1 安装Brotli模块

```bash
# 需要编译时添加brotli模块
# 或使用预编译版本
```

### 5.2 Brotli配置

```nginx
http {
    brotli on;
    brotli_comp_level 6;
    brotli_types text/plain text/css application/json application/javascript;
    brotli_min_length 1000;
}
```

## 六、目录浏览

### 6.1 启用目录浏览

```nginx
location /files {
    alias /var/www/files;
    autoindex on;  # 启用目录浏览
    autoindex_exact_size off;  # 显示文件大小（KB/MB）
    autoindex_localtime on;  # 使用本地时间
}
```

### 6.2 目录浏览配置

```nginx
location /downloads {
    root /var/www;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    
    # 自定义目录浏览样式
    autoindex_format html;
    
    # 添加下载链接
    add_header Content-Disposition "attachment";
}
```

### 6.3 禁用目录浏览

```nginx
location / {
    autoindex off;  # 禁用目录浏览
    try_files $uri $uri/ =404;
}
```

## 七、文件下载配置

### 7.1 强制下载

```nginx
location /download {
    root /var/www;
    
    # 强制下载所有文件
    add_header Content-Disposition "attachment";
}

# 或者针对特定文件类型
location ~* \.(pdf|doc|docx|zip|rar)$ {
    root /var/www;
    add_header Content-Disposition "attachment";
}
```

### 7.2 限制下载速度

```nginx
location /download {
    root /var/www;
    
    # 限制下载速度为100KB/s
    limit_rate 100k;
    
    # 限制连接数
    limit_conn perip 1;
}
```

### 7.3 断点续传

```nginx
location /download {
    root /var/www;
    
    # 启用断点续传（默认已启用）
    # 需要设置正确的Content-Range头
}
```

## 八、静态资源优化

### 8.1 文件访问优化

```nginx
http {
    # 启用sendfile（零拷贝）
    sendfile on;
    
    # TCP优化
    tcp_nopush on;
    tcp_nodelay on;
    
    # 文件描述符缓存
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
}
```

### 8.2 open_file_cache说明

- **max**: 缓存的最大文件描述符数量
- **inactive**: 非活动文件的缓存时间
- **valid**: 检查文件是否仍然有效的时间间隔
- **min_uses**: 文件被访问的最小次数才缓存
- **errors**: 是否缓存文件打开错误

### 8.3 静态资源CDN配置

```nginx
# 本地静态资源
location /static {
    root /var/www;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# CDN回源配置
location /cdn {
    proxy_pass http://cdn.example.com;
    proxy_cache_valid 200 1y;
    proxy_cache_key "$scheme$request_method$host$request_uri";
}
```

## 九、图片优化

### 9.1 图片格式处理

```nginx
# WebP支持检测（需要模块）
location ~* \.(jpg|jpeg|png)$ {
    root /var/www/images;
    
    # 如果浏览器支持WebP，返回WebP格式
    set $webp "";
    if ($http_accept ~* "webp") {
        set $webp ".webp";
    }
    
    try_files "${uri}${webp}" $uri =404;
}
```

### 9.2 图片响应式

```nginx
# 根据设备返回不同尺寸的图片（需要模块或后端处理）
location /images {
    root /var/www;
    
    # 可以通过URL参数控制图片尺寸
    # /images/photo.jpg?w=800&h=600
}
```

## 十、字体文件配置

### 10.1 字体文件CORS

```nginx
location ~* \.(woff|woff2|ttf|eot|otf)$ {
    root /var/www/fonts;
    expires 1y;
    add_header Cache-Control "public, immutable";
    
    # CORS头（跨域字体）
    add_header Access-Control-Allow-Origin "*";
}
```

### 10.2 字体文件MIME类型

```nginx
http {
    types {
        font/woff woff;
        font/woff2 woff2;
        font/truetype ttf;
        font/opentype otf;
        application/vnd.ms-fontobject eot;
    }
}
```

## 十一、完整配置示例

### 11.1 生产环境静态资源配置

```nginx
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 文件访问优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # 文件描述符缓存
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;
    gzip_min_length 1000;
    
    server {
        listen 80;
        server_name example.com;
        root /var/www/html;
        index index.html;
        
        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        location ~* \.(css|js)$ {
            expires 7d;
            add_header Cache-Control "public";
        }
        
        location ~* \.(woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Access-Control-Allow-Origin "*";
        }
        
        # HTML不缓存
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # 禁止访问隐藏文件
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
        
        # 默认位置
        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
```

## 十二、性能监控

### 12.1 访问日志分析

```bash
# 分析静态资源访问
tail -f /var/log/nginx/access.log | grep -E "\.(jpg|png|css|js)"

# 统计静态资源请求
awk '{print $7}' /var/log/nginx/access.log | grep -E "\.(jpg|png|css|js)" | sort | uniq -c | sort -rn
```

### 12.2 缓存命中率

```nginx
# 使用Nginx Plus或第三方模块监控缓存命中率
```

## 十三、下一步学习

完成本课后，你应该能够：

- ✅ 配置基本的静态文件服务
- ✅ 配置文件缓存策略
- ✅ 启用Gzip压缩
- ✅ 配置目录浏览和文件下载
- ✅ 优化静态资源性能

接下来可以学习：

1. **第6课：SSL/TLS配置** - 学习如何配置HTTPS
2. **第7课：日志管理** - 学习如何管理和分析日志

## 十四、总结

- 静态资源服务是Nginx的核心功能之一
- 合理配置缓存可以大幅提升性能
- Gzip压缩可以减少传输数据量
- 使用sendfile和open_file_cache优化文件访问
- 不同文件类型应该使用不同的缓存策略

掌握静态资源服务配置后，你就可以构建高性能的Web应用了！
