---
title: Nginx基础：虚拟主机配置
date: 2026-01-12
description: 学习如何配置虚拟主机，实现一个Nginx服务器托管多个网站
---

# Nginx基础：虚拟主机配置

## 一、什么是虚拟主机

虚拟主机（Virtual Host）是指在一台物理服务器上运行多个网站的技术。每个网站可以有独立的域名、独立的配置，但共享同一台服务器的资源。

### 1.1 虚拟主机的优势

- **节省成本**：一台服务器可以托管多个网站
- **资源利用**：充分利用服务器资源
- **管理灵活**：每个网站可以独立配置
- **易于扩展**：可以随时添加新的网站

### 1.2 虚拟主机的类型

1. **基于域名的虚拟主机**（Name-based Virtual Host）
   - 通过不同的域名区分网站
   - 最常用的方式

2. **基于端口的虚拟主机**（Port-based Virtual Host）
   - 通过不同的端口区分网站
   - 适用于开发环境或特殊场景

3. **基于IP的虚拟主机**（IP-based Virtual Host）
   - 通过不同的IP地址区分网站
   - 需要多个IP地址，较少使用

## 二、基于域名的虚拟主机

### 2.1 基本配置

```nginx
# 网站1：example.com
server {
    listen 80;
    server_name example.com;
    root /var/www/example.com;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# 网站2：test.com
server {
    listen 80;
    server_name test.com;
    root /var/www/test.com;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 2.2 配置步骤

#### 步骤1：创建网站目录

```bash
# 创建网站根目录
sudo mkdir -p /var/www/example.com
sudo mkdir -p /var/www/test.com

# 设置权限
sudo chown -R www-data:www-data /var/www/example.com
sudo chown -R www-data:www-data /var/www/test.com
```

#### 步骤2：创建测试页面

```bash
# 为example.com创建首页
echo "<h1>Welcome to example.com</h1>" | sudo tee /var/www/example.com/index.html

# 为test.com创建首页
echo "<h1>Welcome to test.com</h1>" | sudo tee /var/www/test.com/index.html
```

#### 步骤3：配置Nginx

```bash
# 编辑配置文件
sudo nano /etc/nginx/sites-available/example.com
```

```nginx
server {
    listen 80;
    server_name example.com www.example.com;
    root /var/www/example.com;
    index index.html index.htm;
    
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

#### 步骤4：启用站点

```bash
# 创建符号链接（Ubuntu/Debian）
sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载配置
sudo nginx -s reload
```

#### 步骤5：配置本地DNS（测试用）

```bash
# 编辑hosts文件
sudo nano /etc/hosts

# 添加以下内容（将IP替换为你的服务器IP）
127.0.0.1 example.com
127.0.0.1 test.com
```

### 2.3 多个域名指向同一网站

```nginx
server {
    listen 80;
    server_name example.com www.example.com example.org www.example.org;
    root /var/www/example.com;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 2.4 通配符域名

```nginx
server {
    listen 80;
    server_name *.example.com;
    root /var/www/example.com;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

## 三、基于端口的虚拟主机

### 3.1 基本配置

```nginx
# 网站1：监听80端口
server {
    listen 80;
    server_name localhost;
    root /var/www/site1;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# 网站2：监听8080端口
server {
    listen 8080;
    server_name localhost;
    root /var/www/site2;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

### 3.2 访问方式

- 网站1：`http://localhost` 或 `http://localhost:80`
- 网站2：`http://localhost:8080`

### 3.3 防火墙配置

```bash
# Ubuntu/Debian
sudo ufw allow 8080/tcp

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload
```

## 四、默认服务器（Default Server）

### 4.1 什么是默认服务器

当请求的域名不匹配任何server_name时，Nginx会使用默认服务器处理请求。

### 4.2 配置默认服务器

#### 方法1：使用default_server参数

```nginx
server {
    listen 80 default_server;
    server_name _;
    root /var/www/default;
    index index.html;
    
    location / {
        return 444;  # 关闭连接
    }
}
```

#### 方法2：第一个server块

```nginx
# 第一个server块自动成为默认服务器
server {
    listen 80;
    server_name example.com;
    # ...
}

server {
    listen 80;
    server_name test.com;
    # ...
}
```

### 4.3 默认服务器最佳实践

```nginx
# 配置一个默认服务器，返回错误或重定向
server {
    listen 80 default_server;
    server_name _;
    
    # 返回444（关闭连接）
    return 444;
    
    # 或者重定向到主网站
    # return 301 http://example.com$request_uri;
}
```

## 五、server块的匹配规则

### 5.1 匹配优先级

1. **精确匹配的server_name**
   ```nginx
   server {
       server_name example.com;  # 最高优先级
   }
   ```

2. **以*开头的通配符**
   ```nginx
   server {
       server_name *.example.com;
   }
   ```

3. **以*结尾的通配符**
   ```nginx
   server {
       server_name example.*;
   }
   ```

4. **正则表达式匹配**
   ```nginx
   server {
       server_name ~^www\.(.+)$;
   }
   ```

5. **默认服务器**
   ```nginx
   server {
       listen 80 default_server;
       server_name _;
   }
   ```

### 5.2 匹配示例

```nginx
# 请求：www.example.com
server {
    server_name www.example.com;  # ✅ 匹配（精确匹配）
}

# 请求：test.example.com
server {
    server_name *.example.com;  # ✅ 匹配（通配符）
}

# 请求：example.com
server {
    server_name ~^www\.(.+)$;  # ❌ 不匹配
    server_name example.com;    # ✅ 匹配
}
```

## 六、完整配置示例

### 6.1 多站点配置

```nginx
# /etc/nginx/nginx.conf
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    keepalive_timeout 65;
    
    # 包含站点配置
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

### 6.2 独立站点配置文件

```nginx
# /etc/nginx/sites-available/example.com
server {
    listen 80;
    server_name example.com www.example.com;
    
    root /var/www/example.com;
    index index.html index.htm;
    
    # 日志
    access_log /var/log/nginx/example.com.access.log main;
    error_log /var/log/nginx/example.com.error.log;
    
    # 字符集
    charset utf-8;
    
    # 位置配置
    location / {
        try_files $uri $uri/ =404;
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 静态文件缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 6.3 启用和禁用站点

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/

# 禁用站点
sudo rm /etc/nginx/sites-enabled/example.com

# 测试配置
sudo nginx -t

# 重载配置
sudo nginx -s reload
```

## 七、常见问题解决

### 7.1 域名无法访问

**问题**：配置了虚拟主机，但无法访问

**检查步骤**：

1. **检查DNS解析**
   ```bash
   # 测试域名解析
   nslookup example.com
   dig example.com
   ```

2. **检查server_name配置**
   ```bash
   # 查看配置
   sudo nginx -T | grep server_name
   ```

3. **检查网站目录权限**
   ```bash
   # 检查目录权限
   ls -la /var/www/example.com
   
   # 设置正确权限
   sudo chown -R www-data:www-data /var/www/example.com
   sudo chmod -R 755 /var/www/example.com
   ```

### 7.2 访问错误页面

**问题**：访问网站显示403 Forbidden或404 Not Found

**解决方法**：

```nginx
# 确保index文件存在
index index.html index.htm index.php;

# 检查文件权限
sudo chmod 644 /var/www/example.com/index.html
sudo chown www-data:www-data /var/www/example.com/index.html

# 配置try_files
location / {
    try_files $uri $uri/ /index.html;
}
```

### 7.3 多个站点配置冲突

**问题**：多个站点配置互相影响

**解决方法**：

1. **使用独立的配置文件**
   ```bash
   # 每个站点使用独立文件
   /etc/nginx/sites-available/site1.com
   /etc/nginx/sites-available/site2.com
   ```

2. **检查server_name是否重复**
   ```bash
   sudo nginx -T | grep -A 5 "server_name"
   ```

## 八、最佳实践

### 8.1 配置文件组织

```
/etc/nginx/
├── nginx.conf              # 主配置文件
├── sites-available/        # 可用站点配置
│   ├── example.com
│   └── test.com
└── sites-enabled/          # 启用的站点（符号链接）
    ├── example.com -> ../sites-available/example.com
    └── test.com -> ../sites-available/test.com
```

### 8.2 日志分离

```nginx
server {
    server_name example.com;
    
    # 每个站点独立的日志
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log;
}
```

### 8.3 安全配置

```nginx
server {
    server_name example.com;
    
    # 隐藏Nginx版本
    server_tokens off;
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }
    
    # 限制请求方法
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
        return 444;
    }
}
```

## 九、下一步学习

完成本课后，你应该能够：

- ✅ 理解虚拟主机的概念和类型
- ✅ 配置基于域名的虚拟主机
- ✅ 配置基于端口的虚拟主机
- ✅ 理解server块的匹配规则
- ✅ 配置默认服务器

接下来可以学习：

1. **第4课：反向代理** - 学习如何配置反向代理和负载均衡
2. **第5课：静态资源服务** - 学习如何优化静态文件服务

## 十、总结

- 虚拟主机允许一台服务器托管多个网站
- 基于域名的虚拟主机是最常用的方式
- 使用sites-available和sites-enabled管理站点配置
- 理解server_name的匹配规则很重要
- 为每个站点配置独立的日志便于管理

掌握虚拟主机配置后，你就可以在一台服务器上托管多个网站了！
