---
title: Nginx实践：常见场景配置
date: 2026-01-12
description: 学习实际项目中的Nginx配置案例，包括前后端分离、API网关、微服务等场景
---

# Nginx实践：常见场景配置

## 一、前后端分离项目

### 1.1 基本配置

```nginx
server {
    listen 80;
    server_name example.com;
    root /var/www/frontend;
    index index.html;
    
    # 前端静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocket代理
    location /ws {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
}
```

### 1.2 带HTTPS的配置

```nginx
# HTTP重定向到HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS服务器
server {
    listen 443 ssl http2;
    server_name example.com;
    
    # SSL证书
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    root /var/www/frontend;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location /ws {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}
```

## 二、Node.js应用代理

### 2.1 单应用配置

```nginx
upstream nodejs_app {
    server 127.0.0.1:3000;
}

server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://nodejs_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 2.2 负载均衡配置

```nginx
upstream nodejs_backend {
    # 轮询（默认）
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
    
    # 或使用加权轮询
    # server 127.0.0.1:3000 weight=3;
    # server 127.0.0.1:3001 weight=2;
    # server 127.0.0.1:3002 weight=1;
    
    # 或使用IP哈希（保持会话）
    # ip_hash;
    # server 127.0.0.1:3000;
    # server 127.0.0.1:3001;
    
    # 连接复用
    keepalive 32;
}

server {
    listen 80;
    server_name api.example.com;
    
    location / {
        proxy_pass http://nodejs_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

## 三、Python应用代理（uWSGI/FastCGI）

### 3.1 uWSGI配置

```nginx
upstream uwsgi_backend {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001;
}

server {
    listen 80;
    server_name app.example.com;
    
    location / {
        include uwsgi_params;
        uwsgi_pass uwsgi_backend;
        uwsgi_param Host $host;
        uwsgi_param X-Real-IP $remote_addr;
    }
    
    # 静态文件
    location /static {
        alias /var/www/app/static;
        expires 30d;
    }
}
```

### 3.2 FastCGI配置（PHP）

```nginx
server {
    listen 80;
    server_name php.example.com;
    root /var/www/php;
    index index.php;
    
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
}
```

## 四、API网关配置

### 4.1 多服务路由

```nginx
# 用户服务
upstream user_service {
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

# 订单服务
upstream order_service {
    server 127.0.0.1:4001;
    server 127.0.0.1:4002;
}

# 支付服务
upstream payment_service {
    server 127.0.0.1:5001;
}

server {
    listen 80;
    server_name api.example.com;
    
    # 限流
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req zone=api_limit burst=20 nodelay;
    
    # 用户服务
    location /api/users {
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 订单服务
    location /api/orders {
        proxy_pass http://order_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 支付服务
    location /api/payments {
        proxy_pass http://payment_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 4.2 带认证的API网关

```nginx
# 认证服务
upstream auth_service {
    server 127.0.0.1:6001;
}

# 业务服务
upstream business_service {
    server 127.0.0.1:3001;
}

server {
    listen 80;
    server_name api.example.com;
    
    # 认证接口（不需要验证）
    location /api/auth {
        proxy_pass http://auth_service;
        proxy_set_header Host $host;
    }
    
    # 业务接口（需要验证）
    location /api/ {
        # 验证token（内部请求）
        auth_request /auth;
        auth_request_set $user $upstream_http_x_user;
        
        proxy_pass http://business_service;
        proxy_set_header Host $host;
        proxy_set_header X-User $user;
    }
    
    # 内部认证接口
    location = /auth {
        internal;
        proxy_pass http://auth_service/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
    }
}
```

## 五、文件上传下载

### 5.1 文件上传配置

```nginx
server {
    listen 80;
    server_name upload.example.com;
    
    # 增加上传大小限制
    client_max_body_size 100m;
    client_body_timeout 300s;
    
    location /upload {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # 上传超时
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # 禁用缓冲（大文件上传）
        proxy_request_buffering off;
    }
}
```

### 5.2 文件下载配置

```nginx
server {
    listen 80;
    server_name download.example.com;
    root /var/www/downloads;
    
    location /download {
        # 强制下载
        add_header Content-Disposition "attachment";
        
        # 限制下载速度
        limit_rate 1m;
        
        # 限制连接数
        limit_conn perip 2;
        
        # 断点续传
        # 默认支持
    }
}
```

## 六、WebSocket配置

### 6.1 基本WebSocket配置

```nginx
upstream websocket_backend {
    ip_hash;  # WebSocket需要保持连接
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
}

server {
    listen 80;
    server_name ws.example.com;
    
    location /ws {
        proxy_pass http://websocket_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # WebSocket超时（24小时）
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }
}
```

### 6.2 多WebSocket服务

```nginx
# 聊天服务
upstream chat_service {
    ip_hash;
    server 127.0.0.1:3001;
}

# 通知服务
upstream notification_service {
    ip_hash;
    server 127.0.0.1:3002;
}

server {
    listen 80;
    server_name ws.example.com;
    
    location /ws/chat {
        proxy_pass http://chat_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
    
    location /ws/notification {
        proxy_pass http://notification_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}
```

## 七、CDN和静态资源

### 7.1 静态资源CDN配置

```nginx
server {
    listen 80;
    server_name cdn.example.com;
    root /var/www/cdn;
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # CORS头
        add_header Access-Control-Allow-Origin "*";
    }
    
    # 图片优化
    location ~* \.(jpg|jpeg|png|gif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 7.2 回源配置

```nginx
# CDN节点配置
server {
    listen 80;
    server_name cdn.example.com;
    
    location / {
        proxy_pass http://origin.example.com;
        proxy_cache my_cache;
        proxy_cache_valid 200 1y;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        add_header X-Cache-Status $upstream_cache_status;
    }
}
```

## 八、多域名配置

### 8.1 主域名和子域名

```nginx
# 主域名
server {
    listen 80;
    server_name example.com www.example.com;
    root /var/www/main;
    # ...
}

# API子域名
server {
    listen 80;
    server_name api.example.com;
    # API配置
    # ...
}

# 管理后台子域名
server {
    listen 80;
    server_name admin.example.com;
    
    # IP白名单
    allow 192.168.1.0/24;
    deny all;
    
    # 基本认证
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    root /var/www/admin;
    # ...
}
```

## 九、完整生产环境配置示例

### 9.1 前后端分离 + API + WebSocket

```nginx
# 上游服务
upstream api_backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    keepalive 32;
}

upstream ws_backend {
    ip_hash;
    server 127.0.0.1:4000;
    server 127.0.0.1:4001;
}

# HTTP重定向
server {
    listen 80;
    server_name example.com www.example.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS主服务器
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;
    
    # SSL配置
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # 限流
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req zone=api_limit burst=20 nodelay;
    
    root /var/www/frontend;
    index index.html;
    
    # 前端静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # API代理
    location /api {
        proxy_pass http://api_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocket代理
    location /ws {
        proxy_pass http://ws_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
    }
}
```

## 十、调试和测试

### 10.1 测试配置

```bash
# 测试配置文件
sudo nginx -t

# 查看完整配置
sudo nginx -T

# 重载配置
sudo nginx -s reload
```

### 10.2 查看日志

```bash
# 实时查看访问日志
sudo tail -f /var/log/nginx/access.log

# 实时查看错误日志
sudo tail -f /var/log/nginx/error.log

# 查看特定域名的日志
sudo tail -f /var/log/nginx/example.com.access.log
```

### 10.3 性能测试

```bash
# 使用ab测试
ab -n 1000 -c 10 https://example.com/

# 使用wrk测试
wrk -t12 -c400 -d30s https://example.com/
```

## 十一、常见问题解决

### 11.1 502 Bad Gateway

```nginx
# 检查后端服务是否运行
# 增加超时时间
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;
```

### 11.2 413 Request Entity Too Large

```nginx
# 增加请求体大小限制
client_max_body_size 100m;
```

### 11.3 WebSocket连接断开

```nginx
# 增加WebSocket超时时间
proxy_read_timeout 86400;
proxy_send_timeout 86400;
```

## 十二、下一步学习

完成本课后，你应该能够：

- ✅ 配置前后端分离项目
- ✅ 配置各种后端应用代理
- ✅ 配置API网关
- ✅ 配置文件上传下载
- ✅ 配置WebSocket服务
- ✅ 解决实际项目中的配置问题

## 十三、总结

- 实际项目配置需要根据具体需求调整
- 前后端分离项目需要配置静态文件和API代理
- API网关可以统一管理多个微服务
- WebSocket需要特殊的配置
- 生产环境需要配置HTTPS、限流、安全头等
- 定期测试和监控配置效果

掌握常见场景配置后，你就可以应对各种实际项目需求了！
